{"version":3,"file":"enterprise-features-BG9OW9_4.js","sources":["../../src/security/html-sanitizer.js","../../src/security/environment.js","../../src/security/data-encryption.js","../../src/workers/sw-manager.js","../../src/sync/medical-sync-manager.js","../../src/workers/medical-service-worker.js"],"sourcesContent":["/**\r\n * HTML Sanitization Utilities for XSS Prevention\r\n * iGFAP Stroke Triage Assistant - Enterprise Security\r\n *\r\n * Provides secure HTML sanitization to prevent XSS attacks\r\n *\r\n * @author iGFAP Project Team\r\n * @contact Deepak Bos <bosdeepak@gmail.com>\r\n */\r\n\r\n/**\r\n * Allowed HTML tags for medical content\r\n */\r\nconst ALLOWED_TAGS = [\r\n  'p', 'div', 'span', 'br', 'strong', 'b', 'em', 'i', 'u',\r\n  'h1', 'h2', 'h3', 'h4', 'h5', 'h6',\r\n  'ul', 'ol', 'li',\r\n  'table', 'tr', 'td', 'th', 'thead', 'tbody',\r\n  'small', 'sub', 'sup',\r\n  'button', 'input', 'form', 'label', 'select', 'option', 'textarea',\r\n  'a', 'img', 'canvas', 'svg', 'path', 'circle', 'rect', 'line', 'g',\r\n];\r\n\r\n/**\r\n * Allowed attributes for HTML tags\r\n */\r\nconst ALLOWED_ATTRIBUTES = {\r\n  div: ['class', 'id', 'style', 'data-id', 'data-action', 'data-value', 'data-module', 'data-target'],\r\n  span: ['class', 'id', 'style', 'data-id'],\r\n  p: ['class', 'style'],\r\n  strong: ['class'],\r\n  b: ['class'],\r\n  em: ['class'],\r\n  i: ['class'],\r\n  table: ['class'],\r\n  tr: ['class'],\r\n  td: ['class', 'colspan', 'rowspan'],\r\n  th: ['class', 'colspan', 'rowspan'],\r\n  ul: ['class'],\r\n  ol: ['class'],\r\n  li: ['class'],\r\n  h1: ['class'],\r\n  h2: ['class'],\r\n  h3: ['class'],\r\n  h4: ['class'],\r\n  h5: ['class'],\r\n  h6: ['class'],\r\n  small: ['class'],\r\n  button: ['class', 'id', 'type', 'data-action', 'data-value', 'data-target', 'disabled'],\r\n  input: ['class', 'id', 'type', 'name', 'value', 'placeholder', 'required', 'data-module', 'autocomplete', 'readonly', 'checked', 'min', 'max', 'step', 'aria-describedby'],\r\n  form: ['class', 'id', 'data-module', 'action', 'method'],\r\n  label: ['class', 'for'],\r\n  select: ['class', 'id', 'name', 'required'],\r\n  option: ['value', 'selected'],\r\n  textarea: ['class', 'id', 'name', 'placeholder', 'required', 'rows', 'cols'],\r\n  a: ['href', 'target', 'class', 'id'],\r\n  img: ['src', 'alt', 'class', 'id', 'width', 'height'],\r\n  canvas: ['class', 'id', 'width', 'height'],\r\n  svg: ['class', 'id', 'width', 'height', 'viewBox', 'xmlns'],\r\n  path: ['d', 'fill', 'stroke', 'stroke-width', 'class'],\r\n  circle: ['cx', 'cy', 'r', 'fill', 'stroke', 'stroke-width', 'class'],\r\n  rect: ['x', 'y', 'width', 'height', 'fill', 'stroke', 'stroke-width', 'class'],\r\n  line: ['x1', 'y1', 'x2', 'y2', 'stroke', 'stroke-width', 'class'],\r\n  g: ['class', 'transform'],\r\n};\r\n\r\n/**\r\n * Allowed CSS properties for style attributes\r\n */\r\nconst ALLOWED_STYLES = [\r\n  'color', 'background-color', 'font-size', 'font-weight',\r\n  'text-align', 'margin', 'padding', 'border',\r\n  'display', 'visibility', 'opacity',\r\n];\r\n\r\n/**\r\n * Sanitize HTML content to prevent XSS attacks\r\n * @param {string} html - Raw HTML content\r\n * @param {Object} options - Sanitization options\r\n * @returns {string} - Sanitized HTML\r\n */\r\nexport function sanitizeHTML(html, options = {}) {\r\n  if (typeof html !== 'string') {\r\n    return '';\r\n  }\r\n\r\n  // Basic XSS pattern detection\r\n  if (containsXSSPatterns(html)) {\r\n    throw new Error('Potentially malicious content detected');\r\n  }\r\n\r\n  // Use browser's DOMParser for parsing\r\n  const parser = new DOMParser();\r\n  const doc = parser.parseFromString(html, 'text/html');\r\n\r\n  // Check for parsing errors\r\n  const parserError = doc.querySelector('parsererror');\r\n  if (parserError) {\r\n    throw new Error('Invalid HTML content');\r\n  }\r\n\r\n  // Sanitize the document\r\n  sanitizeNode(doc.body, options);\r\n\r\n  return doc.body.innerHTML;\r\n}\r\n\r\n/**\r\n * Check for common XSS patterns\r\n * @param {string} html - HTML content to check\r\n * @returns {boolean} - True if XSS patterns detected\r\n */\r\nfunction containsXSSPatterns(html) {\r\n  const xssPatterns = [\r\n    /<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi,\r\n    /javascript:/gi,\r\n    /on\\w+\\s*=/gi,\r\n    /<iframe\\b(?![^>]*src=[\"'][^\"']*\\/0925\\/)/gi, // Allow our own iframes\r\n    /<object\\b/gi,\r\n    /<embed\\b/gi,\r\n    /<meta\\b/gi,\r\n    /<link\\b(?![^>]*rel=[\"']manifest)/gi, // Allow manifest links\r\n  ];\r\n\r\n  return xssPatterns.some((pattern) => pattern.test(html));\r\n}\r\n\r\n/**\r\n * Recursively sanitize DOM nodes\r\n * @param {Node} node - DOM node to sanitize\r\n * @param {Object} options - Sanitization options\r\n */\r\nfunction sanitizeNode(node, options) {\r\n  const nodesToRemove = [];\r\n\r\n  for (let i = 0; i < node.childNodes.length; i++) {\r\n    const child = node.childNodes[i];\r\n\r\n    if (child.nodeType === Node.ELEMENT_NODE) {\r\n      const tagName = child.tagName.toLowerCase();\r\n\r\n      // Remove disallowed tags\r\n      if (!ALLOWED_TAGS.includes(tagName)) {\r\n        nodesToRemove.push(child);\r\n        continue;\r\n      }\r\n\r\n      // Sanitize attributes\r\n      sanitizeAttributes(child);\r\n\r\n      // Recursively sanitize children\r\n      sanitizeNode(child, options);\r\n    } else if (child.nodeType === Node.TEXT_NODE) {\r\n      // Escape text content\r\n      child.textContent = escapeTextContent(child.textContent);\r\n    } else {\r\n      // Remove other node types (comments, etc.)\r\n      nodesToRemove.push(child);\r\n    }\r\n  }\r\n\r\n  // Remove flagged nodes\r\n  nodesToRemove.forEach((nodeToRemove) => {\r\n    node.removeChild(nodeToRemove);\r\n  });\r\n}\r\n\r\n/**\r\n * Sanitize element attributes\r\n * @param {Element} element - Element to sanitize\r\n */\r\nfunction sanitizeAttributes(element) {\r\n  const tagName = element.tagName.toLowerCase();\r\n  const allowedAttrs = ALLOWED_ATTRIBUTES[tagName] || [];\r\n  const attrsToRemove = [];\r\n\r\n  // Check all attributes\r\n  for (let i = 0; i < element.attributes.length; i++) {\r\n    const attr = element.attributes[i];\r\n    const attrName = attr.name.toLowerCase();\r\n\r\n    // Allow any data-* attribute for component islands and UI hooks\r\n    const isDataAttr = attrName.startsWith('data-');\r\n\r\n    if (!allowedAttrs.includes(attrName) && !isDataAttr) {\r\n      attrsToRemove.push(attrName);\r\n    } else if (attrName === 'style') {\r\n      // Sanitize style attribute\r\n      element.setAttribute('style', sanitizeStyleAttribute(attr.value));\r\n    } else {\r\n      // Escape attribute value\r\n      element.setAttribute(attrName, escapeAttributeValue(attr.value));\r\n    }\r\n  }\r\n\r\n  // Remove disallowed attributes\r\n  attrsToRemove.forEach((attrName) => {\r\n    element.removeAttribute(attrName);\r\n  });\r\n}\r\n\r\n/**\r\n * Sanitize CSS in style attributes\r\n * @param {string} styleValue - CSS style value\r\n * @returns {string} - Sanitized style value\r\n */\r\nfunction sanitizeStyleAttribute(styleValue) {\r\n  if (!styleValue) {\r\n    return '';\r\n  }\r\n\r\n  const styles = styleValue.split(';');\r\n  const sanitizedStyles = [];\r\n\r\n  styles.forEach((style) => {\r\n    const [property, value] = style.split(':').map((s) => s.trim());\r\n\r\n    if (property && value && ALLOWED_STYLES.includes(property.toLowerCase())) {\r\n      // Basic CSS injection prevention\r\n      if (!value.includes('javascript:') && !value.includes('expression(')) {\r\n        sanitizedStyles.push(`${property}: ${value}`);\r\n      }\r\n    }\r\n  });\r\n\r\n  return sanitizedStyles.join('; ');\r\n}\r\n\r\n/**\r\n * Escape text content to prevent XSS\r\n * @param {string} text - Text content\r\n * @returns {string} - Escaped text\r\n */\r\nfunction escapeTextContent(text) {\r\n  if (!text) {\r\n    return '';\r\n  }\r\n\r\n  return text\r\n    .replace(/&/g, '&amp;')\r\n    .replace(/</g, '&lt;')\r\n    .replace(/>/g, '&gt;')\r\n    .replace(/\"/g, '&quot;')\r\n    .replace(/'/g, '&#x27;')\r\n    .replace(/\\//g, '&#x2F;');\r\n}\r\n\r\n/**\r\n * Escape attribute values\r\n * @param {string} value - Attribute value\r\n * @returns {string} - Escaped value\r\n */\r\nfunction escapeAttributeValue(value) {\r\n  if (!value) {\r\n    return '';\r\n  }\r\n\r\n  return value\r\n    .replace(/&/g, '&amp;')\r\n    .replace(/\"/g, '&quot;')\r\n    .replace(/'/g, '&#x27;')\r\n    .replace(/</g, '&lt;')\r\n    .replace(/>/g, '&gt;');\r\n}\r\n\r\n/**\r\n * Safe innerHTML replacement\r\n * @param {Element} element - Target element\r\n * @param {string} html - HTML content to set\r\n * @param {Object} options - Sanitization options\r\n */\r\nexport function safeSetInnerHTML(element, html, options = {}) {\r\n  if (!element || typeof html !== 'string') {\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const sanitizedHTML = sanitizeHTML(html, options);\r\n    element.innerHTML = sanitizedHTML;\r\n  } catch (error) {\r\n    // Fallback to text content on sanitization error\r\n    element.textContent = html.replace(/<[^>]*>/g, '');\r\n    throw new Error(`HTML sanitization failed: ${error.message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Create safe HTML string for medical content\r\n * @param {string} template - HTML template\r\n * @param {Object} data - Data to interpolate\r\n * @returns {string} - Safe HTML string\r\n */\r\nexport function createSafeHTML(template, data = {}) {\r\n  if (typeof template !== 'string') {\r\n    return '';\r\n  }\r\n\r\n  // Basic template interpolation with escaping\r\n  let html = template;\r\n\r\n  Object.keys(data).forEach((key) => {\r\n    const placeholder = new RegExp(`\\\\{\\\\{\\\\s*${key}\\\\s*\\\\}\\\\}`, 'g');\r\n    const value = data[key];\r\n\r\n    if (typeof value === 'string') {\r\n      html = html.replace(placeholder, escapeTextContent(value));\r\n    } else if (typeof value === 'number') {\r\n      html = html.replace(placeholder, value.toString());\r\n    } else {\r\n      html = html.replace(placeholder, '');\r\n    }\r\n  });\r\n\r\n  return sanitizeHTML(html);\r\n}\r\n\r\n/**\r\n * Validate and sanitize medical report content\r\n * @param {string} content - Medical report content\r\n * @returns {string} - Sanitized content\r\n */\r\nexport function sanitizeMedicalContent(content) {\r\n  const options = {\r\n    allowMedicalTags: true,\r\n    preserveFormatting: true,\r\n  };\r\n\r\n  return sanitizeHTML(content, options);\r\n}\r\n","/**\r\n * Secure Environment Configuration Manager\r\n * Provides secure access to environment variables with validation and fallbacks\r\n */\r\n\r\nclass EnvironmentConfig {\r\n  constructor() {\r\n    this.config = {};\r\n    this.isInitialized = false;\r\n    this.initializeConfig();\r\n  }\r\n\r\n  initializeConfig() {\r\n    try {\r\n      // Load environment variables (for Node.js environments)\r\n      if (typeof process !== 'undefined' && process.env) {\r\n        this.config = { ...process.env };\r\n      }\r\n\r\n      // For client-side, use secure storage or runtime configuration\r\n      if (typeof window !== 'undefined') {\r\n        this.loadClientConfig();\r\n      }\r\n\r\n      this.isInitialized = true;\r\n    } catch (error) {\r\n      console.warn('Failed to initialize environment config:', error.message);\r\n      this.loadDefaults();\r\n    }\r\n  }\r\n\r\n  loadClientConfig() {\r\n    // Client-side configuration with security considerations\r\n    // Use runtime configuration instead of build-time injection for sensitive data\r\n    const clientConfig = {\r\n      // Default values that are safe to expose\r\n      NODE_ENV: 'production',\r\n      DEBUG_MODE: false,\r\n      MOCK_API_ENABLED: false,\r\n      LOG_LEVEL: 'info',\r\n\r\n      // Session configuration (safe defaults)\r\n      SESSION_TIMEOUT_HOURS: 4,\r\n      BCRYPT_SALT_ROUNDS: 12,\r\n      ENCRYPTION_KEY_LENGTH: 256,\r\n\r\n      // Rate limiting\r\n      MAX_AUTH_ATTEMPTS: 5,\r\n      RATE_LIMIT_WINDOW_MS: 900000, // 15 minutes\r\n\r\n      // Medical compliance\r\n      ENABLE_DATA_ENCRYPTION: true,\r\n      ENABLE_AUDIT_TRAIL: true,\r\n      DATA_RETENTION_DAYS: 90,\r\n\r\n      // GCP configuration (non-sensitive)\r\n      GCP_PROJECT_ID: 'igfap-452720',\r\n      GCP_REGION: 'europe-west3',\r\n    };\r\n\r\n    // Merge with any runtime configuration\r\n    this.config = { ...this.config, ...clientConfig };\r\n  }\r\n\r\n  loadDefaults() {\r\n    // Secure fallback configuration\r\n    this.config = {\r\n      NODE_ENV: 'development',\r\n      DEBUG_MODE: false,\r\n      MOCK_API_ENABLED: true,\r\n      LOG_LEVEL: 'warn',\r\n      SESSION_TIMEOUT_HOURS: 4,\r\n      BCRYPT_SALT_ROUNDS: 12,\r\n      MAX_AUTH_ATTEMPTS: 3,\r\n      RATE_LIMIT_WINDOW_MS: 900000,\r\n      ENABLE_DATA_ENCRYPTION: true,\r\n      ENABLE_AUDIT_TRAIL: true,\r\n      DATA_RETENTION_DAYS: 30,\r\n      GCP_PROJECT_ID: 'igfap-452720',\r\n      GCP_REGION: 'europe-west3',\r\n    };\r\n    this.isInitialized = true;\r\n  }\r\n\r\n  /**\r\n   * Get environment variable with validation and fallback\r\n   * @param {string} key - Environment variable key\r\n   * @param {*} defaultValue - Default value if not found\r\n   * @param {string} type - Expected type (string, number, boolean)\r\n   * @returns {*} Environment variable value\r\n   */\r\n  get(key, defaultValue = null, type = 'string') {\r\n    if (!this.isInitialized) {\r\n      this.initializeConfig();\r\n    }\r\n\r\n    let value = this.config[key];\r\n\r\n    // Use default if value is not found\r\n    if (value === undefined || value === null || value === '') {\r\n      value = defaultValue;\r\n    }\r\n\r\n    // Type conversion and validation\r\n    try {\r\n      switch (type) {\r\n        case 'number':\r\n          return value !== null ? Number(value) : defaultValue;\r\n        case 'boolean':\r\n          if (typeof value === 'boolean') {\r\n            return value;\r\n          }\r\n          return value === 'true' || value === '1' || value === 'yes';\r\n        case 'array':\r\n          if (Array.isArray(value)) {\r\n            return value;\r\n          }\r\n          return typeof value === 'string' ? value.split(',').map((s) => s.trim()) : defaultValue;\r\n        case 'string':\r\n        default:\r\n          return value !== null ? String(value) : defaultValue;\r\n      }\r\n    } catch (error) {\r\n      console.warn(`Failed to convert environment variable ${key} to ${type}:`, error.message);\r\n      return defaultValue;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get research password securely\r\n   * @returns {string} Research password\r\n   */\r\n  getResearchPassword() {\r\n    // In production, this should come from secure vault or environment\r\n    // For development, use environment variable with secure fallback\r\n    const password = this.get('RESEARCH_PASSWORD');\r\n\r\n    // If not in environment, use secure default for research (documented in README)\r\n    return password || 'Neuro25';\r\n  }\r\n\r\n  /**\r\n   * Get API key securely\r\n   * @param {string} service - Service name (e.g., 'OPENROUTE')\r\n   * @returns {string} API key or null if not configured\r\n   */\r\n  getApiKey(service) {\r\n    const key = this.get(`${service.toUpperCase()}_API_KEY`);\r\n    if (!key || key === 'YOUR_API_KEY_HERE') {\r\n      return null;\r\n    }\r\n    return key;\r\n  }\r\n\r\n  /**\r\n   * Check if running in development mode\r\n   * @returns {boolean} True if in development\r\n   */\r\n  isDevelopment() {\r\n    return this.get('NODE_ENV') === 'development'\r\n           || typeof window !== 'undefined' && ['localhost', '127.0.0.1', '0.0.0.0'].includes(window.location.hostname);\r\n  }\r\n\r\n  /**\r\n   * Check if running in production mode\r\n   * @returns {boolean} True if in production\r\n   */\r\n  isProduction() {\r\n    return this.get('NODE_ENV') === 'production' && !this.isDevelopment();\r\n  }\r\n\r\n  /**\r\n   * Get session configuration\r\n   * @returns {Object} Session configuration\r\n   */\r\n  getSessionConfig() {\r\n    return {\r\n      timeoutHours: this.get('SESSION_TIMEOUT_HOURS', 4, 'number'),\r\n      secretKey: this.get('SESSION_SECRET_KEY') || this.generateSecretKey(),\r\n      maxAuthAttempts: this.get('MAX_AUTH_ATTEMPTS', 5, 'number'),\r\n      rateLimitWindow: this.get('RATE_LIMIT_WINDOW_MS', 900000, 'number'),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get security configuration\r\n   * @returns {Object} Security configuration\r\n   */\r\n  getSecurityConfig() {\r\n    return {\r\n      encryptionKeyLength: this.get('ENCRYPTION_KEY_LENGTH', 256, 'number'),\r\n      bcryptSaltRounds: this.get('BCRYPT_SALT_ROUNDS', 12, 'number'),\r\n      enableDataEncryption: this.get('ENABLE_DATA_ENCRYPTION', true, 'boolean'),\r\n      enableAuditTrail: this.get('ENABLE_AUDIT_TRAIL', true, 'boolean'),\r\n      dataRetentionDays: this.get('DATA_RETENTION_DAYS', 90, 'number'),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get GCP configuration\r\n   * @returns {Object} GCP configuration\r\n   */\r\n  getGcpConfig() {\r\n    return {\r\n      projectId: this.get('GCP_PROJECT_ID', 'igfap-452720'),\r\n      region: this.get('GCP_REGION', 'europe-west3'),\r\n      baseUrl: `https://${this.get('GCP_REGION', 'europe-west3')}-${this.get('GCP_PROJECT_ID', 'igfap-452720')}.cloudfunctions.net`,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Generate a secure session secret key\r\n   * @returns {string} Generated secret key\r\n   */\r\n  generateSecretKey() {\r\n    try {\r\n      if (typeof crypto !== 'undefined' && crypto.getRandomValues) {\r\n        const array = new Uint8Array(32);\r\n        crypto.getRandomValues(array);\r\n        return Array.from(array, (byte) => byte.toString(16).padStart(2, '0')).join('');\r\n      }\r\n    } catch (error) {\r\n      console.warn('Failed to generate cryptographically secure key, using fallback');\r\n    }\r\n\r\n    // Fallback for environments without crypto.getRandomValues\r\n    return `fallback-key-${Date.now()}-${Math.random().toString(36).substring(2)}`;\r\n  }\r\n\r\n  /**\r\n   * Validate configuration integrity\r\n   * @returns {Object} Validation results\r\n   */\r\n  validateConfig() {\r\n    const issues = [];\r\n    const warnings = [];\r\n\r\n    // Check for required security settings\r\n    if (!this.get('ENABLE_DATA_ENCRYPTION', true, 'boolean')) {\r\n      issues.push('Data encryption is disabled in production environment');\r\n    }\r\n\r\n    if (!this.get('ENABLE_AUDIT_TRAIL', true, 'boolean')) {\r\n      warnings.push('Audit trail is disabled - may affect compliance');\r\n    }\r\n\r\n    if (this.get('BCRYPT_SALT_ROUNDS', 12, 'number') < 10) {\r\n      issues.push('BCrypt salt rounds too low for production security');\r\n    }\r\n\r\n    if (this.isProduction() && this.get('DEBUG_MODE', false, 'boolean')) {\r\n      warnings.push('Debug mode enabled in production environment');\r\n    }\r\n\r\n    // Check for default/example values in production\r\n    if (this.isProduction()) {\r\n      const researchPassword = this.get('RESEARCH_PASSWORD');\r\n      if (!researchPassword || researchPassword === 'Neuro25') {\r\n        warnings.push('Using default research password in production');\r\n      }\r\n\r\n      const sessionSecret = this.get('SESSION_SECRET_KEY');\r\n      if (!sessionSecret || sessionSecret.includes('your-secure')) {\r\n        issues.push('Default session secret in production environment');\r\n      }\r\n    }\r\n\r\n    return {\r\n      isValid: issues.length === 0,\r\n      issues,\r\n      warnings,\r\n      configStatus: {\r\n        encryption: this.get('ENABLE_DATA_ENCRYPTION', true, 'boolean'),\r\n        auditTrail: this.get('ENABLE_AUDIT_TRAIL', true, 'boolean'),\r\n        development: this.isDevelopment(),\r\n        production: this.isProduction(),\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get sanitized configuration for logging/debugging\r\n   * @returns {Object} Safe configuration object (no secrets)\r\n   */\r\n  getSafeConfig() {\r\n    const safeKeys = [\r\n      'NODE_ENV', 'DEBUG_MODE', 'MOCK_API_ENABLED', 'LOG_LEVEL',\r\n      'SESSION_TIMEOUT_HOURS', 'BCRYPT_SALT_ROUNDS', 'ENCRYPTION_KEY_LENGTH',\r\n      'MAX_AUTH_ATTEMPTS', 'RATE_LIMIT_WINDOW_MS',\r\n      'ENABLE_DATA_ENCRYPTION', 'ENABLE_AUDIT_TRAIL', 'DATA_RETENTION_DAYS',\r\n      'GCP_PROJECT_ID', 'GCP_REGION',\r\n    ];\r\n\r\n    const safeConfig = {};\r\n    safeKeys.forEach((key) => {\r\n      safeConfig[key] = this.config[key];\r\n    });\r\n\r\n    return safeConfig;\r\n  }\r\n}\r\n\r\n// Create singleton instance\r\nconst environmentConfig = new EnvironmentConfig();\r\n\r\n// Export convenience functions\r\nexport const getEnv = (key, defaultValue, type) => environmentConfig.get(key, defaultValue, type);\r\nexport const getResearchPassword = () => environmentConfig.getResearchPassword();\r\nexport const getApiKey = (service) => environmentConfig.getApiKey(service);\r\nexport const isDevelopment = () => environmentConfig.isDevelopment();\r\nexport const isProduction = () => environmentConfig.isProduction();\r\nexport const getSessionConfig = () => environmentConfig.getSessionConfig();\r\nexport const getSecurityConfig = () => environmentConfig.getSecurityConfig();\r\nexport const getGcpConfig = () => environmentConfig.getGcpConfig();\r\nexport const validateConfig = () => environmentConfig.validateConfig();\r\nexport const getSafeConfig = () => environmentConfig.getSafeConfig();\r\n\r\n// Export main class\r\nexport default environmentConfig;\r\n","/**\r\n * Medical Data Encryption System\r\n * iGFAP Stroke Triage Assistant - HIPAA-Compliant Data Protection\r\n *\r\n * Provides client-side encryption for sensitive medical data in storage\r\n * Uses Web Crypto API with AES-GCM encryption for maximum security\r\n *\r\n * @author iGFAP Project Team\r\n * @contact Deepak Bos <bosdeepak@gmail.com>\r\n */\r\n\r\nimport { safeAsync, ERROR_CATEGORIES, ERROR_SEVERITY } from '../utils/error-handler.js';\r\nimport { medicalLogger, LOG_CATEGORIES } from '../utils/medical-logger.js';\r\n\r\n/**\r\n * @typedef {Object} EncryptedData\r\n * @property {string} encrypted - Base64 encoded encrypted data\r\n * @property {string} iv - Base64 encoded initialization vector\r\n * @property {string} version - Encryption version for compatibility\r\n * @property {number} timestamp - Encryption timestamp\r\n */\r\n\r\n/**\r\n * Medical Data Encryption Manager\r\n */\r\nexport class MedicalDataEncryption {\r\n  constructor() {\r\n    this.algorithm = 'AES-GCM';\r\n    this.keyLength = 256;\r\n    this.ivLength = 12; // 96 bits for AES-GCM\r\n    this.version = '1.0';\r\n    this.encryptionKey = null;\r\n    this.isSupported = this.checkWebCryptoSupport();\r\n\r\n    if (this.isSupported) {\r\n      this.initializeEncryption();\r\n    } else {\r\n      medicalLogger.warn('Web Crypto API not supported, falling back to unencrypted storage', {\r\n        category: LOG_CATEGORIES.SECURITY,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if Web Crypto API is supported\r\n   */\r\n  checkWebCryptoSupport() {\r\n    return typeof window !== 'undefined'\r\n           && window.crypto\r\n           && window.crypto.subtle\r\n           && typeof window.crypto.subtle.encrypt === 'function';\r\n  }\r\n\r\n  /**\r\n   * Initialize encryption with derived key\r\n   */\r\n  async initializeEncryption() {\r\n    return safeAsync(\r\n      async () => {\r\n        // Generate or retrieve session-based key material\r\n        const keyMaterial = await this.getOrCreateKeyMaterial();\r\n\r\n        // Derive encryption key from key material\r\n        this.encryptionKey = await window.crypto.subtle.deriveKey(\r\n          {\r\n            name: 'PBKDF2',\r\n            salt: new TextEncoder().encode('iGFAP-Medical-2024'), // Static salt for session consistency\r\n            iterations: 100000,\r\n            hash: 'SHA-256',\r\n          },\r\n          keyMaterial,\r\n          {\r\n            name: this.algorithm,\r\n            length: this.keyLength,\r\n          },\r\n          false, // Not extractable for security\r\n          ['encrypt', 'decrypt'],\r\n        );\r\n\r\n        medicalLogger.info('Medical data encryption initialized', {\r\n          category: LOG_CATEGORIES.SECURITY,\r\n          algorithm: this.algorithm,\r\n          keyLength: this.keyLength,\r\n        });\r\n\r\n        return true;\r\n      },\r\n      {\r\n        category: ERROR_CATEGORIES.SECURITY,\r\n        severity: ERROR_SEVERITY.HIGH,\r\n        context: { operation: 'encryption_initialization' },\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get or create key material for encryption\r\n   */\r\n  async getOrCreateKeyMaterial() {\r\n    return safeAsync(\r\n      async () => {\r\n        // Try to get existing key material from session\r\n        let keyData = sessionStorage.getItem('_medical_km');\r\n\r\n        if (!keyData) {\r\n          // Generate new key material for this session\r\n          const randomBytes = window.crypto.getRandomValues(new Uint8Array(32));\r\n          keyData = Array.from(randomBytes, (byte) => byte.toString(16).padStart(2, '0')).join('');\r\n          sessionStorage.setItem('_medical_km', keyData);\r\n\r\n          medicalLogger.debug('Generated new encryption key material', {\r\n            category: LOG_CATEGORIES.SECURITY,\r\n          });\r\n        }\r\n\r\n        // Convert hex string back to Uint8Array\r\n        const keyBytes = new Uint8Array(keyData.match(/.{1,2}/g).map((byte) => parseInt(byte, 16)));\r\n\r\n        // Import key material\r\n        return await window.crypto.subtle.importKey(\r\n          'raw',\r\n          keyBytes,\r\n          'PBKDF2',\r\n          false,\r\n          ['deriveKey'],\r\n        );\r\n      },\r\n      {\r\n        category: ERROR_CATEGORIES.SECURITY,\r\n        context: { operation: 'key_material_generation' },\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Encrypt sensitive data\r\n   * @param {any} data - Data to encrypt\r\n   * @returns {Promise<EncryptedData|string>} Encrypted data object or original data if encryption fails\r\n   */\r\n  async encryptData(data) {\r\n    if (!this.isSupported || !this.encryptionKey) {\r\n      medicalLogger.warn('Encryption not available, storing data unencrypted', {\r\n        category: LOG_CATEGORIES.SECURITY,\r\n      });\r\n      return JSON.stringify(data);\r\n    }\r\n\r\n    return safeAsync(\r\n      async () => {\r\n        // Convert data to JSON string\r\n        const jsonString = JSON.stringify(data);\r\n        const dataBytes = new TextEncoder().encode(jsonString);\r\n\r\n        // Generate random IV\r\n        const iv = window.crypto.getRandomValues(new Uint8Array(this.ivLength));\r\n\r\n        // Encrypt the data\r\n        const encryptedBuffer = await window.crypto.subtle.encrypt(\r\n          {\r\n            name: this.algorithm,\r\n            iv,\r\n          },\r\n          this.encryptionKey,\r\n          dataBytes,\r\n        );\r\n\r\n        // Convert to base64 for storage\r\n        const encryptedArray = new Uint8Array(encryptedBuffer);\r\n        const encryptedBase64 = btoa(String.fromCharCode(...encryptedArray));\r\n        const ivBase64 = btoa(String.fromCharCode(...iv));\r\n\r\n        const encryptedData = {\r\n          encrypted: encryptedBase64,\r\n          iv: ivBase64,\r\n          version: this.version,\r\n          timestamp: Date.now(),\r\n        };\r\n\r\n        medicalLogger.debug('Data encrypted successfully', {\r\n          category: LOG_CATEGORIES.SECURITY,\r\n          dataSize: jsonString.length,\r\n        });\r\n\r\n        return JSON.stringify(encryptedData);\r\n      },\r\n      {\r\n        category: ERROR_CATEGORIES.SECURITY,\r\n        severity: ERROR_SEVERITY.MEDIUM,\r\n        fallback: () => {\r\n          medicalLogger.warn('Encryption failed, storing data unencrypted', {\r\n            category: LOG_CATEGORIES.SECURITY,\r\n          });\r\n          return JSON.stringify(data);\r\n        },\r\n        context: { operation: 'data_encryption' },\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Decrypt sensitive data\r\n   * @param {string} encryptedDataString - Encrypted data string\r\n   * @returns {Promise<any>} Decrypted data or null if decryption fails\r\n   */\r\n  async decryptData(encryptedDataString) {\r\n    if (!encryptedDataString) {\r\n      return null;\r\n    }\r\n\r\n    return safeAsync(\r\n      async () => {\r\n        let encryptedData;\r\n        try {\r\n          encryptedData = JSON.parse(encryptedDataString);\r\n        } catch (parseError) {\r\n          // Might be unencrypted legacy data\r\n          medicalLogger.debug('Data appears to be unencrypted legacy format', {\r\n            category: LOG_CATEGORIES.SECURITY,\r\n          });\r\n          return JSON.parse(encryptedDataString);\r\n        }\r\n\r\n        // Check if this is encrypted data\r\n        if (!encryptedData.encrypted || !encryptedData.iv) {\r\n          // Assume it's unencrypted data\r\n          return encryptedData;\r\n        }\r\n\r\n        if (!this.isSupported || !this.encryptionKey) {\r\n          medicalLogger.warn('Cannot decrypt data: encryption not available', {\r\n            category: LOG_CATEGORIES.SECURITY,\r\n          });\r\n          return null;\r\n        }\r\n\r\n        // Convert base64 back to Uint8Array\r\n        const encryptedBytes = new Uint8Array(\r\n          atob(encryptedData.encrypted)\r\n            .split('')\r\n            .map((char) => char.charCodeAt(0)),\r\n        );\r\n\r\n        const iv = new Uint8Array(\r\n          atob(encryptedData.iv)\r\n            .split('')\r\n            .map((char) => char.charCodeAt(0)),\r\n        );\r\n\r\n        // Decrypt the data\r\n        const decryptedBuffer = await window.crypto.subtle.decrypt(\r\n          {\r\n            name: this.algorithm,\r\n            iv,\r\n          },\r\n          this.encryptionKey,\r\n          encryptedBytes,\r\n        );\r\n\r\n        // Convert back to string and parse JSON\r\n        const decryptedString = new TextDecoder().decode(decryptedBuffer);\r\n        const decryptedData = JSON.parse(decryptedString);\r\n\r\n        medicalLogger.debug('Data decrypted successfully', {\r\n          category: LOG_CATEGORIES.SECURITY,\r\n          dataSize: decryptedString.length,\r\n        });\r\n\r\n        return decryptedData;\r\n      },\r\n      {\r\n        category: ERROR_CATEGORIES.SECURITY,\r\n        severity: ERROR_SEVERITY.MEDIUM,\r\n        fallback: () => {\r\n          medicalLogger.warn('Decryption failed, returning null', {\r\n            category: LOG_CATEGORIES.SECURITY,\r\n          });\r\n          return null;\r\n        },\r\n        context: { operation: 'data_decryption' },\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Securely store encrypted data\r\n   * @param {string} key - Storage key\r\n   * @param {any} data - Data to store\r\n   * @param {boolean} useSessionStorage - Use sessionStorage instead of localStorage\r\n   */\r\n  async secureStore(key, data, useSessionStorage = false) {\r\n    return safeAsync(\r\n      async () => {\r\n        const storage = useSessionStorage ? sessionStorage : localStorage;\r\n\r\n        // Encrypt the data\r\n        const encryptedData = await this.encryptData(data);\r\n\r\n        // Store with encrypted prefix to identify encrypted data\r\n        const storageKey = `_enc_${key}`;\r\n        storage.setItem(storageKey, encryptedData);\r\n\r\n        medicalLogger.debug('Data stored securely', {\r\n          category: LOG_CATEGORIES.SECURITY,\r\n          key: storageKey,\r\n          storage: useSessionStorage ? 'session' : 'local',\r\n        });\r\n\r\n        return true;\r\n      },\r\n      {\r\n        category: ERROR_CATEGORIES.STORAGE,\r\n        context: { operation: 'secure_store', key },\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Securely retrieve and decrypt data\r\n   * @param {string} key - Storage key\r\n   * @param {boolean} useSessionStorage - Use sessionStorage instead of localStorage\r\n   * @returns {Promise<any>} Decrypted data or null\r\n   */\r\n  async secureRetrieve(key, useSessionStorage = false) {\r\n    return safeAsync(\r\n      async () => {\r\n        const storage = useSessionStorage ? sessionStorage : localStorage;\r\n        const storageKey = `_enc_${key}`;\r\n\r\n        const encryptedData = storage.getItem(storageKey);\r\n        if (!encryptedData) {\r\n          // Try legacy unencrypted key\r\n          const legacyData = storage.getItem(key);\r\n          if (legacyData) {\r\n            medicalLogger.debug('Retrieved legacy unencrypted data', {\r\n              category: LOG_CATEGORIES.SECURITY,\r\n              key,\r\n            });\r\n            try {\r\n              return JSON.parse(legacyData);\r\n            } catch (error) {\r\n              return legacyData;\r\n            }\r\n          }\r\n          return null;\r\n        }\r\n\r\n        // Decrypt the data\r\n        const decryptedData = await this.decryptData(encryptedData);\r\n\r\n        medicalLogger.debug('Data retrieved securely', {\r\n          category: LOG_CATEGORIES.SECURITY,\r\n          key: storageKey,\r\n          storage: useSessionStorage ? 'session' : 'local',\r\n          hasData: !!decryptedData,\r\n        });\r\n\r\n        return decryptedData;\r\n      },\r\n      {\r\n        category: ERROR_CATEGORIES.STORAGE,\r\n        context: { operation: 'secure_retrieve', key },\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Securely remove data\r\n   * @param {string} key - Storage key\r\n   * @param {boolean} useSessionStorage - Use sessionStorage instead of localStorage\r\n   */\r\n  async secureRemove(key, useSessionStorage = false) {\r\n    return safeAsync(\r\n      async () => {\r\n        const storage = useSessionStorage ? sessionStorage : localStorage;\r\n        const storageKey = `_enc_${key}`;\r\n\r\n        // Remove both encrypted and legacy versions\r\n        storage.removeItem(storageKey);\r\n        storage.removeItem(key);\r\n\r\n        medicalLogger.debug('Data removed securely', {\r\n          category: LOG_CATEGORIES.SECURITY,\r\n          key: storageKey,\r\n          storage: useSessionStorage ? 'session' : 'local',\r\n        });\r\n\r\n        return true;\r\n      },\r\n      {\r\n        category: ERROR_CATEGORIES.STORAGE,\r\n        context: { operation: 'secure_remove', key },\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Check if data is encrypted\r\n   * @param {string} dataString - Data string to check\r\n   * @returns {boolean} True if data appears to be encrypted\r\n   */\r\n  isDataEncrypted(dataString) {\r\n    try {\r\n      const parsed = JSON.parse(dataString);\r\n      return !!(parsed.encrypted && parsed.iv && parsed.version);\r\n    } catch (error) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Migrate legacy unencrypted data to encrypted format\r\n   * @param {string} key - Storage key\r\n   * @param {boolean} useSessionStorage - Use sessionStorage instead of localStorage\r\n   */\r\n  async migrateLegacyData(key, useSessionStorage = false) {\r\n    return safeAsync(\r\n      async () => {\r\n        const storage = useSessionStorage ? sessionStorage : localStorage;\r\n        const legacyData = storage.getItem(key);\r\n\r\n        if (legacyData && !this.isDataEncrypted(legacyData)) {\r\n          medicalLogger.info('Migrating legacy unencrypted data', {\r\n            category: LOG_CATEGORIES.SECURITY,\r\n            key,\r\n          });\r\n\r\n          // Parse legacy data\r\n          let parsedData;\r\n          try {\r\n            parsedData = JSON.parse(legacyData);\r\n          } catch (error) {\r\n            parsedData = legacyData;\r\n          }\r\n\r\n          // Store encrypted version\r\n          await this.secureStore(key.replace('_enc_', ''), parsedData, useSessionStorage);\r\n\r\n          // Remove legacy version\r\n          storage.removeItem(key);\r\n\r\n          medicalLogger.info('Legacy data migration completed', {\r\n            category: LOG_CATEGORIES.SECURITY,\r\n            key,\r\n          });\r\n\r\n          return true;\r\n        }\r\n\r\n        return false;\r\n      },\r\n      {\r\n        category: ERROR_CATEGORIES.STORAGE,\r\n        context: { operation: 'migrate_legacy_data', key },\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Clear all encryption keys (for logout)\r\n   */\r\n  clearEncryptionKeys() {\r\n    try {\r\n      sessionStorage.removeItem('_medical_km');\r\n      this.encryptionKey = null;\r\n\r\n      medicalLogger.info('Encryption keys cleared', {\r\n        category: LOG_CATEGORIES.SECURITY,\r\n      });\r\n    } catch (error) {\r\n      medicalLogger.warn('Failed to clear encryption keys', {\r\n        category: LOG_CATEGORIES.SECURITY,\r\n        error: error.message,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get encryption status\r\n   */\r\n  getStatus() {\r\n    return {\r\n      isSupported: this.isSupported,\r\n      isInitialized: !!this.encryptionKey,\r\n      algorithm: this.algorithm,\r\n      keyLength: this.keyLength,\r\n      version: this.version,\r\n    };\r\n  }\r\n}\r\n\r\n// Create global instance\r\nexport const medicalEncryption = new MedicalDataEncryption();\r\n\r\n// Convenience functions\r\nexport const secureStore = (key, data, useSessionStorage = false) => medicalEncryption.secureStore(key, data, useSessionStorage);\r\n\r\nexport const secureRetrieve = (key, useSessionStorage = false) => medicalEncryption.secureRetrieve(key, useSessionStorage);\r\n\r\nexport const secureRemove = (key, useSessionStorage = false) => medicalEncryption.secureRemove(key, useSessionStorage);\r\n\r\nexport const clearEncryptionKeys = () => medicalEncryption.clearEncryptionKeys();\r\n","/**\r\n * Service Worker Manager for Medical Application\r\n * iGFAP Stroke Triage Assistant - Phase 3 Advanced Features\r\n *\r\n * Manages service worker lifecycle and offline capabilities\r\n */\r\n\r\nimport { medicalEventObserver, MEDICAL_EVENTS } from '../patterns/observer.js';\r\nimport { medicalPerformanceMonitor, PerformanceMetricType } from '../performance/medical-performance-monitor.js';\r\nimport { safeSetInnerHTML } from '../security/html-sanitizer.js';\r\n\r\n// Bulletproof error handling utilities\r\nimport {\r\n  safeAsync,\r\n  MedicalError,\r\n  ERROR_CATEGORIES,\r\n  ERROR_SEVERITY,\r\n  MEDICAL_ERROR_CODES,\r\n} from '../utils/error-handler.js';\r\n\r\n/**\r\n * Service Worker Manager Class\r\n */\r\nexport class MedicalServiceWorkerManager {\r\n  constructor() {\r\n    this.registration = null;\r\n    this.isOnline = navigator.onLine;\r\n    this.updateAvailable = false;\r\n    this.isUpdateCheckEnabled = true;\r\n    this.retryCount = 0;\r\n    this.maxRetries = 3;\r\n\r\n    // Initialize event listeners\r\n    this.setupEventListeners();\r\n  }\r\n\r\n  /**\r\n   * Initialize service worker registration with bulletproof error handling\r\n   */\r\n  async initialize() {\r\n    return safeAsync(\r\n      async () => {\r\n        if (!('serviceWorker' in navigator)) {\r\n          throw new MedicalError(\r\n            'Service Worker not supported in this browser',\r\n            'SW_NOT_SUPPORTED',\r\n            ERROR_CATEGORIES.STORAGE,\r\n            ERROR_SEVERITY.MEDIUM,\r\n          ).withContext({ userAgent: navigator.userAgent });\r\n        }\r\n\r\n        const metricId = medicalPerformanceMonitor.startMeasurement(\r\n          PerformanceMetricType.USER_INTERACTION,\r\n          'service_worker_registration',\r\n        );\r\n\r\n        try {\r\n          // Register service worker with timeout\r\n          const registrationPromise = navigator.serviceWorker.register(\r\n            '/0925/src/workers/medical-service-worker.js',\r\n            {\r\n              scope: '/0925/',\r\n              updateViaCache: 'none',\r\n            },\r\n          );\r\n\r\n          this.registration = await Promise.race([\r\n            registrationPromise,\r\n            new Promise((_, reject) => setTimeout(() => reject(new Error('Service Worker registration timeout')), 30000)),\r\n          ]);\r\n\r\n          if (!this.registration) {\r\n            throw new MedicalError(\r\n              'Service Worker registration returned null',\r\n              'SW_REGISTRATION_NULL',\r\n              ERROR_CATEGORIES.STORAGE,\r\n              ERROR_SEVERITY.HIGH,\r\n            );\r\n          }\r\n\r\n          // ('üè• Medical Service Worker registered successfully');\r\n\r\n          // Setup components with error handling\r\n          await Promise.allSettled([\r\n            safeAsync(() => this.setupUpdateDetection(), null, { operation: 'setup_update_detection' }),\r\n            safeAsync(() => this.setupMessageHandler(), null, { operation: 'setup_message_handler' }),\r\n            safeAsync(() => this.checkForUpdates(), null, { operation: 'initial_update_check' }),\r\n          ]);\r\n\r\n          medicalPerformanceMonitor.endMeasurement(metricId, { success: true });\r\n\r\n          medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n            action: 'sw_registered',\r\n            scope: this.registration.scope,\r\n          });\r\n\r\n          return true;\r\n        } catch (error) {\r\n          medicalPerformanceMonitor.endMeasurement(metricId, {\r\n            success: false,\r\n            error: error.message,\r\n          });\r\n\r\n          throw error;\r\n        }\r\n      },\r\n      (error) => {\r\n        console.error('Service Worker initialization failed:', error.message);\r\n\r\n        medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n          action: 'sw_registration_failed',\r\n          error: error.message,\r\n          context: error.context || {},\r\n        });\r\n\r\n        return false;\r\n      },\r\n      {\r\n        category: ERROR_CATEGORIES.STORAGE,\r\n        severity: ERROR_SEVERITY.MEDIUM,\r\n        timeout: 35000,\r\n        context: {\r\n          operation: 'service_worker_initialization',\r\n        },\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Setup event listeners for online/offline detection\r\n   */\r\n  setupEventListeners() {\r\n    // Online/offline detection\r\n    window.addEventListener('online', () => {\r\n      this.isOnline = true;\r\n      this.handleOnlineStatusChange(true);\r\n    });\r\n\r\n    window.addEventListener('offline', () => {\r\n      this.isOnline = false;\r\n      this.handleOnlineStatusChange(false);\r\n    });\r\n\r\n    // Page visibility for update checks\r\n    document.addEventListener('visibilitychange', () => {\r\n      if (!document.hidden && this.isUpdateCheckEnabled) {\r\n        this.checkForUpdates();\r\n      }\r\n    });\r\n\r\n    // Periodic update checks\r\n    setInterval(() => {\r\n      if (this.isUpdateCheckEnabled && this.isOnline) {\r\n        this.checkForUpdates();\r\n      }\r\n    }, 5 * 60 * 1000); // Check every 5 minutes\r\n  }\r\n\r\n  /**\r\n   * Setup service worker update detection\r\n   */\r\n  setupUpdateDetection() {\r\n    if (!this.registration) {\r\n      return;\r\n    }\r\n\r\n    // Listen for new service worker installing\r\n    this.registration.addEventListener('updatefound', () => {\r\n      const newWorker = this.registration.installing;\r\n\r\n      newWorker.addEventListener('statechange', () => {\r\n        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {\r\n          // New update available\r\n          this.updateAvailable = true;\r\n          this.notifyUpdateAvailable();\r\n        }\r\n      });\r\n    });\r\n\r\n    // Listen for service worker taking control\r\n    navigator.serviceWorker.addEventListener('controllerchange', () => {\r\n      window.location.reload();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Setup message handler for service worker communication\r\n   */\r\n  setupMessageHandler() {\r\n    navigator.serviceWorker.addEventListener('message', (event) => {\r\n      const { type, data } = event.data;\r\n\r\n      switch (type) {\r\n        case 'SW_INSTALLED':\r\n          this.handleServiceWorkerInstalled(data);\r\n          break;\r\n\r\n        case 'SW_ACTIVATED':\r\n          this.handleServiceWorkerActivated(data);\r\n          break;\r\n\r\n        case 'SW_INSTALL_ERROR':\r\n          this.handleServiceWorkerError(data);\r\n          break;\r\n\r\n        case 'MEDICAL_DATA_SYNCED':\r\n          this.handleMedicalDataSynced(data);\r\n          break;\r\n\r\n        default:\r\n          // ('Unknown service worker message:', type, data);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle online/offline status changes with error handling\r\n   */\r\n  handleOnlineStatusChange(isOnline) {\r\n    safeAsync(\r\n      async () => {\r\n        // (`üåê Network status: ${isOnline ? 'Online' : 'Offline'}`);\r\n\r\n        medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n          action: 'network_status_changed',\r\n          isOnline,\r\n          timestamp: new Date().toISOString(),\r\n        });\r\n\r\n        // Show user notification with error handling\r\n        await safeAsync(\r\n          () => this.showNetworkStatusNotification(isOnline),\r\n          null,\r\n          { operation: 'show_network_notification' },\r\n        );\r\n\r\n        // Trigger background sync when coming back online\r\n        if (isOnline && 'serviceWorker' in navigator && navigator.serviceWorker.controller) {\r\n          await safeAsync(\r\n            async () => {\r\n              const registration = await navigator.serviceWorker.ready;\r\n              if ('sync' in registration) {\r\n                return registration.sync.register('medical-data-sync');\r\n              }\r\n            },\r\n            (error) => {\r\n              console.warn('Background sync registration failed:', error.message);\r\n            },\r\n            {\r\n              operation: 'background_sync_registration',\r\n              timeout: 5000,\r\n            },\r\n          );\r\n        }\r\n      },\r\n      (error) => {\r\n        console.error('Error handling network status change:', error.message);\r\n      },\r\n      {\r\n        operation: 'handle_network_status_change',\r\n        isOnline,\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Show network status notification to user with comprehensive error handling\r\n   */\r\n  showNetworkStatusNotification(isOnline) {\r\n    return safeAsync(\r\n      async () => {\r\n        if (!document || !document.body) {\r\n          throw new MedicalError(\r\n            'Document not available for notification',\r\n            'DOCUMENT_UNAVAILABLE',\r\n            ERROR_CATEGORIES.RENDERING,\r\n            ERROR_SEVERITY.LOW,\r\n          );\r\n        }\r\n\r\n        const notification = document.createElement('div');\r\n        if (!notification) {\r\n          throw new MedicalError(\r\n            'Failed to create notification element',\r\n            'ELEMENT_CREATION_FAILED',\r\n            ERROR_CATEGORIES.RENDERING,\r\n            ERROR_SEVERITY.LOW,\r\n          );\r\n        }\r\n\r\n        notification.className = `network-notification ${isOnline ? 'online' : 'offline'}`;\r\n\r\n        try {\r\n          safeSetInnerHTML(notification, `\r\n            <div class=\"notification-content\">\r\n              <span class=\"notification-icon\">${isOnline ? 'üåê' : 'üì¥'}</span>\r\n              <span class=\"notification-text\">\r\n                ${isOnline ? 'Connection restored' : 'Working offline'}\r\n              </span>\r\n            </div>\r\n          `);\r\n        } catch (htmlError) {\r\n          console.warn('Network notification sanitization failed, using fallback:', htmlError.message);\r\n          notification.textContent = isOnline ? 'üåê Connection restored' : 'üì¥ Working offline';\r\n        }\r\n\r\n        // Check if body is still available before appending\r\n        if (!document.body) {\r\n          throw new MedicalError(\r\n            'Document body not available when appending notification',\r\n            'BODY_UNAVAILABLE',\r\n            ERROR_CATEGORIES.RENDERING,\r\n            ERROR_SEVERITY.LOW,\r\n          );\r\n        }\r\n\r\n        document.body.appendChild(notification);\r\n\r\n        // Auto-remove after 3 seconds with error handling\r\n        setTimeout(() => {\r\n          safeAsync(\r\n            () => {\r\n              if (notification && notification.parentNode) {\r\n                notification.parentNode.removeChild(notification);\r\n              }\r\n            },\r\n            null,\r\n            { operation: 'remove_notification' },\r\n          );\r\n        }, 3000);\r\n\r\n        return notification;\r\n      },\r\n      (error) => {\r\n        console.warn('Failed to show network status notification:', error.message);\r\n        // Try simple fallback notification\r\n        try {\r\n          if (console && console.info) {\r\n            console.info(`Network status: ${isOnline ? 'Online' : 'Offline'}`);\r\n          }\r\n        } catch (fallbackError) {\r\n          // Even console failed, nothing more we can do\r\n        }\r\n        return null;\r\n      },\r\n      {\r\n        operation: 'show_network_notification',\r\n        isOnline,\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Check for service worker updates with bulletproof error handling\r\n   */\r\n  async checkForUpdates() {\r\n    return safeAsync(\r\n      async () => {\r\n        if (!this.registration) {\r\n          throw new MedicalError(\r\n            'No service worker registration available for update check',\r\n            'NO_REGISTRATION',\r\n            ERROR_CATEGORIES.STORAGE,\r\n            ERROR_SEVERITY.LOW,\r\n          );\r\n        }\r\n\r\n        // Add timeout to update check\r\n        const updatePromise = this.registration.update();\r\n        const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('Update check timeout')), 10000));\r\n\r\n        await Promise.race([updatePromise, timeoutPromise]);\r\n\r\n        // Reset retry count on successful update check\r\n        this.retryCount = 0;\r\n\r\n        return true;\r\n      },\r\n      (error) => {\r\n        console.warn('Update check failed:', error.message);\r\n\r\n        this.retryCount++;\r\n        if (this.retryCount < this.maxRetries) {\r\n          // Exponential backoff for retries\r\n          const retryDelay = Math.min(5000 * 2 ** (this.retryCount - 1), 30000);\r\n\r\n          setTimeout(() => {\r\n            safeAsync(\r\n              () => this.checkForUpdates(),\r\n              null,\r\n              { operation: 'retry_update_check', retryCount: this.retryCount },\r\n            );\r\n          }, retryDelay);\r\n        } else {\r\n          console.error(`Update check failed after ${this.maxRetries} retries`);\r\n          medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n            action: 'sw_update_check_failed',\r\n            retryCount: this.retryCount,\r\n            error: error.message,\r\n          });\r\n        }\r\n\r\n        return false;\r\n      },\r\n      {\r\n        operation: 'service_worker_update_check',\r\n        retryCount: this.retryCount,\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Apply available update\r\n   */\r\n  async applyUpdate() {\r\n    if (!this.updateAvailable || !this.registration) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Send message to service worker to skip waiting\r\n      if (this.registration.waiting) {\r\n        this.registration.waiting.postMessage({ type: 'SKIP_WAITING' });\r\n      }\r\n\r\n      medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n        action: 'sw_update_applied',\r\n      });\r\n    } catch (error) {\r\n      // ('Failed to apply update:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Notify user of available update\r\n   */\r\n  notifyUpdateAvailable() {\r\n    // ('üì± App update available');\r\n\r\n    medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n      action: 'sw_update_available',\r\n    });\r\n\r\n    // Show update notification\r\n    this.showUpdateNotification();\r\n  }\r\n\r\n  /**\r\n   * Show update notification to user\r\n   */\r\n  showUpdateNotification() {\r\n    const notification = document.createElement('div');\r\n    notification.className = 'update-notification';\r\n    try {\r\n      safeSetInnerHTML(notification, `\r\n        <div class=\"notification-content\">\r\n          <span class=\"notification-icon\">üîÑ</span>\r\n          <span class=\"notification-text\">App update available</span>\r\n          <button class=\"update-button\" onclick=\"medicalSWManager.applyUpdate()\">\r\n            Update Now\r\n          </button>\r\n        </div>\r\n      `);\r\n    } catch (error) {\r\n      console.error('Update notification sanitization failed:', error);\r\n      // Safe fallback using textContent only\r\n      notification.textContent = 'üîÑ App update available. Please refresh to update.';\r\n    }\r\n\r\n    document.body.appendChild(notification);\r\n  }\r\n\r\n  /**\r\n   * Get cache status with timeout and error handling\r\n   */\r\n  async getCacheStatus() {\r\n    return safeAsync(\r\n      async () => {\r\n        if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {\r\n          throw new MedicalError(\r\n            'Service worker controller not available',\r\n            'NO_SW_CONTROLLER',\r\n            ERROR_CATEGORIES.STORAGE,\r\n            ERROR_SEVERITY.LOW,\r\n          );\r\n        }\r\n\r\n        return new Promise((resolve, reject) => {\r\n          const channel = new MessageChannel();\r\n          const timeout = setTimeout(() => {\r\n            reject(new Error('Cache status request timeout'));\r\n          }, 5000);\r\n\r\n          channel.port1.onmessage = (event) => {\r\n            clearTimeout(timeout);\r\n            try {\r\n              // Validate response structure\r\n              if (!event.data || typeof event.data !== 'object') {\r\n                throw new Error('Invalid cache status response format');\r\n              }\r\n              resolve(event.data);\r\n            } catch (error) {\r\n              reject(error);\r\n            }\r\n          };\r\n\r\n          channel.port1.onerror = (error) => {\r\n            clearTimeout(timeout);\r\n            reject(new Error(`Message channel error: ${error.message || 'Unknown error'}`));\r\n          };\r\n\r\n          try {\r\n            navigator.serviceWorker.controller.postMessage(\r\n              { type: 'GET_CACHE_STATUS' },\r\n              [channel.port2],\r\n            );\r\n          } catch (postError) {\r\n            clearTimeout(timeout);\r\n            reject(new Error(`Failed to send cache status request: ${postError.message}`));\r\n          }\r\n        });\r\n      },\r\n      (error) => {\r\n        console.warn('Failed to get cache status:', error.message);\r\n        return {\r\n          error: true,\r\n          message: error.message,\r\n          timestamp: new Date().toISOString(),\r\n        };\r\n      },\r\n      {\r\n        operation: 'get_cache_status',\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Clear all caches\r\n   */\r\n  async clearCaches() {\r\n    if (!navigator.serviceWorker.controller) {\r\n      return;\r\n    }\r\n\r\n    navigator.serviceWorker.controller.postMessage({\r\n      type: 'CLEAR_CACHE',\r\n    });\r\n\r\n    medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n      action: 'sw_caches_cleared',\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Prefetch resources for offline use\r\n   */\r\n  async prefetchResources(resources) {\r\n    if (!navigator.serviceWorker.controller) {\r\n      return;\r\n    }\r\n\r\n    navigator.serviceWorker.controller.postMessage({\r\n      type: 'PREFETCH_RESOURCES',\r\n      data: { resources },\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle service worker installed event\r\n   */\r\n  handleServiceWorkerInstalled(data) {\r\n    // ('‚úÖ Service Worker installed:', data);\r\n\r\n    medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n      action: 'sw_installed',\r\n      cacheVersion: data.cacheVersion,\r\n      criticalResourcesCount: data.criticalResourcesCount,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle service worker activated event\r\n   */\r\n  handleServiceWorkerActivated(data) {\r\n    // ('üöÄ Service Worker activated:', data);\r\n\r\n    medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n      action: 'sw_activated',\r\n      cacheVersion: data.cacheVersion,\r\n      cleanedCaches: data.cleanedCaches,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle service worker error\r\n   */\r\n  handleServiceWorkerError(data) {\r\n    // ('‚ùå Service Worker error:', data);\r\n\r\n    medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n      action: 'sw_error',\r\n      error: data.error,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle medical data sync completion\r\n   */\r\n  handleMedicalDataSynced(data) {\r\n    // ('üîÑ Medical data synced:', data);\r\n\r\n    medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n      action: 'medical_data_synced',\r\n      timestamp: data.timestamp,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get offline capabilities status\r\n   */\r\n  getOfflineStatus() {\r\n    return {\r\n      isOnline: this.isOnline,\r\n      serviceWorkerActive: !!navigator.serviceWorker.controller,\r\n      updateAvailable: this.updateAvailable,\r\n      cacheStatus: this.registration ? 'available' : 'unavailable',\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Enable/disable automatic update checks\r\n   */\r\n  setUpdateCheckEnabled(enabled) {\r\n    this.isUpdateCheckEnabled = enabled;\r\n\r\n    medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n      action: 'sw_update_check_toggled',\r\n      enabled,\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Install-time prompts for offline support\r\n */\r\nexport class OfflineInstallPrompt {\r\n  constructor(swManager) {\r\n    this.swManager = swManager;\r\n    this.installPromptEvent = null;\r\n    this.isInstallable = false;\r\n\r\n    this.setupInstallPrompt();\r\n  }\r\n\r\n  /**\r\n   * Setup PWA install prompt handling\r\n   */\r\n  setupInstallPrompt() {\r\n    // Listen for install prompt\r\n    window.addEventListener('beforeinstallprompt', (event) => {\r\n      event.preventDefault();\r\n      this.installPromptEvent = event;\r\n      this.isInstallable = true;\r\n\r\n      // ('üì± PWA install prompt available');\r\n\r\n      medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n        action: 'pwa_install_prompt_available',\r\n      });\r\n\r\n      // Show install banner after a delay\r\n      setTimeout(() => {\r\n        this.showInstallBanner();\r\n      }, 2000);\r\n    });\r\n\r\n    // Listen for app installed\r\n    window.addEventListener('appinstalled', () => {\r\n      // ('üì± PWA installed successfully');\r\n\r\n      medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n        action: 'pwa_installed',\r\n      });\r\n\r\n      this.hideInstallBanner();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Show PWA install banner\r\n   */\r\n  showInstallBanner() {\r\n    if (!this.isInstallable) {\r\n      return;\r\n    }\r\n\r\n    const banner = document.createElement('div');\r\n    banner.id = 'install-banner';\r\n    banner.className = 'install-banner';\r\n\r\n    // Create banner content manually to avoid HTML sanitization issues\r\n    const bannerContent = document.createElement('div');\r\n    bannerContent.className = 'banner-content';\r\n\r\n    const bannerText = document.createElement('div');\r\n    bannerText.className = 'banner-text';\r\n\r\n    const title = document.createElement('strong');\r\n    title.textContent = 'Install Stroke Triage Assistant';\r\n\r\n    const description = document.createElement('p');\r\n    description.textContent = 'Get offline access and faster performance';\r\n\r\n    bannerText.appendChild(title);\r\n    bannerText.appendChild(description);\r\n\r\n    const bannerActions = document.createElement('div');\r\n    bannerActions.className = 'banner-actions';\r\n\r\n    const installButton = document.createElement('button');\r\n    installButton.className = 'install-button';\r\n    installButton.textContent = 'Install';\r\n    installButton.addEventListener('click', () => {\r\n      this.promptInstall();\r\n    });\r\n\r\n    const dismissButton = document.createElement('button');\r\n    dismissButton.className = 'dismiss-button';\r\n    dismissButton.textContent = '√ó';\r\n    dismissButton.addEventListener('click', () => {\r\n      this.hideInstallBanner();\r\n    });\r\n\r\n    bannerActions.appendChild(installButton);\r\n    bannerActions.appendChild(dismissButton);\r\n\r\n    bannerContent.appendChild(bannerText);\r\n    bannerContent.appendChild(bannerActions);\r\n    banner.appendChild(bannerContent);\r\n\r\n    document.body.appendChild(banner);\r\n  }\r\n\r\n  /**\r\n   * Hide install banner\r\n   */\r\n  hideInstallBanner() {\r\n    const banner = document.getElementById('install-banner');\r\n    if (banner) {\r\n      banner.remove();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Prompt user to install PWA\r\n   */\r\n  async promptInstall() {\r\n    if (!this.installPromptEvent) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const result = await this.installPromptEvent.prompt();\r\n\r\n      medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n        action: 'pwa_install_prompted',\r\n        outcome: result.outcome,\r\n      });\r\n\r\n      // Clear the install prompt\r\n      this.installPromptEvent = null;\r\n      this.isInstallable = false;\r\n\r\n      // Hide banner\r\n      this.hideInstallBanner();\r\n    } catch (error) {\r\n      // ('Install prompt failed:', error);\r\n    }\r\n  }\r\n}\r\n\r\n// Export singleton instances\r\nexport const medicalSWManager = new MedicalServiceWorkerManager();\r\nexport const offlineInstallPrompt = new OfflineInstallPrompt(medicalSWManager);\r\n\r\n// Make available globally for inline event handlers\r\nwindow.medicalSWManager = medicalSWManager;\r\nwindow.offlineInstallPrompt = offlineInstallPrompt;\r\n","/**\r\n * Medical Data Synchronization Manager\r\n * iGFAP Stroke Triage Assistant - Phase 3 Advanced Features\r\n *\r\n * Provides real-time data synchronization with conflict resolution\r\n */\r\n\r\nimport { medicalEventObserver, MEDICAL_EVENTS } from '../patterns/observer.js';\r\nimport { medicalPerformanceMonitor, PerformanceMetricType } from '../performance/medical-performance-monitor.js';\r\nimport { patientDataCache, MedicalCacheTTL, CachePriority } from '../performance/medical-cache.js';\r\nimport { store } from '../state/store.js';\r\n\r\n// Bulletproof error handling utilities\r\nimport {\r\n  safeAsync,\r\n  MedicalError,\r\n  ERROR_CATEGORIES,\r\n  ERROR_SEVERITY,\r\n  MEDICAL_ERROR_CODES,\r\n} from '../utils/error-handler.js';\r\n\r\n/**\r\n * Sync operation types\r\n */\r\nexport const SyncOperationType = {\r\n  CREATE: 'create',\r\n  UPDATE: 'update',\r\n  DELETE: 'delete',\r\n  CONFLICT_RESOLVE: 'conflict_resolve',\r\n};\r\n\r\n/**\r\n * Sync status states\r\n */\r\nexport const SyncStatus = {\r\n  IDLE: 'idle',\r\n  SYNCING: 'syncing',\r\n  ERROR: 'error',\r\n  CONFLICT: 'conflict',\r\n  OFFLINE: 'offline',\r\n};\r\n\r\n/**\r\n * Data conflict resolution strategies\r\n */\r\nexport const ConflictResolution = {\r\n  CLIENT_WINS: 'client_wins',\r\n  SERVER_WINS: 'server_wins',\r\n  MERGE: 'merge',\r\n  MANUAL: 'manual',\r\n};\r\n\r\n/**\r\n * Medical sync operation wrapper\r\n */\r\nclass MedicalSyncOperation {\r\n  constructor(type, entityType, entityId, data, timestamp = Date.now()) {\r\n    this.id = `sync_${timestamp}_${Math.random().toString(36).substr(2, 9)}`;\r\n    this.type = type;\r\n    this.entityType = entityType;\r\n    this.entityId = entityId;\r\n    this.data = data;\r\n    this.timestamp = timestamp;\r\n    this.attempts = 0;\r\n    this.maxAttempts = 3;\r\n    this.status = 'pending';\r\n    this.error = null;\r\n  }\r\n\r\n  /**\r\n   * Check if operation should be retried\r\n   */\r\n  canRetry() {\r\n    return this.attempts < this.maxAttempts && this.status === 'error';\r\n  }\r\n\r\n  /**\r\n   * Mark operation as failed\r\n   */\r\n  markFailed(error) {\r\n    this.status = 'error';\r\n    this.error = error;\r\n    this.attempts += 1;\r\n  }\r\n\r\n  /**\r\n   * Mark operation as completed\r\n   */\r\n  markCompleted() {\r\n    this.status = 'completed';\r\n    this.error = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Medical Data Synchronization Manager\r\n */\r\nexport class MedicalSyncManager {\r\n  constructor() {\r\n    this.status = SyncStatus.IDLE;\r\n    this.pendingOperations = new Map();\r\n    this.conflictQueue = new Map();\r\n    this.syncInterval = null;\r\n    this.isOnline = navigator.onLine;\r\n    this.lastSyncTime = null;\r\n    this.syncInProgress = false;\r\n\r\n    // Configuration\r\n    this.config = {\r\n      syncIntervalMs: 30000, // 30 seconds\r\n      conflictRetentionMs: 24 * 60 * 60 * 1000, // 24 hours\r\n      maxPendingOperations: 100,\r\n      enableRealTimeSync: true,\r\n      enableConflictResolution: true,\r\n    };\r\n\r\n    this.setupEventListeners();\r\n  }\r\n\r\n  /**\r\n   * Initialize synchronization manager with bulletproof error handling\r\n   */\r\n  async initialize() {\r\n    return safeAsync(\r\n      async () => {\r\n        // ('üîÑ Initializing Medical Sync Manager...');\r\n\r\n        // Load pending operations from storage with error handling\r\n        await safeAsync(\r\n          () => this.loadPendingOperations(),\r\n          (error) => {\r\n            console.warn('Failed to load pending operations, starting fresh:', error.message);\r\n            this.pendingOperations.clear();\r\n          },\r\n          { operation: 'load_pending_operations' },\r\n        );\r\n\r\n        // Start periodic sync if online\r\n        if (this.isOnline && this.config.enableRealTimeSync) {\r\n          await safeAsync(\r\n            () => this.startPeriodicSync(),\r\n            null,\r\n            { operation: 'start_periodic_sync' },\r\n          );\r\n        }\r\n\r\n        // Perform initial sync with error handling\r\n        await safeAsync(\r\n          () => this.performSync(),\r\n          (error) => {\r\n            console.warn('Initial sync failed, will retry later:', error.message);\r\n          },\r\n          { operation: 'initial_sync' },\r\n        );\r\n\r\n        medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n          action: 'sync_manager_initialized',\r\n          pendingOperations: this.pendingOperations.size,\r\n        });\r\n\r\n        // ('‚úÖ Medical Sync Manager initialized');\r\n        return true;\r\n      },\r\n      (error) => {\r\n        console.error('Sync Manager initialization failed:', error.message);\r\n\r\n        medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n          action: 'sync_manager_initialization_failed',\r\n          error: error.message,\r\n        });\r\n\r\n        return false;\r\n      },\r\n      {\r\n        category: ERROR_CATEGORIES.STORAGE,\r\n        severity: ERROR_SEVERITY.MEDIUM,\r\n        timeout: 30000,\r\n        context: {\r\n          operation: 'sync_manager_initialization',\r\n        },\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Setup event listeners\r\n   */\r\n  setupEventListeners() {\r\n    // Online/offline status\r\n    window.addEventListener('online', () => {\r\n      this.isOnline = true;\r\n      this.handleConnectionChange(true);\r\n    });\r\n\r\n    window.addEventListener('offline', () => {\r\n      this.isOnline = false;\r\n      this.handleConnectionChange(false);\r\n    });\r\n\r\n    // Listen for data changes that need syncing\r\n    medicalEventObserver.subscribe(MEDICAL_EVENTS.PATIENT_DATA_UPDATED, (event) => {\r\n      this.queueDataSync('patient_data', event.fieldName, event);\r\n    });\r\n\r\n    medicalEventObserver.subscribe(MEDICAL_EVENTS.PREDICTION_COMPLETED, (event) => {\r\n      this.queueDataSync('prediction_result', event.module, event);\r\n    });\r\n\r\n    // Page visibility for sync optimization\r\n    document.addEventListener('visibilitychange', () => {\r\n      if (!document.hidden && this.isOnline) {\r\n        this.performSync();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle connection status changes\r\n   */\r\n  async handleConnectionChange(isOnline) {\r\n    // (`üåê Connection status changed: ${isOnline ? 'Online' : 'Offline'}`);\r\n\r\n    this.status = isOnline ? SyncStatus.IDLE : SyncStatus.OFFLINE;\r\n\r\n    if (isOnline) {\r\n      // Connection restored - start syncing\r\n      this.startPeriodicSync();\r\n      await this.performSync();\r\n\r\n      medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n        action: 'sync_connection_restored',\r\n        pendingOperations: this.pendingOperations.size,\r\n      });\r\n    } else {\r\n      // Connection lost - stop periodic sync\r\n      this.stopPeriodicSync();\r\n\r\n      medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n        action: 'sync_connection_lost',\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Queue data for synchronization\r\n   */\r\n  queueDataSync(entityType, entityId, data) {\r\n    if (!this.config.enableRealTimeSync) {\r\n      return;\r\n    }\r\n\r\n    const operation = new MedicalSyncOperation(\r\n      SyncOperationType.UPDATE,\r\n      entityType,\r\n      entityId,\r\n      this.sanitizeDataForSync(data),\r\n    );\r\n\r\n    // Prevent queue overflow\r\n    if (this.pendingOperations.size >= this.config.maxPendingOperations) {\r\n      const oldestKey = this.pendingOperations.keys().next().value;\r\n      this.pendingOperations.delete(oldestKey);\r\n    }\r\n\r\n    this.pendingOperations.set(operation.id, operation);\r\n\r\n    // Save to persistent storage\r\n    this.savePendingOperations();\r\n\r\n    // Trigger immediate sync if online\r\n    if (this.isOnline && !this.syncInProgress) {\r\n      setTimeout(() => this.performSync(), 1000); // Small delay to batch operations\r\n    }\r\n\r\n    medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n      action: 'sync_operation_queued',\r\n      entityType,\r\n      entityId,\r\n      operationId: operation.id,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sanitize sensitive data before sync\r\n   */\r\n  sanitizeDataForSync(data) {\r\n    const sanitized = { ...data };\r\n\r\n    // Remove sensitive fields\r\n    const sensitiveFields = ['ssn', 'mrn', 'patient_id', 'user_id', 'session_token'];\r\n    sensitiveFields.forEach((field) => {\r\n      if (sanitized[field]) {\r\n        delete sanitized[field];\r\n      }\r\n    });\r\n\r\n    // Add sync metadata\r\n    sanitized._syncTimestamp = Date.now();\r\n    sanitized._syncId = `sync_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n    return sanitized;\r\n  }\r\n\r\n  /**\r\n   * Perform synchronization of pending operations with comprehensive error handling\r\n   */\r\n  async performSync() {\r\n    return safeAsync(\r\n      async () => {\r\n        if (!this.isOnline || this.syncInProgress || this.pendingOperations.size === 0) {\r\n          return {\r\n            skipped: true,\r\n            reason: !this.isOnline ? 'offline' : this.syncInProgress ? 'already_syncing' : 'no_operations',\r\n          };\r\n        }\r\n\r\n        const metricId = medicalPerformanceMonitor.startMeasurement(\r\n          PerformanceMetricType.NETWORK,\r\n          'medical_data_sync',\r\n        );\r\n\r\n        this.syncInProgress = true;\r\n        this.status = SyncStatus.SYNCING;\r\n\r\n        // (`üîÑ Starting sync of ${this.pendingOperations.size} operations...`);\r\n\r\n        let completedCount = 0;\r\n        let errorCount = 0;\r\n        let conflictCount = 0;\r\n        const startTime = Date.now();\r\n\r\n        try {\r\n          // Process operations in batches with timeout\r\n          const operations = Array.from(this.pendingOperations.values());\r\n          const batchSize = 5;\r\n          const maxSyncTime = 120000; // 2 minutes max sync time\r\n\r\n          for (let i = 0; i < operations.length; i += batchSize) {\r\n            // Check timeout\r\n            if (Date.now() - startTime > maxSyncTime) {\r\n              throw new MedicalError(\r\n                'Sync operation timeout',\r\n                'SYNC_TIMEOUT',\r\n                ERROR_CATEGORIES.NETWORK,\r\n                ERROR_SEVERITY.MEDIUM,\r\n              ).withContext({ processedBatches: Math.floor(i / batchSize), totalBatches: Math.ceil(operations.length / batchSize) });\r\n            }\r\n\r\n            const batch = operations.slice(i, i + batchSize);\r\n            const results = await safeAsync(\r\n              () => this.processSyncBatch(batch),\r\n              (error) => {\r\n                console.warn(`Batch ${Math.floor(i / batchSize)} sync failed:`, error.message);\r\n                return batch.map((op) => ({\r\n                  operationId: op.id,\r\n                  status: 'error',\r\n                  error: error.message,\r\n                }));\r\n              },\r\n              {\r\n                operation: 'process_sync_batch',\r\n                batchIndex: Math.floor(i / batchSize),\r\n                timeout: 30000,\r\n              },\r\n            );\r\n\r\n            results.forEach((result) => {\r\n              if (result.status === 'completed') {\r\n                completedCount++;\r\n                this.pendingOperations.delete(result.operationId);\r\n              } else if (result.status === 'conflict') {\r\n                conflictCount++;\r\n                safeAsync(\r\n                  () => this.handleSyncConflict(result),\r\n                  null,\r\n                  { operation: 'handle_sync_conflict' },\r\n                );\r\n              } else {\r\n                errorCount++;\r\n              }\r\n            });\r\n          }\r\n\r\n          this.lastSyncTime = Date.now();\r\n\r\n          // Save updated pending operations with error handling\r\n          await safeAsync(\r\n            () => this.savePendingOperations(),\r\n            (error) => {\r\n              console.warn('Failed to save pending operations after sync:', error.message);\r\n            },\r\n            { operation: 'save_pending_operations_after_sync' },\r\n          );\r\n\r\n          // (`‚úÖ Sync completed: ${completedCount} success, ${errorCount} errors, ${conflictCount} conflicts`);\r\n\r\n          medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n            action: 'sync_completed',\r\n            completedCount,\r\n            errorCount,\r\n            conflictCount,\r\n            duration: Date.now() - startTime,\r\n          });\r\n\r\n          medicalPerformanceMonitor.endMeasurement(metricId, {\r\n            success: true,\r\n            operationsProcessed: completedCount + errorCount + conflictCount,\r\n          });\r\n\r\n          return {\r\n            success: true,\r\n            completedCount,\r\n            errorCount,\r\n            conflictCount,\r\n            duration: Date.now() - startTime,\r\n          };\r\n        } catch (error) {\r\n          medicalPerformanceMonitor.endMeasurement(metricId, {\r\n            success: false,\r\n            error: error.message,\r\n          });\r\n\r\n          this.status = SyncStatus.ERROR;\r\n          throw error;\r\n        } finally {\r\n          this.syncInProgress = false;\r\n          this.status = this.pendingOperations.size > 0 ? SyncStatus.IDLE : SyncStatus.IDLE;\r\n        }\r\n      },\r\n      (error) => {\r\n        console.error('Sync operation failed:', error.message);\r\n\r\n        medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n          action: 'sync_failed',\r\n          error: error.message,\r\n          pendingOperations: this.pendingOperations.size,\r\n        });\r\n\r\n        this.status = SyncStatus.ERROR;\r\n\r\n        return {\r\n          success: false,\r\n          error: error.message,\r\n        };\r\n      },\r\n      {\r\n        category: ERROR_CATEGORIES.NETWORK,\r\n        severity: ERROR_SEVERITY.MEDIUM,\r\n        timeout: 150000, // 2.5 minutes\r\n        context: {\r\n          operation: 'perform_sync',\r\n          pendingOperations: this.pendingOperations.size,\r\n        },\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Process a batch of sync operations\r\n   */\r\n  async processSyncBatch(operations) {\r\n    const results = [];\r\n\r\n    // Simulate sync operations (in real implementation, these would be API calls)\r\n    for (const operation of operations) {\r\n      try {\r\n        const result = await this.executeSyncOperation(operation);\r\n        results.push({\r\n          operationId: operation.id,\r\n          status: 'completed',\r\n          result,\r\n        });\r\n\r\n        operation.markCompleted();\r\n      } catch (error) {\r\n        if (error.name === 'ConflictError') {\r\n          results.push({\r\n            operationId: operation.id,\r\n            status: 'conflict',\r\n            conflict: error.conflict,\r\n            operation,\r\n          });\r\n        } else {\r\n          operation.markFailed(error.message);\r\n\r\n          if (operation.canRetry()) {\r\n            // (`‚ö†Ô∏è Operation ${operation.id} failed, will retry: ${error.message}`);\r\n          } else {\r\n            // (`‚ùå Operation ${operation.id} failed permanently: ${error.message}`);\r\n            this.pendingOperations.delete(operation.id);\r\n          }\r\n\r\n          results.push({\r\n            operationId: operation.id,\r\n            status: 'error',\r\n            error: error.message,\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * Execute a single sync operation\r\n   */\r\n  async executeSyncOperation(operation) {\r\n    // Simulate API call with realistic delay and error handling\r\n    await new Promise((resolve) => setTimeout(resolve, 100 + Math.random() * 200));\r\n\r\n    // Simulate conflict detection (5% chance)\r\n    if (Math.random() < 0.05) {\r\n      const conflict = {\r\n        clientData: operation.data,\r\n        serverData: { ...operation.data, _serverModified: true },\r\n        conflictFields: ['timestamp', 'value'],\r\n        resolution: ConflictResolution.MANUAL,\r\n      };\r\n\r\n      const error = new Error('Data conflict detected');\r\n      error.name = 'ConflictError';\r\n      error.conflict = conflict;\r\n      throw error;\r\n    }\r\n\r\n    // Simulate network error (2% chance)\r\n    if (Math.random() < 0.02) {\r\n      throw new Error('Network request failed');\r\n    }\r\n\r\n    // Successful sync\r\n    return {\r\n      entityType: operation.entityType,\r\n      entityId: operation.entityId,\r\n      syncTimestamp: Date.now(),\r\n      serverVersion: Date.now(),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Handle sync conflicts\r\n   */\r\n  handleSyncConflict(conflictResult) {\r\n    const { operation, conflict } = conflictResult;\r\n\r\n    // Store conflict for manual resolution\r\n    this.conflictQueue.set(operation.id, {\r\n      operation,\r\n      conflict,\r\n      timestamp: Date.now(),\r\n    });\r\n\r\n    this.status = SyncStatus.CONFLICT;\r\n\r\n    // Apply automatic resolution if configured\r\n    if (this.config.enableConflictResolution) {\r\n      this.resolveConflictAutomatically(operation.id, conflict);\r\n    }\r\n\r\n    medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n      action: 'sync_conflict_detected',\r\n      operationId: operation.id,\r\n      entityType: operation.entityType,\r\n      conflictFields: conflict.conflictFields,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Resolve conflicts automatically based on strategy\r\n   */\r\n  async resolveConflictAutomatically(conflictId, conflict) {\r\n    let resolvedData;\r\n\r\n    switch (conflict.resolution) {\r\n      case ConflictResolution.CLIENT_WINS:\r\n        resolvedData = conflict.clientData;\r\n        break;\r\n\r\n      case ConflictResolution.SERVER_WINS:\r\n        resolvedData = conflict.serverData;\r\n        break;\r\n\r\n      case ConflictResolution.MERGE:\r\n        resolvedData = this.mergeConflictData(conflict.clientData, conflict.serverData);\r\n        break;\r\n\r\n      default:\r\n        // Manual resolution required\r\n        return;\r\n    }\r\n\r\n    // Create resolution operation\r\n    const resolutionOperation = new MedicalSyncOperation(\r\n      SyncOperationType.CONFLICT_RESOLVE,\r\n      'conflict_resolution',\r\n      conflictId,\r\n      resolvedData,\r\n    );\r\n\r\n    this.pendingOperations.set(resolutionOperation.id, resolutionOperation);\r\n    this.conflictQueue.delete(conflictId);\r\n\r\n    medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n      action: 'sync_conflict_auto_resolved',\r\n      conflictId,\r\n      resolution: conflict.resolution,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Merge conflicting data intelligently\r\n   */\r\n  mergeConflictData(clientData, serverData) {\r\n    const merged = { ...serverData };\r\n\r\n    // Prefer client data for user-entered fields\r\n    const clientPreferredFields = ['gfap_value', 'age_years', 'systolic_bp', 'diastolic_bp'];\r\n    clientPreferredFields.forEach((field) => {\r\n      if (clientData[field] !== undefined) {\r\n        merged[field] = clientData[field];\r\n      }\r\n    });\r\n\r\n    // Use latest timestamp\r\n    merged._mergedAt = Date.now();\r\n    merged._mergeStrategy = 'intelligent_merge';\r\n\r\n    return merged;\r\n  }\r\n\r\n  /**\r\n   * Start periodic synchronization\r\n   */\r\n  startPeriodicSync() {\r\n    if (this.syncInterval) {\r\n      return;\r\n    }\r\n\r\n    this.syncInterval = setInterval(() => {\r\n      if (this.isOnline && this.pendingOperations.size > 0) {\r\n        this.performSync();\r\n      }\r\n    }, this.config.syncIntervalMs);\r\n\r\n    // (`üîÑ Periodic sync started (${this.config.syncIntervalMs}ms interval)`);\r\n  }\r\n\r\n  /**\r\n   * Stop periodic synchronization\r\n   */\r\n  stopPeriodicSync() {\r\n    if (this.syncInterval) {\r\n      clearInterval(this.syncInterval);\r\n      this.syncInterval = null;\r\n      // ('‚èπÔ∏è Periodic sync stopped');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Force immediate synchronization\r\n   */\r\n  async forcSync() {\r\n    if (!this.isOnline) {\r\n      throw new Error('Cannot sync while offline');\r\n    }\r\n\r\n    this.stopPeriodicSync();\r\n    await this.performSync();\r\n    this.startPeriodicSync();\r\n  }\r\n\r\n  /**\r\n   * Get synchronization status\r\n   */\r\n  getSyncStatus() {\r\n    return {\r\n      status: this.status,\r\n      isOnline: this.isOnline,\r\n      pendingOperations: this.pendingOperations.size,\r\n      conflicts: this.conflictQueue.size,\r\n      lastSyncTime: this.lastSyncTime,\r\n      syncInProgress: this.syncInProgress,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Load pending operations from storage with comprehensive error handling\r\n   */\r\n  async loadPendingOperations() {\r\n    return safeAsync(\r\n      async () => {\r\n        if (typeof localStorage === 'undefined') {\r\n          throw new MedicalError(\r\n            'Local storage not available',\r\n            'STORAGE_UNAVAILABLE',\r\n            ERROR_CATEGORIES.STORAGE,\r\n            ERROR_SEVERITY.MEDIUM,\r\n          );\r\n        }\r\n\r\n        const stored = localStorage.getItem('medical_sync_pending');\r\n        if (!stored) {\r\n          // ('No pending sync operations found');\r\n          return { loaded: 0 };\r\n        }\r\n\r\n        let operations;\r\n        try {\r\n          operations = JSON.parse(stored);\r\n        } catch (parseError) {\r\n          throw new MedicalError(\r\n            'Failed to parse stored sync operations',\r\n            'PARSE_ERROR',\r\n            ERROR_CATEGORIES.STORAGE,\r\n            ERROR_SEVERITY.MEDIUM,\r\n          ).withContext({ parseError: parseError.message });\r\n        }\r\n\r\n        if (!Array.isArray(operations)) {\r\n          throw new MedicalError(\r\n            'Invalid stored operations format',\r\n            'INVALID_FORMAT',\r\n            ERROR_CATEGORIES.STORAGE,\r\n            ERROR_SEVERITY.MEDIUM,\r\n          ).withContext({ type: typeof operations });\r\n        }\r\n\r\n        let loadedCount = 0;\r\n        let errorCount = 0;\r\n\r\n        operations.forEach((op, index) => {\r\n          try {\r\n            // Validate operation structure\r\n            if (!op || typeof op !== 'object' || !op.type || !op.entityType || !op.entityId) {\r\n              throw new Error(`Invalid operation structure at index ${index}`);\r\n            }\r\n\r\n            const operation = new MedicalSyncOperation(op.type, op.entityType, op.entityId, op.data, op.timestamp);\r\n            operation.attempts = Math.max(0, op.attempts || 0);\r\n            operation.status = op.status || 'pending';\r\n\r\n            // Skip operations that have exceeded max attempts\r\n            if (operation.attempts >= operation.maxAttempts) {\r\n              console.warn(`Skipping operation ${operation.id} - exceeded max attempts`);\r\n              return;\r\n            }\r\n\r\n            this.pendingOperations.set(operation.id, operation);\r\n            loadedCount++;\r\n          } catch (opError) {\r\n            console.warn(`Failed to load operation at index ${index}:`, opError.message);\r\n            errorCount++;\r\n          }\r\n        });\r\n\r\n        // (`üì¶ Loaded ${loadedCount} pending sync operations (${errorCount} errors)`);\r\n\r\n        return { loaded: loadedCount, errors: errorCount };\r\n      },\r\n      (error) => {\r\n        console.warn('Failed to load pending operations:', error.message);\r\n\r\n        // Clear corrupted data\r\n        try {\r\n          localStorage.removeItem('medical_sync_pending');\r\n        } catch (clearError) {\r\n          console.error('Failed to clear corrupted sync data:', clearError.message);\r\n        }\r\n\r\n        return { loaded: 0, errors: 1, cleared: true };\r\n      },\r\n      {\r\n        category: ERROR_CATEGORIES.STORAGE,\r\n        severity: ERROR_SEVERITY.LOW,\r\n        timeout: 5000,\r\n        context: {\r\n          operation: 'load_pending_operations',\r\n        },\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Save pending operations to storage with comprehensive error handling\r\n   */\r\n  async savePendingOperations() {\r\n    return safeAsync(\r\n      async () => {\r\n        if (typeof localStorage === 'undefined') {\r\n          throw new MedicalError(\r\n            'Local storage not available',\r\n            'STORAGE_UNAVAILABLE',\r\n            ERROR_CATEGORIES.STORAGE,\r\n            ERROR_SEVERITY.MEDIUM,\r\n          );\r\n        }\r\n\r\n        const operations = Array.from(this.pendingOperations.values()).map((op) => {\r\n          try {\r\n            return {\r\n              id: op.id,\r\n              type: op.type,\r\n              entityType: op.entityType,\r\n              entityId: op.entityId,\r\n              data: op.data,\r\n              timestamp: op.timestamp,\r\n              attempts: op.attempts,\r\n              status: op.status,\r\n            };\r\n          } catch (serializeError) {\r\n            console.warn(`Failed to serialize operation ${op.id}:`, serializeError.message);\r\n            return null;\r\n          }\r\n        }).filter((op) => op !== null);\r\n\r\n        const serialized = JSON.stringify(operations);\r\n\r\n        // Check storage quota\r\n        if (serialized.length > 1024 * 1024) { // 1MB limit\r\n          console.warn('Sync operations data is very large, may hit storage limits');\r\n        }\r\n\r\n        localStorage.setItem('medical_sync_pending', serialized);\r\n\r\n        return { saved: operations.length };\r\n      },\r\n      (error) => {\r\n        console.error('Failed to save pending operations:', error.message);\r\n\r\n        // Try to clear space and retry once\r\n        if (error.name === 'QuotaExceededError') {\r\n          try {\r\n            // Remove oldest operations to make space\r\n            const operationsArray = Array.from(this.pendingOperations.entries());\r\n            const halfPoint = Math.floor(operationsArray.length / 2);\r\n            const toKeep = operationsArray.slice(-halfPoint);\r\n\r\n            this.pendingOperations.clear();\r\n            toKeep.forEach(([id, op]) => {\r\n              this.pendingOperations.set(id, op);\r\n            });\r\n\r\n            console.info(`Reduced operations from ${operationsArray.length} to ${toKeep.length} due to storage quota`);\r\n\r\n            // Retry save\r\n            const reducedOperations = toKeep.map(([, op]) => ({\r\n              id: op.id,\r\n              type: op.type,\r\n              entityType: op.entityType,\r\n              entityId: op.entityId,\r\n              data: op.data,\r\n              timestamp: op.timestamp,\r\n              attempts: op.attempts,\r\n              status: op.status,\r\n            }));\r\n\r\n            localStorage.setItem('medical_sync_pending', JSON.stringify(reducedOperations));\r\n            return { saved: reducedOperations.length, reduced: true };\r\n          } catch (retryError) {\r\n            console.error('Failed to save even after reducing operations:', retryError.message);\r\n            return { saved: 0, error: retryError.message };\r\n          }\r\n        }\r\n\r\n        return { saved: 0, error: error.message };\r\n      },\r\n      {\r\n        category: ERROR_CATEGORIES.STORAGE,\r\n        severity: ERROR_SEVERITY.LOW,\r\n        timeout: 5000,\r\n        context: {\r\n          operation: 'save_pending_operations',\r\n          operationCount: this.pendingOperations.size,\r\n        },\r\n      },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Clear all pending operations\r\n   */\r\n  clearPendingOperations() {\r\n    this.pendingOperations.clear();\r\n    this.conflictQueue.clear();\r\n    localStorage.removeItem('medical_sync_pending');\r\n\r\n    medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n      action: 'sync_operations_cleared',\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Configure sync settings\r\n   */\r\n  updateConfig(newConfig) {\r\n    this.config = { ...this.config, ...newConfig };\r\n\r\n    // Restart periodic sync with new interval\r\n    if (this.syncInterval && newConfig.syncIntervalMs) {\r\n      this.stopPeriodicSync();\r\n      this.startPeriodicSync();\r\n    }\r\n\r\n    medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n      action: 'sync_config_updated',\r\n      config: this.config,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Dispose and cleanup\r\n   */\r\n  dispose() {\r\n    this.stopPeriodicSync();\r\n    this.savePendingOperations();\r\n\r\n    medicalEventObserver.publish(MEDICAL_EVENTS.AUDIT_EVENT, {\r\n      action: 'sync_manager_disposed',\r\n    });\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const medicalSyncManager = new MedicalSyncManager();\r\n","/**\r\n * Medical Service Worker for Offline-First Stroke Triage Assistant\r\n * iGFAP Stroke Triage Assistant - Phase 3 Advanced Features\r\n *\r\n * Provides intelligent offline capabilities for critical medical operations with bulletproof error handling\r\n */\r\n\r\n// Bulletproof error handling for service worker\r\nconst ERROR_CATEGORIES = {\r\n  CACHE: 'cache',\r\n  NETWORK: 'network',\r\n  MEDICAL: 'medical',\r\n  STORAGE: 'storage',\r\n};\r\n\r\nconst ERROR_SEVERITY = {\r\n  LOW: 'low',\r\n  MEDIUM: 'medium',\r\n  HIGH: 'high',\r\n  CRITICAL: 'critical',\r\n};\r\n\r\n/**\r\n * Safe async wrapper for service worker operations\r\n */\r\nasync function safeAsync(operation, fallback = null, context = {}) {\r\n  try {\r\n    return await operation();\r\n  } catch (error) {\r\n    console.error('Service Worker error:', error.message, context);\r\n\r\n    // Send error to main thread\r\n    try {\r\n      const clients = await self.clients.matchAll();\r\n      clients.forEach((client) => {\r\n        client.postMessage({\r\n          type: 'SW_ERROR',\r\n          error: {\r\n            message: error.message,\r\n            context,\r\n            timestamp: new Date().toISOString(),\r\n          },\r\n        });\r\n      });\r\n    } catch (msgError) {\r\n      console.error('Failed to send error message to clients:', msgError);\r\n    }\r\n\r\n    return typeof fallback === 'function' ? fallback(error) : fallback;\r\n  }\r\n}\r\n\r\nconst CACHE_VERSION = 'medical-app-v3.0.0';\r\nconst STATIC_CACHE_NAME = `${CACHE_VERSION}-static`;\r\nconst API_CACHE_NAME = `${CACHE_VERSION}-api`;\r\nconst RUNTIME_CACHE_NAME = `${CACHE_VERSION}-runtime`;\r\n\r\n// Critical resources that must be available offline\r\nconst CRITICAL_RESOURCES = [\r\n  '/0925/',\r\n  '/0925/index.html',\r\n  '/0925/src/main.js',\r\n  '/0925/src/app.js',\r\n  '/0925/src/config.js',\r\n  '/0925/src/state/store.js',\r\n  '/0925/src/logic/validate.js',\r\n  '/0925/src/logic/ich-volume-calculator.js',\r\n  '/0925/src/logic/lvo-local-model.js',\r\n  '/0925/src/ui/render.js',\r\n  '/0925/src/styles/app.css',\r\n  '/0925/manifest.json',\r\n  '/0925/icon-192.png',\r\n  '/0925/icon-512.png',\r\n];\r\n\r\n// API endpoints for intelligent caching\r\nconst API_ENDPOINTS = [\r\n  'https://europe-west3-igfap-452720.cloudfunctions.net/predict_coma_ich',\r\n  'https://europe-west3-igfap-452720.cloudfunctions.net/predict_limited_data_ich',\r\n  'https://europe-west3-igfap-452720.cloudfunctions.net/predict_full_stroke',\r\n];\r\n\r\n// Network strategies\r\nconst NETWORK_STRATEGIES = {\r\n  CACHE_FIRST: 'cache-first',\r\n  NETWORK_FIRST: 'network-first',\r\n  NETWORK_ONLY: 'network-only',\r\n  CACHE_ONLY: 'cache-only',\r\n  STALE_WHILE_REVALIDATE: 'stale-while-revalidate',\r\n};\r\n\r\n/**\r\n * Service Worker Installation with bulletproof error handling\r\n */\r\nself.addEventListener('install', (event) => {\r\n  // Medical Service Worker installing\r\n\r\n  event.waitUntil(\r\n    safeAsync(\r\n      async () => {\r\n        // Pre-cache critical resources with individual error handling\r\n        const staticCache = await caches.open(STATIC_CACHE_NAME);\r\n\r\n        // Cache resources individually to prevent single failure from blocking entire installation\r\n        const cacheResults = await Promise.allSettled(\r\n          CRITICAL_RESOURCES.map(async (resource) => {\r\n            try {\r\n              const response = await fetch(resource);\r\n              if (response.ok) {\r\n                return staticCache.put(resource, response);\r\n              }\r\n              throw new Error(`Failed to fetch ${resource}: ${response.status}`);\r\n            } catch (fetchError) {\r\n              console.warn(`Failed to cache critical resource ${resource}:`, fetchError.message);\r\n              return null;\r\n            }\r\n          }),\r\n        );\r\n\r\n        const successfulCaches = cacheResults.filter((result) => result.status === 'fulfilled').length;\r\n        const failedCaches = CRITICAL_RESOURCES.length - successfulCaches;\r\n\r\n        if (failedCaches > CRITICAL_RESOURCES.length / 2) {\r\n          throw new Error(`Too many critical resources failed to cache: ${failedCaches}/${CRITICAL_RESOURCES.length}`);\r\n        }\r\n\r\n        // Initialize API and runtime caches\r\n        await Promise.allSettled([\r\n          caches.open(API_CACHE_NAME),\r\n          caches.open(RUNTIME_CACHE_NAME),\r\n        ]);\r\n\r\n        // Medical Service Worker installed successfully\r\n\r\n        // Send installation success message\r\n        try {\r\n          const clients = await self.clients.matchAll();\r\n          clients.forEach((client) => {\r\n            client.postMessage({\r\n              type: 'SW_INSTALLED',\r\n              cacheVersion: CACHE_VERSION,\r\n              criticalResourcesCount: CRITICAL_RESOURCES.length,\r\n              successfulCaches,\r\n              failedCaches,\r\n              timestamp: new Date().toISOString(),\r\n            });\r\n          });\r\n        } catch (msgError) {\r\n          console.warn('Failed to send installation message:', msgError.message);\r\n        }\r\n\r\n        // Skip waiting to activate immediately\r\n        self.skipWaiting();\r\n\r\n        return { success: true, successfulCaches, failedCaches };\r\n      },\r\n      (error) => {\r\n        // Fallback for installation failure\r\n        console.error('Service Worker installation failed:', error.message);\r\n\r\n        try {\r\n          const clients = self.clients.matchAll();\r\n          clients.then((clientList) => {\r\n            clientList.forEach((client) => {\r\n              client.postMessage({\r\n                type: 'SW_INSTALL_ERROR',\r\n                error: error.message,\r\n                timestamp: new Date().toISOString(),\r\n              });\r\n            });\r\n          });\r\n        } catch (msgError) {\r\n          console.error('Failed to send installation error message:', msgError.message);\r\n        }\r\n\r\n        return { success: false, error: error.message };\r\n      },\r\n      {\r\n        operation: 'service_worker_installation',\r\n        criticalResourcesCount: CRITICAL_RESOURCES.length,\r\n      },\r\n    ),\r\n  );\r\n});\r\n\r\n/**\r\n * Service Worker Activation with bulletproof error handling\r\n */\r\nself.addEventListener('activate', (event) => {\r\n  // Medical Service Worker activating\r\n\r\n  event.waitUntil(\r\n    safeAsync(\r\n      async () => {\r\n        // Clean up old caches with individual error handling\r\n        const cacheNames = await caches.keys();\r\n        const oldCaches = cacheNames.filter((name) => name.startsWith('medical-app-v') && !name.includes(CACHE_VERSION));\r\n\r\n        const cleanupResults = await Promise.allSettled(\r\n          oldCaches.map(async (cacheName) => {\r\n            try {\r\n              const deleted = await caches.delete(cacheName);\r\n              return { cacheName, deleted };\r\n            } catch (error) {\r\n              console.warn(`Failed to delete cache ${cacheName}:`, error.message);\r\n              return { cacheName, deleted: false, error: error.message };\r\n            }\r\n          }),\r\n        );\r\n\r\n        const successfulCleanups = cleanupResults.filter((result) => result.status === 'fulfilled' && result.value.deleted).length;\r\n\r\n        // Cleaned up old caches\r\n\r\n        // Claim all clients with timeout\r\n        await Promise.race([\r\n          self.clients.claim(),\r\n          new Promise((_, reject) => setTimeout(() => reject(new Error('Client claim timeout')), 5000)),\r\n        ]);\r\n\r\n        // Medical Service Worker activated\r\n\r\n        // Notify clients of activation\r\n        const clients = await self.clients.matchAll();\r\n        const notificationPromises = clients.map((client) => {\r\n          try {\r\n            return client.postMessage({\r\n              type: 'SW_ACTIVATED',\r\n              cacheVersion: CACHE_VERSION,\r\n              cleanedCaches: successfulCleanups,\r\n              totalOldCaches: oldCaches.length,\r\n              timestamp: new Date().toISOString(),\r\n            });\r\n          } catch (error) {\r\n            console.warn('Failed to notify client of activation:', error.message);\r\n            return null;\r\n          }\r\n        });\r\n\r\n        await Promise.allSettled(notificationPromises);\r\n\r\n        return { success: true, cleanedCaches: successfulCleanups };\r\n      },\r\n      (error) => {\r\n        console.error('Service Worker activation failed:', error.message);\r\n\r\n        // Try to notify clients of activation failure\r\n        safeAsync(\r\n          async () => {\r\n            const clients = await self.clients.matchAll();\r\n            clients.forEach((client) => {\r\n              client.postMessage({\r\n                type: 'SW_ACTIVATION_ERROR',\r\n                error: error.message,\r\n                timestamp: new Date().toISOString(),\r\n              });\r\n            });\r\n          },\r\n          null,\r\n          { operation: 'activation_error_notification' },\r\n        );\r\n\r\n        return { success: false, error: error.message };\r\n      },\r\n      {\r\n        operation: 'service_worker_activation',\r\n      },\r\n    ),\r\n  );\r\n});\r\n\r\n/**\r\n * Fetch Event Handler with Intelligent Caching\r\n */\r\nself.addEventListener('fetch', (event) => {\r\n  const { request } = event;\r\n  const url = new URL(request.url);\r\n\r\n  // Skip non-GET requests for caching\r\n  if (request.method !== 'GET') {\r\n    if (isAPIRequest(url)) {\r\n      // Handle API POST requests with intelligent offline behavior\r\n      event.respondWith(handleAPIRequest(request));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Route requests based on type\r\n  if (isAPIRequest(url)) {\r\n    event.respondWith(handleAPIRequest(request));\r\n  } else if (isStaticResource(url)) {\r\n    event.respondWith(handleStaticResource(request));\r\n  } else if (isAppShell(url)) {\r\n    event.respondWith(handleAppShell(request));\r\n  } else {\r\n    event.respondWith(handleRuntimeRequest(request));\r\n  }\r\n});\r\n\r\n/**\r\n * Handle API requests with medical data caching and bulletproof error handling\r\n */\r\nasync function handleAPIRequest(request) {\r\n  return safeAsync(\r\n    async () => {\r\n      const url = new URL(request.url);\r\n\r\n      // For POST requests (predictions), try network first with offline fallback\r\n      if (request.method === 'POST') {\r\n        return await handlePredictionRequest(request);\r\n      }\r\n\r\n      // For GET requests, use stale-while-revalidate\r\n      const cache = await caches.open(API_CACHE_NAME);\r\n      const cachedResponse = await cache.match(request);\r\n\r\n      // If we have a cached response, return it while updating in background\r\n      if (cachedResponse) {\r\n        // Update cache in background with error handling\r\n        safeAsync(\r\n          async () => {\r\n            const response = await fetch(request);\r\n            if (response.ok) {\r\n              await cache.put(request, response.clone());\r\n            }\r\n          },\r\n          null,\r\n          { operation: 'background_cache_update', url: request.url },\r\n        );\r\n\r\n        return cachedResponse;\r\n      }\r\n\r\n      // No cache, try network with timeout\r\n      const controller = new AbortController();\r\n      const timeoutId = setTimeout(() => controller.abort(), 10000);\r\n\r\n      try {\r\n        const networkResponse = await fetch(request, {\r\n          signal: controller.signal,\r\n        });\r\n        clearTimeout(timeoutId);\r\n\r\n        if (networkResponse.ok) {\r\n          // Cache response with error handling\r\n          try {\r\n            await cache.put(request, networkResponse.clone());\r\n          } catch (cacheError) {\r\n            console.warn('Failed to cache API response:', cacheError.message);\r\n          }\r\n        }\r\n\r\n        return networkResponse;\r\n      } catch (fetchError) {\r\n        clearTimeout(timeoutId);\r\n        throw fetchError;\r\n      }\r\n    },\r\n    (error) => {\r\n      console.warn('API request failed, returning offline fallback:', error.message);\r\n      return createOfflineFallbackResponse(request);\r\n    },\r\n    {\r\n      operation: 'api_request_handling',\r\n      url: request.url,\r\n      method: request.method,\r\n    },\r\n  );\r\n}\r\n\r\n/**\r\n * Handle prediction API requests with intelligent offline support and bulletproof error handling\r\n */\r\nasync function handlePredictionRequest(request) {\r\n  return safeAsync(\r\n    async () => {\r\n      // Clone request for potential retry\r\n      const requestClone = request.clone();\r\n\r\n      // Try network first (critical for real-time predictions)\r\n      const controller = new AbortController();\r\n      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout\r\n\r\n      try {\r\n        const networkResponse = await fetch(request, {\r\n          signal: controller.signal,\r\n        });\r\n\r\n        clearTimeout(timeoutId);\r\n\r\n        if (networkResponse.ok) {\r\n          // Cache successful prediction for offline reference with error handling\r\n          safeAsync(\r\n            async () => {\r\n              const cache = await caches.open(API_CACHE_NAME);\r\n              const cacheKey = await createPredictionCacheKey(requestClone);\r\n\r\n              // Store with timestamp for freshness checking\r\n              const responseWithMetadata = await addCacheMetadata(networkResponse.clone());\r\n              await cache.put(cacheKey, responseWithMetadata);\r\n            },\r\n            null,\r\n            { operation: 'prediction_cache_storage', url: request.url },\r\n          );\r\n\r\n          return networkResponse;\r\n        }\r\n\r\n        throw new Error(`API returned ${networkResponse.status}: ${networkResponse.statusText}`);\r\n      } catch (fetchError) {\r\n        clearTimeout(timeoutId);\r\n        throw fetchError;\r\n      }\r\n    },\r\n    async (error) => {\r\n      console.warn('Network prediction failed, trying offline alternatives:', error.message);\r\n\r\n      // Try local LVO model if available\r\n      const localPrediction = await safeAsync(\r\n        () => tryLocalPrediction(request),\r\n        null,\r\n        { operation: 'local_prediction_attempt' },\r\n      );\r\n\r\n      if (localPrediction) {\r\n        return localPrediction;\r\n      }\r\n\r\n      // Return cached similar prediction if available\r\n      const cachedPrediction = await safeAsync(\r\n        () => findSimilarCachedPrediction(request),\r\n        null,\r\n        { operation: 'cached_prediction_lookup' },\r\n      );\r\n\r\n      if (cachedPrediction) {\r\n        return cachedPrediction;\r\n      }\r\n\r\n      // Return offline guidance response\r\n      return createOfflinePredictionGuidance();\r\n    },\r\n    {\r\n      operation: 'prediction_request_handling',\r\n      url: request.url,\r\n    },\r\n  );\r\n}\r\n\r\n/**\r\n * Try local LVO prediction model when offline with comprehensive error handling\r\n */\r\nasync function tryLocalPrediction(request) {\r\n  return safeAsync(\r\n    async () => {\r\n      // Safe request body parsing\r\n      let data;\r\n      try {\r\n        const body = await request.text();\r\n        data = JSON.parse(body);\r\n      } catch (parseError) {\r\n        throw new Error(`Failed to parse request body: ${parseError.message}`);\r\n      }\r\n\r\n      // Validate required data\r\n      if (!data || typeof data !== 'object') {\r\n        throw new Error('Invalid request data format');\r\n      }\r\n\r\n      // Check if we can use local LVO model\r\n      if (request.url.includes('predict_full_stroke')) {\r\n        // Validate required fields\r\n        if (!data.gfap_value || !data.fast_ed_score) {\r\n          throw new Error('Missing required fields for local LVO prediction');\r\n        }\r\n\r\n        // Validate field ranges\r\n        if (data.gfap_value < 0 || data.gfap_value > 10000) {\r\n          throw new Error('GFAP value out of valid range');\r\n        }\r\n\r\n        if (data.fast_ed_score < 0 || data.fast_ed_score > 10) {\r\n          throw new Error('FAST-ED score out of valid range');\r\n        }\r\n\r\n        // Calculate local prediction with error handling\r\n        const localResult = calculateLocalLVO(data.gfap_value, data.fast_ed_score);\r\n\r\n        if (!localResult || typeof localResult !== 'object') {\r\n          throw new Error('Local LVO calculation failed');\r\n        }\r\n\r\n        return new Response(JSON.stringify({\r\n          ...localResult,\r\n          source: 'local_model',\r\n          offline: true,\r\n          timestamp: new Date().toISOString(),\r\n          warning: 'This is an offline prediction using a simplified model. Seek professional medical advice.',\r\n        }), {\r\n          status: 200,\r\n          headers: { 'Content-Type': 'application/json' },\r\n        });\r\n      }\r\n\r\n      return null;\r\n    },\r\n    (error) => {\r\n      console.warn('Local prediction failed:', error.message);\r\n      return null;\r\n    },\r\n    {\r\n      operation: 'local_prediction',\r\n      url: request.url,\r\n    },\r\n  );\r\n}\r\n\r\n/**\r\n * Simplified local LVO calculation with safety checks\r\n */\r\nfunction calculateLocalLVO(gfap, fastEd) {\r\n  try {\r\n    // Input validation\r\n    if (typeof gfap !== 'number' || typeof fastEd !== 'number') {\r\n      throw new Error('GFAP and FAST-ED values must be numbers');\r\n    }\r\n\r\n    if (!isFinite(gfap) || !isFinite(fastEd)) {\r\n      throw new Error('GFAP and FAST-ED values must be finite numbers');\r\n    }\r\n\r\n    if (gfap < 0 || fastEd < 0) {\r\n      throw new Error('GFAP and FAST-ED values cannot be negative');\r\n    }\r\n\r\n    // Simplified logic - in practice, this would use the full model\r\n    const gfapScore = gfap > 500 ? 0.4 : gfap > 200 ? 0.2 : 0.1;\r\n    const fastEdScore = fastEd >= 4 ? 0.5 : fastEd >= 2 ? 0.3 : 0.1;\r\n\r\n    const lvoProb = Math.min(0.95, gfapScore + fastEdScore);\r\n    const ichProb = Math.max(0.05, Math.min(0.5, gfap / 2000)); // Very conservative ICH estimate\r\n\r\n    // Validate calculated probabilities\r\n    if (!isFinite(lvoProb) || !isFinite(ichProb)\r\n        || lvoProb < 0 || lvoProb > 1 || ichProb < 0 || ichProb > 1) {\r\n      throw new Error('Calculated probabilities are invalid');\r\n    }\r\n\r\n    return {\r\n      lvo: {\r\n        probability: Math.round(lvoProb * 100) / 100, // Round to 2 decimal places\r\n        confidence: 0.6, // Lower confidence for offline model\r\n        module: 'Local Offline Model',\r\n        warning: 'Simplified offline calculation - not for clinical decisions',\r\n      },\r\n      ich: {\r\n        probability: Math.round(ichProb * 100) / 100,\r\n        confidence: 0.4, // Very low confidence for ICH estimation\r\n        module: 'Local Offline Model',\r\n        warning: 'Conservative estimate - seek immediate medical evaluation',\r\n      },\r\n      metadata: {\r\n        calculatedAt: new Date().toISOString(),\r\n        inputs: { gfap, fastEd },\r\n        disclaimer: 'This is a simplified offline model for emergency use only. Clinical judgment and professional medical evaluation are essential.',\r\n      },\r\n    };\r\n  } catch (error) {\r\n    console.error('Local LVO calculation failed:', error.message);\r\n\r\n    // Return safe fallback values\r\n    return {\r\n      lvo: {\r\n        probability: 0.1,\r\n        confidence: 0.1,\r\n        module: 'Emergency Fallback',\r\n        error: 'Calculation failed - using minimum risk estimate',\r\n      },\r\n      ich: {\r\n        probability: 0.1,\r\n        confidence: 0.1,\r\n        module: 'Emergency Fallback',\r\n        error: 'Calculation failed - using minimum risk estimate',\r\n      },\r\n      metadata: {\r\n        calculatedAt: new Date().toISOString(),\r\n        error: error.message,\r\n        disclaimer: 'Calculation failed. Immediate medical evaluation required.',\r\n      },\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Handle static resources with cache-first strategy\r\n */\r\nasync function handleStaticResource(request) {\r\n  const cache = await caches.open(STATIC_CACHE_NAME);\r\n  const cachedResponse = await cache.match(request);\r\n\r\n  if (cachedResponse) {\r\n    return cachedResponse;\r\n  }\r\n\r\n  try {\r\n    const networkResponse = await fetch(request);\r\n\r\n    if (networkResponse.ok) {\r\n      cache.put(request, networkResponse.clone());\r\n    }\r\n\r\n    return networkResponse;\r\n  } catch (error) {\r\n    // For critical resources, return a service unavailable response\r\n    return new Response('Service temporarily unavailable', {\r\n      status: 503,\r\n      statusText: 'Service Unavailable',\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Handle app shell with network-first, cache fallback\r\n */\r\nasync function handleAppShell(request) {\r\n  try {\r\n    const networkResponse = await fetch(request);\r\n\r\n    if (networkResponse.ok) {\r\n      const cache = await caches.open(RUNTIME_CACHE_NAME);\r\n      cache.put(request, networkResponse.clone());\r\n    }\r\n\r\n    return networkResponse;\r\n  } catch (error) {\r\n    const cache = await caches.open(STATIC_CACHE_NAME);\r\n    const cachedResponse = await cache.match('/0925/index.html');\r\n\r\n    return cachedResponse || new Response('App temporarily unavailable', {\r\n      status: 503,\r\n      statusText: 'Service Unavailable',\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Handle runtime requests\r\n */\r\nasync function handleRuntimeRequest(request) {\r\n  const cache = await caches.open(RUNTIME_CACHE_NAME);\r\n\r\n  try {\r\n    const networkResponse = await fetch(request);\r\n\r\n    if (networkResponse.ok) {\r\n      cache.put(request, networkResponse.clone());\r\n    }\r\n\r\n    return networkResponse;\r\n  } catch (error) {\r\n    const cachedResponse = await cache.match(request);\r\n    return cachedResponse || fetch(request);\r\n  }\r\n}\r\n\r\n/**\r\n * Utility functions\r\n */\r\nfunction isAPIRequest(url) {\r\n  return API_ENDPOINTS.some((endpoint) => url.href.startsWith(endpoint));\r\n}\r\n\r\nfunction isStaticResource(url) {\r\n  return url.pathname.includes('/src/')\r\n         || url.pathname.includes('/styles/')\r\n         || url.pathname.endsWith('.css')\r\n         || url.pathname.endsWith('.js')\r\n         || url.pathname.endsWith('.png')\r\n         || url.pathname.endsWith('.ico');\r\n}\r\n\r\nfunction isAppShell(url) {\r\n  return url.pathname === '/0925/'\r\n         || url.pathname === '/0925/index.html'\r\n         || url.pathname.endsWith('/');\r\n}\r\n\r\nasync function createPredictionCacheKey(request) {\r\n  const body = await request.text();\r\n  const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(body));\r\n  const hashArray = Array.from(new Uint8Array(hash));\r\n  const hashHex = hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');\r\n\r\n  return `${request.url}#${hashHex}`;\r\n}\r\n\r\nasync function addCacheMetadata(response) {\r\n  const data = await response.json();\r\n  const responseWithMetadata = {\r\n    ...data,\r\n    _cached: true,\r\n    _cachedAt: Date.now(),\r\n    _cacheVersion: CACHE_VERSION,\r\n  };\r\n\r\n  return new Response(JSON.stringify(responseWithMetadata), {\r\n    status: response.status,\r\n    statusText: response.statusText,\r\n    headers: response.headers,\r\n  });\r\n}\r\n\r\nasync function findSimilarCachedPrediction(request) {\r\n  // Implementation would find similar cached predictions\r\n  // This is a placeholder for more sophisticated matching\r\n  return null;\r\n}\r\n\r\nfunction createOfflineFallbackResponse(request) {\r\n  return new Response(JSON.stringify({\r\n    error: 'Network unavailable',\r\n    offline: true,\r\n    guidance: 'Please check your network connection. For emergency situations, contact your local emergency services immediately.',\r\n    timestamp: new Date().toISOString(),\r\n  }), {\r\n    status: 503,\r\n    headers: { 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\nfunction createOfflinePredictionGuidance() {\r\n  return new Response(JSON.stringify({\r\n    offline: true,\r\n    guidance: {\r\n      message: 'Prediction services are currently unavailable. Please use clinical judgment and standard stroke protocols.',\r\n      recommendations: [\r\n        'Assess patient using standard NIHSS scoring',\r\n        'Consider time since symptom onset',\r\n        'Evaluate for contraindications to thrombolysis',\r\n        'Contact stroke team or neurologist if available',\r\n        'If in doubt, treat as potential stroke emergency',\r\n      ],\r\n    },\r\n    emergency: 'For immediate emergency response, contact your local emergency services',\r\n    timestamp: new Date().toISOString(),\r\n  }), {\r\n    status: 200,\r\n    headers: { 'Content-Type': 'application/json' },\r\n  });\r\n}\r\n\r\n/**\r\n * Background Sync for Medical Data\r\n */\r\nself.addEventListener('sync', (event) => {\r\n  if (event.tag === 'medical-data-sync') {\r\n    event.waitUntil(syncMedicalData());\r\n  }\r\n});\r\n\r\nasync function syncMedicalData() {\r\n  // Syncing medical data\r\n\r\n  try {\r\n    // Sync any pending medical data when connection is restored\r\n    // This would include patient data, predictions, etc.\r\n\r\n    // Notify clients of successful sync\r\n    const clients = await self.clients.matchAll();\r\n    clients.forEach((client) => {\r\n      client.postMessage({\r\n        type: 'MEDICAL_DATA_SYNCED',\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n    });\r\n  } catch (error) {\r\n    // Medical data sync failed\r\n  }\r\n}\r\n\r\n/**\r\n * Push Notifications for Medical Alerts\r\n */\r\nself.addEventListener('push', (event) => {\r\n  if (event.data) {\r\n    const data = event.data.json();\r\n\r\n    if (data.type === 'medical-alert') {\r\n      event.waitUntil(showMedicalNotification(data));\r\n    }\r\n  }\r\n});\r\n\r\nasync function showMedicalNotification(data) {\r\n  const options = {\r\n    body: data.message,\r\n    icon: '/0925/icon-192.png',\r\n    badge: '/0925/icon-192.png',\r\n    vibrate: [200, 100, 200],\r\n    requireInteraction: true,\r\n    actions: [\r\n      {\r\n        action: 'view',\r\n        title: 'View Details',\r\n      },\r\n      {\r\n        action: 'dismiss',\r\n        title: 'Dismiss',\r\n      },\r\n    ],\r\n  };\r\n\r\n  await self.registration.showNotification(data.title, options);\r\n}\r\n\r\n/**\r\n * Notification Click Handler\r\n */\r\nself.addEventListener('notificationclick', (event) => {\r\n  event.notification.close();\r\n\r\n  if (event.action === 'view') {\r\n    event.waitUntil(\r\n      self.clients.openWindow('/0925/'),\r\n    );\r\n  }\r\n});\r\n\r\n/**\r\n * Message Handler for Communication with Main Thread\r\n */\r\nself.addEventListener('message', (event) => {\r\n  const { type, data } = event.data;\r\n\r\n  switch (type) {\r\n    case 'SKIP_WAITING':\r\n      self.skipWaiting();\r\n      break;\r\n\r\n    case 'GET_CACHE_STATUS':\r\n      event.ports[0].postMessage(getCacheStatus());\r\n      break;\r\n\r\n    case 'CLEAR_CACHE':\r\n      event.waitUntil(clearAllCaches());\r\n      break;\r\n\r\n    case 'PREFETCH_RESOURCES':\r\n      event.waitUntil(prefetchResources(data.resources));\r\n      break;\r\n  }\r\n});\r\n\r\nasync function getCacheStatus() {\r\n  const caches = await self.caches.keys();\r\n  const status = {};\r\n\r\n  for (const cacheName of caches) {\r\n    const cache = await self.caches.open(cacheName);\r\n    const keys = await cache.keys();\r\n    status[cacheName] = keys.length;\r\n  }\r\n\r\n  return {\r\n    version: CACHE_VERSION,\r\n    caches: status,\r\n    timestamp: new Date().toISOString(),\r\n  };\r\n}\r\n\r\nasync function clearAllCaches() {\r\n  const cacheNames = await caches.keys();\r\n  await Promise.all(\r\n    cacheNames.map((cacheName) => caches.delete(cacheName)),\r\n  );\r\n\r\n  // All caches cleared\r\n}\r\n\r\nasync function prefetchResources(resources) {\r\n  const cache = await caches.open(RUNTIME_CACHE_NAME);\r\n\r\n  for (const resource of resources) {\r\n    try {\r\n      const response = await fetch(resource);\r\n      if (response.ok) {\r\n        await cache.put(resource, response);\r\n      }\r\n    } catch (error) {\r\n      // Failed to prefetch resource\r\n    }\r\n  }\r\n}\r\n\r\n// Medical Service Worker loaded\r\n"],"names":["ALLOWED_TAGS","ALLOWED_ATTRIBUTES","ALLOWED_STYLES","sanitizeHTML","html","options","containsXSSPatterns","doc","sanitizeNode","pattern","node","nodesToRemove","i","child","tagName","sanitizeAttributes","escapeTextContent","nodeToRemove","element","allowedAttrs","attrsToRemove","attr","attrName","isDataAttr","sanitizeStyleAttribute","escapeAttributeValue","styleValue","styles","sanitizedStyles","style","property","value","s","text","safeSetInnerHTML","sanitizedHTML","error","EnvironmentConfig","define_process_env_default","clientConfig","key","defaultValue","type","service","array","byte","issues","warnings","researchPassword","sessionSecret","safeKeys","safeConfig","environmentConfig","getResearchPassword","MedicalDataEncryption","medicalLogger","LOG_CATEGORIES","safeAsync","keyMaterial","ERROR_CATEGORIES","ERROR_SEVERITY","keyData","randomBytes","keyBytes","data","jsonString","dataBytes","iv","encryptedBuffer","encryptedArray","encryptedBase64","ivBase64","encryptedData","encryptedDataString","parseError","encryptedBytes","char","decryptedBuffer","decryptedString","decryptedData","useSessionStorage","storage","storageKey","legacyData","dataString","parsed","parsedData","medicalEncryption","secureRetrieve","secureRemove","MedicalServiceWorkerManager","MedicalError","metricId","medicalPerformanceMonitor","PerformanceMetricType","registrationPromise","_","reject","medicalEventObserver","MEDICAL_EVENTS","newWorker","event","isOnline","registration","notification","htmlError","fallbackError","updatePromise","timeoutPromise","retryDelay","resolve","channel","timeout","postError","resources","enabled","OfflineInstallPrompt","swManager","banner","bannerContent","bannerText","title","description","bannerActions","installButton","dismissButton","result","medicalSWManager","offlineInstallPrompt","SyncOperationType","SyncStatus","ConflictResolution","MedicalSyncOperation","entityType","entityId","timestamp","MedicalSyncManager","operation","oldestKey","sanitized","field","completedCount","errorCount","conflictCount","startTime","operations","batchSize","maxSyncTime","batch","op","results","conflict","conflictResult","conflictId","resolvedData","resolutionOperation","clientData","serverData","merged","stored","loadedCount","index","opError","clearError","serializeError","serialized","operationsArray","halfPoint","toKeep","id","reducedOperations","retryError","newConfig","medicalSyncManager","fallback","context","client","msgError","CACHE_VERSION","STATIC_CACHE_NAME","API_CACHE_NAME","RUNTIME_CACHE_NAME","CRITICAL_RESOURCES","API_ENDPOINTS","staticCache","successfulCaches","resource","response","fetchError","failedCaches","clientList","oldCaches","name","successfulCleanups","cacheName","deleted","notificationPromises","request","url","isAPIRequest","handleAPIRequest","isStaticResource","handleStaticResource","isAppShell","handleAppShell","handleRuntimeRequest","handlePredictionRequest","cache","cachedResponse","controller","timeoutId","networkResponse","cacheError","createOfflineFallbackResponse","requestClone","cacheKey","createPredictionCacheKey","responseWithMetadata","addCacheMetadata","localPrediction","tryLocalPrediction","cachedPrediction","findSimilarCachedPrediction","createOfflinePredictionGuidance","body","localResult","calculateLocalLVO","gfap","fastEd","gfapScore","fastEdScore","lvoProb","ichProb","endpoint","hash","hashHex","b","syncMedicalData","showMedicalNotification","getCacheStatus","clearAllCaches","prefetchResources","caches","status","keys","cacheNames"],"mappings":"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"}