import{D as p,A as u,l as m,b as w}from"./index-j-et3O4p.js";class g extends Error{constructor(r,e,o){super(r),this.name="APIError",this.status=e,this.url=o}}class n extends g{constructor(r,e,o){super(r,e,o),this.name="MedicalAPIError"}}function P(t,r){if(!t||typeof t!="object")return null;const e=[],o=[];return Object.entries(t).forEach(([s,i])=>{typeof i=="number"&&(i>0?e.push({label:s,weight:i}):i<0&&o.push({label:s,weight:Math.abs(i)}))}),e.sort((s,i)=>i.weight-s.weight),o.sort((s,i)=>i.weight-s.weight),{kind:"flat_dictionary",units:"logit",positive:e,negative:o,meta:{}}}const c={safeParseFloat:(t,r=0)=>{const e=parseFloat(t);return isNaN(e)?r:e},normalizeBooleans:t=>{const r={...t};return Object.keys(r).forEach(e=>{r[e]==="true"||r[e]===!0?r[e]=1:(r[e]==="false"||r[e]===!1)&&(r[e]=0)}),r},async makeApiCall(t,r,e="unknown"){console.log(`[API] Making ${e} request to:`,t),console.log("[API] Payload:",r);try{const o=new AbortController,s=t.includes("full_stroke")?15e3:8e3,i=setTimeout(()=>o.abort(),s),d=this.normalizeBooleans(r),l=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(d),signal:o.signal,mode:"cors"});if(clearTimeout(i),!l.ok){const f=await l.text().catch(()=>"Network error");throw new n(`API request failed: ${l.status} ${l.statusText} - ${f}`,l.status,t)}const a=await l.json();return console.log(`[API] ${e} response:`,a),console.log(`[API] ${e} response keys:`,Object.keys(a)),console.log(`[API] ${e} first key:`,Object.keys(a)[0]),console.log(`[API] ${e} first value:`,a[Object.keys(a)[0]]),console.log(`[API] ${e} probability:`,a.probability),console.log(`[API] ${e} ich_probability:`,a.ich_probability),!a.probability&&a.ich_probability!==void 0&&(a.probability=a.ich_probability,console.log(`[API] ${e} normalized probability from ich_probability:`,a.probability)),a}catch(o){throw o.name==="AbortError"?(console.warn(`[API] ${e} request timeout`),new n(`Request timeout after ${timeout/1e3}s`,408,t)):o instanceof n?o:(console.error(`[API] ${e} request failed:`,o),new n(`Network error: ${o.message}`,0,t))}},getRequestStats:()=>({requests:0,errors:0,avgResponseTime:0}),cancelAllRequests:()=>console.log("Cancel requests - not implemented"),async predict(t,r){const o={coma_ich:u.COMA_ICH,limited_ich:u.LDM_ICH,full_stroke:u.FULL_STROKE,lvo:u.LVO_PREDICTION}[t];if(!o)throw new n(`Unknown module type: ${t}`,400,"unknown");return await this.makeApiCall(o,r,t)}};async function _(t){try{return await c.predict("coma_ich",t)}catch(r){if(r instanceof n){const e=new Error(r.message);throw e.name="APIError",e.status=r.status,e.url=r.url,e}throw r}}async function k(t){try{return await c.predict("limited_ich",t)}catch(r){if(r instanceof n){const e=new Error(r.message);throw e.name="APIError",e.status=r.status,e.url=r.url,e}throw r}}async function b(t,r=0){if(console.log("[API] predictLVO called with payload:",t),!t.gfap_value||!t.fast_ed_score)throw new n("Missing required parameters: gfap_value and fast_ed_score",400,u.LVO_PREDICTION);console.log("[API] LVO payload preparation...");try{console.log("üå©Ô∏è Using LVO Cloud Function (primary)");const e=await c.predict("lvo",t);return console.log("[API] LVO Cloud Function response:",e),e}catch(e){console.warn("‚ö†Ô∏è LVO Cloud Function failed, falling back to local model:",e.message),console.log("üè† Using New LVO Model (fallback)");try{const o=parseFloat(t.gfap_value),s=parseInt(t.fast_ed_score);if(isNaN(o)||isNaN(s))throw new Error("Invalid GFAP or FAST-ED values");const i=m(o,s),d=w(o,s),l={kind:"new_model_fallback",units:"normalized_contribution",positive:[{label:"GFAP Biomarker",weight:o>100?.6:.3},{label:"FAST-ED Score",weight:s*.1}].sort((a,f)=>Math.abs(f.weight)-Math.abs(a.weight)),negative:[],meta:{riskLevel:i>.7?"high":i>.4?"moderate":"low",interpretation:`${(i*100).toFixed(1)}% LVO probability (${d===1?"Positive":"Negative"})`}};return{probability:i,drivers:l,confidence:i>.7?.9:i>.4?.7:.5,module:"New LVO Model (Scientifically Calibrated)",interpretation:`${(i*100).toFixed(1)}% LVO probability based on GFAP=${o} and FAST-ED=${s}`}}catch(o){throw console.warn("‚ö†Ô∏è New LVO Model fallback failed:",o.message),new n(`LVO prediction failed: ${e.message}`,e.status||500,u.LVO_PREDICTION)}}}async function A(t,r=0){console.log("[API] predictFullStroke called with payload:",t),console.log("[API] isLocalPreview():",h());try{const e=await c.predict("full_stroke",t);console.log("[API] Full stroke raw response:",e);const o=e.ich_prediction||{};console.log("[API] Extracted ICH data:",o);let s=null;try{console.log("üîÑ Using dedicated LVO prediction (cloud function + fallback)"),s=await b(t),console.log("‚úÖ LVO prediction successful via dedicated function")}catch(i){console.warn("‚ö†Ô∏è Dedicated LVO prediction failed:",i),o.lvo_prediction?s={probability:o.lvo_prediction.probability||0,drivers:o.lvo_prediction.drivers||null,confidence:o.lvo_prediction.confidence||.8,module:"Full Stroke (API Fallback)"}:s=await b(t)}return{ich:{probability:o.probability,drivers:o.drivers?P(o.drivers,"ICH"):o.drivers,confidence:o.confidence,module:o.module},lvo:s}}catch(e){if(console.error("Full Stroke prediction failed:",e),e.status===408&&r<1)return console.log("‚è±Ô∏è Retrying Full Stroke API (cold start detected)..."),A(t,r+1);if(h()){const o=p.mockApiResponses.full_stroke,s=o.ich_prediction||{},i=o.lvo_prediction||{};return{ich:{probability:c.safeParseFloat(s.probability,0),drivers:s.drivers||null,confidence:c.safeParseFloat(s.confidence,.85),module:"Full Stroke (Mock)"},lvo:{probability:c.safeParseFloat(i.probability,0),drivers:i.drivers||null,confidence:c.safeParseFloat(i.confidence,.85),module:"Full Stroke (Mock)"}}}throw new n(`Failed to get stroke predictions: ${e.message}`,e.status,u.FULL_STROKE)}}function h(){return["localhost","127.0.0.1","0.0.0.0"].includes(window.location.hostname)}function F(t){try{const r=Math.max(0,10**(.0192+.4533*Math.log10(Math.max(1,Math.min(t,1e4)))));return Number.isFinite(r)?r:0}catch(r){return 0}}function y(t){return!Number.isFinite(t)||t<=0?"5-10%":t>=60?"91-100%":t>=50?"44-91%":t>=30?"19-44%":t>=10?"10-19%":"5-10%"}function v(t){return t<1?"<1 ml":t<10?`${t.toFixed(1)} ml`:`${Math.round(t)} ml`}export{g as A,k as a,_ as b,y as c,F as e,v as f,A as p};
//# sourceMappingURL=prediction-models-QEREKywz.js.map
