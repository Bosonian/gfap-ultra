<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>iGFAP Triage App</title>
  <meta name="theme-color" content="#007bff" />
  <style>
    :root {
      --primary-color: #007bff; --primary-hover: #0056b3; --background-color: #f4f7f9;
      --container-bg: #ffffff; --text-color: #333; --border-color: #dee2e6; --input-bg: #f8f9fa;
      --lvo-bg: #e1f5fe; --lvo-text: #01579b; --lvo-border: #0288d1;
      --ich-bg: #fbe9e7; --ich-text: #b71c1c; --ich-border: #d84315;
      --unclear-bg: #fffde7; --unclear-text: #f57f17; --unclear-border: #fbc02d;
      --mimic-bg: #e8f5e9; --mimic-text: #1b5e20; --mimic-border: #388e3c;
      --driver-positive-bg: #e74c3c; --driver-negative-bg: #3498db;
      --meter-green: #28a745; --meter-yellow: #ffc107; --meter-red: #dc3545;
    }
    body.dark-mode {
      --primary-color: #409eff; --primary-hover: #3a8ee6; --background-color: #121212;
      --container-bg: #1e1e1e; --text-color: #f1f1f1; --border-color: #444; --input-bg: #2a2a2a;
      --lvo-bg: #1a3a5b; --lvo-text: #b3e5fc; --lvo-border: #4fc3f7;
      --ich-bg: #5c2a30; --ich-text: #ffcdd2; --ich-border: #ff8a65;
      --unclear-bg: #4d442a; --unclear-text: #fff59d; --unclear-border: #ffee58;
      --mimic-bg: #2a5032; --mimic-text: #c8e6c9; --mimic-border: #81c784;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 80px 10px 40px;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      max-width: 750px; margin: 20px auto; padding: 25px;
      background-color: var(--container-bg);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      border: 1px solid var(--border-color);
    }
    .app-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 25px; background-color: var(--container-bg);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s, color 0.3s;
    }
    .app-header h1 { font-size: 1.4em; margin: 0; color: var(--primary-color);}
    .header-right { display: flex; align-items: center; gap: 15px; }
    .language-switcher button { background: none; border: none; padding: 5px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;}
    .language-switcher button:hover { opacity: 1;}
    .language-switcher img { width: 24px; height: 16px; border-radius: 3px; vertical-align: middle;}
    #darkModeToggle { background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer; padding: 8px; }
    h2 { text-align: center; margin-bottom: 25px;}
    .input-group, .checkbox-group { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--input-bg);}
    label { display: block; margin-bottom: 6px; font-weight: bold;}
    input[type="number"], input[type="password"], select { width: 100%; padding: 10px; font-size: 16px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--container-bg); color: var(--text-color); transition: border-color 0.2s, background-color 0.3s, color 0.3s;}
    input:focus, select:focus { border-color: var(--primary-color);}
    button.primary, button.secondary { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold;}
    button.primary { background-color: var(--primary-color); color: white; width: 100%; margin-top: 15px;}
    button.secondary { background: none; border: 1px solid var(--primary-color); color: var(--primary-color);}
    button.primary:hover:not(:disabled) { background-color: var(--primary-hover);}
    button:disabled { background-color: #a0a0a0; cursor: wait;}
    .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;}
    .error-message { color: var(--ich-text); background-color: var(--ich-bg); padding: 12px; border: 1px solid var(--ich-border); border-radius: 6px; display: none; margin-top: 20px;}
    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .modal-overlay.visible { display: flex;}
    .modal { background: var(--container-bg); padding: 25px; border-radius: 12px; max-width: 400px; width: 95%; box-shadow: 0 5px 15px rgba(0,0,0,0.25);}
    .prob-panel { min-width: 220px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px;}
    .probability-meter-container { width: 100%; height: 20px; background: linear-gradient(to right, var(--meter-green) 25%, var(--meter-yellow) 50%, var(--meter-red) 100%); border-radius: 10px; position: relative;}
    .probability-meter-marker { position: absolute; top: -3px; bottom: -3px; width: 6px; background-color: var(--text-color); border: 2px solid var(--container-bg); border-radius: 3px;}
    .probability-meter-label { position: absolute; top: 100%; transform: translateX(-50%); font-size: 1em; font-weight: bold; padding-top: 5px;}
    .triage-card { padding: 20px; border-radius: 12px; border-left: 8px solid; text-align: center;}
    .triage-card.lvo { background-color: var(--lvo-bg); color: var(--lvo-text); border-left-color: var(--lvo-border);}
    .triage-card.ich { background-color: var(--ich-bg); color: var(--ich-text); border-left-color: var(--ich-border);}
    .triage-card.unclear { background-color: var(--unclear-bg); color: var(--unclear-text); border-left-color: var(--unclear-border);}
    .triage-card.mimic { background-color: var(--mimic-bg); color: var(--mimic-text); border-left-color: var(--mimic-border);}
    .triage-card .icon { font-size: 2.5rem; margin-bottom: 10px; }
    .drivers-title { text-align: center; margin: 30px 0 15px; font-size: 1.3em;}
    .drivers-container { display: flex; gap: 25px; flex-wrap: wrap;}
    .drivers-panel { flex: 1; min-width: 220px;}
    .drivers-columns { display: flex; gap: 15px;}
    .driver-column { flex: 1;}
    .driver-column h5 { margin: 0 0 10px 0; text-align: center; font-size: 0.9em; opacity: 0.8;}
    .driver-item { display: flex; align-items: center; margin-bottom: 8px; gap: 8px;}
    .driver-label { flex-shrink: 0; width: 45%; text-align: right; font-size: 0.9em;}
    .driver-bar-container { flex-grow: 1; height: 16px; background-color: color-mix(in srgb, var(--border-color) 50%, transparent); border-radius: 5px;}
    .driver-bar { height: 100%; border-radius: 5px; transition: width 0.5s ease-out;}
    .driver-bar.positive { background-color: var(--driver-positive-bg);}
    .driver-bar.negative { background-color: var(--driver-negative-bg);}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <h1 id="appTitle">iGFAP Triage App</h1>
    <div class="header-right">
      <div class="language-switcher">
        <button onclick="switchLanguage('en')" aria-label="Switch to English"><img src="https://flagcdn.com/gb.svg" alt="English"></button>
        <button onclick="switchLanguage('de')" aria-label="Switch to German"><img src="https://flagcdn.com/de.svg" alt="Deutsch"></button>
      </div>
      <button id="darkModeToggle" aria-label="Toggle dark mode">üåô</button>
    </div>
  </header>

  <main>
    <!-- 1. Access Code Entry -->
    <section id="accessCodeSection" class="container">
      <p>üîë Please enter your access code:</p>
      <div class="input-group">
        <input type="password" id="accessCodeInput" required autocomplete="off" />
      </div>
      <button class="primary" id="accessCodeButton">Submit</button>
      <p id="accessError" class="error-message"></p>
    </section>

    <!-- 2. Module Selection -->
    <section id="moduleSelectionSection" class="container" style="display:none;">
      <h2>Select Module</h2>
      <button class="primary" id="comaModuleBtn">Coma ICH Probability</button>
      <button class="primary" id="strokeModuleBtn">Stroke Triage Assistant</button>
    </section>

    <!-- 3. Coma Module -->
    <section id="comaModuleSection" class="container" style="display:none;">
      <h2>Coma ICH Probability</h2>
      <form id="comaForm">
        <div class="input-group">
          <label for="gfapComaInput">GFAP Value (pg/mL)</label>
          <input type="number" id="gfapComaInput" min="29" max="10001" required />
        </div>
        <button class="primary" id="calculateComaButton" type="submit">Calculate</button>
        <button class="secondary" id="comaBackButton" type="button">‚¨ÖÔ∏è Back</button>
      </form>
      <div id="comaResult" style="margin-top: 16px; display:none;"></div>
      <p id="comaError" class="error-message"></p>
    </section>

    <!-- 4. Stroke Triage Assistant -->
    <section id="strokeModuleSection" class="container" style="display:none;">
      <h2>Stroke Triage Assistant</h2>
      <form id="triage-form">
        <div class="input-grid">
          <div class="input-group"><label for="gfap_value">GFAP Value (pg/mL)</label><input type="number" id="gfap_value" required></div>
          <div class="input-group"><label for="age_years">Age (years)</label><input type="number" id="age_years" required></div>
          <div class="input-group"><label for="systolic_bp">Systolic BP</label><input type="number" id="systolic_bp" required></div>
          <div class="input-group"><label for="diastolic_bp">Diastolic BP</label><input type="number" id="diastolic_bp" required></div>
          <div class="input-group">
            <label for="fast_ed_score">FAST-ED Score</label>
            <div style="display:flex;align-items:center;gap:10px;">
              <input type="number" id="fast_ed_score" min="0" max="9" required>
              <button type="button" class="secondary" id="open-fast-ed-modal-btn">Calc</button>
            </div>
          </div>
          <div class="checkbox-group"><label><input type="checkbox" id="headache"> Headache</label></div>
          <div class="checkbox-group"><label><input type="checkbox" id="eye_deviation"> Eye Deviation</label></div>
          <div class="checkbox-group"><label><input type="checkbox" id="armparese"> Arm Paresis</label></div>
          <div class="checkbox-group"><label><input type="checkbox" id="beinparese"> Leg Paresis</label></div>
          <div class="checkbox-group"><label><input type="checkbox" id="atrial_fibrillation"> Atrial Fibrillation</label></div>
          <div class="checkbox-group"><label><input type="checkbox" id="antiplatelets"> On Antiplatelets</label></div>
          <div class="checkbox-group"><label><input type="checkbox" id="vigilanzminderung"> Vigilance Reduction</label></div>
          <div class="checkbox-group"><label><input type="checkbox" id="antcoagulated_noak"> On NOAK</label></div>
        </div>
        <button type="submit" id="calculate-btn" class="primary">Analyze Stroke Probability</button>
      </form>
      <p id="strokeError" class="error-message"></p>
      <div id="results-area" style="display:none;">
        <div id="triage-recommendation"></div>
        <div style="text-align:center;">
          <button id="analysis-toggle">View Detailed Analysis</button>
        </div>
        <div id="analysis-details">
          <div class="probabilities">
            <div class="prob-panel" id="ich-prob-panel"></div>
            <div class="prob-panel" id="lvo-prob-panel"></div>
          </div>
          <h3 class="drivers-title">Prediction Drivers</h3>
          <div class="drivers-container">
            <div class="drivers-panel" id="ich-drivers-panel"></div>
            <div class="drivers-panel" id="lvo-drivers-panel"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- FAST-ED Calculator Modal -->
    <div class="modal-overlay" id="fast-ed-modal-overlay">
      <div class="modal" id="fast-ed-modal">
        <h3>FAST-ED Calculator</h3>
        <div class="input-group"><label for="fast-ed-face">Facial Palsy</label>
          <select id="fast-ed-face"><option value="0">Normal symmetry</option><option value="1">Minor paralysis</option><option value="2">Complete paralysis</option></select>
        </div>
        <div class="input-group"><label for="fast-ed-arm">Arm Weakness</label>
          <select id="fast-ed-arm"><option value="0">No drift</option><option value="1">Drifts down</option><option value="2">Falls rapidly</option></select>
        </div>
        <div class="input-group"><label for="fast-ed-speech">Speech Changes</label>
          <select id="fast-ed-speech"><option value="0">Normal</option><option value="1">Mild-moderate dysarthria/aphasia</option><option value="2">Severe aphasia / mute</option></select>
        </div>
        <div class="input-group"><label for="fast-ed-eyes">Eye Deviation</label>
          <select id="fast-ed-eyes"><option value="0">Absent</<select id="fast-ed-eyes">
            <option value="0">Absent</option>
            <option value="1">Present</option>
          </select>
        </div>
        <div class="input-group"><label for="fast-ed-denial">Denial / Neglect (Anosognosia)</label>
          <select id="fast-ed-denial">
            <option value="0">Absent</option>
            <option value="1">Present</option>
          </select>
        </div>
        <button type="button" class="primary" id="apply-fast-ed-score-btn" style="margin-top: 18px;">Apply Score</button>
        <button type="button" class="secondary" id="close-fast-ed-modal-btn" style="margin-top: 10px;">Cancel</button>
      </div>
    </div>

    <!-- Disclaimer Modal -->
    <div class="modal-overlay" id="disclaimer-modal">
      <div class="modal">
        <h3>Disclaimer</h3>
        <p>The calculations are for research purposes only; do not make clinical decisions based on them.</p>
        <button class="primary" id="confirm-disclaimer-btn">Confirm</button>
      </div>
    </div>
  </main>

  <footer style="text-align:center; margin-top:20px; padding-bottom: 20px;">
    <p>¬© <span id="currentYear"></span> iGFAP. All rights reserved.</p>
  </footer>

  <script>
    // ---- PAGE ELEMENTS ----
    const dom = {
      sections: {
        access: document.getElementById('accessCodeSection'),
        modules: document.getElementById('moduleSelectionSection'),
        coma: document.getElementById('comaModuleSection'),
        stroke: document.getElementById('strokeModuleSection')
      },
      accessCode: document.getElementById('accessCodeInput'),
      accessCodeBtn: document.getElementById('accessCodeButton'),
      accessError: document.getElementById('accessError'),
      moduleComaBtn: document.getElementById('comaModuleBtn'),
      moduleStrokeBtn: document.getElementById('strokeModuleBtn'),
      comaForm: document.getElementById('comaForm'),
      comaInput: document.getElementById('gfapComaInput'),
      comaCalcBtn: document.getElementById('calculateComaButton'),
      comaBackBtn: document.getElementById('comaBackButton'),
      comaResult: document.getElementById('comaResult'),
      comaError: document.getElementById('comaError'),
      strokeForm: document.getElementById('triage-form'),
      strokeError: document.getElementById('strokeError'),
      resultsArea: document.getElementById('results-area'),
      triageRec: document.getElementById('triage-recommendation'),
      analysisToggle: document.getElementById('analysis-toggle'),
      analysisDetails: document.getElementById('analysis-details'),
      ichProbPanel: document.getElementById('ich-prob-panel'),
      lvoProbPanel: document.getElementById('lvo-prob-panel'),
      ichDriversPanel: document.getElementById('ich-drivers-panel'),
      lvoDriversPanel: document.getElementById('lvo-drivers-panel'),
      fastEdModalOverlay: document.getElementById('fast-ed-modal-overlay'),
      fastEdModal: document.getElementById('fast-ed-modal'),
      openFastEdBtn: document.getElementById('open-fast-ed-modal-btn'),
      applyFastEdBtn: document.getElementById('apply-fast-ed-score-btn'),
      closeFastEdModalBtn: document.getElementById('close-fast-ed-modal-btn'),
      darkModeToggle: document.getElementById('darkModeToggle'),
      disclaimerModal: document.getElementById('disclaimer-modal'),
      confirmDisclaimerBtn: document.getElementById('confirm-disclaimer-btn'),
    };

    document.getElementById('currentYear').textContent = new Date().getFullYear();

    // ---- PAGE NAVIGATION ----
    function showSection(which) {
      for (let key in dom.sections) dom.sections[key].style.display = 'none';
      dom.sections[which].style.display = '';
      window.scrollTo(0,0);
    }

    // ---- DARK MODE ----
    dom.darkModeToggle.addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark-mode');
      dom.darkModeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
    });
    // Restore user‚Äôs previous theme:
    (function(){
      const savedTheme = localStorage.getItem('darkMode');
      if (savedTheme === 'enabled' || (savedTheme === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.body.classList.add('dark-mode');
        dom.darkModeToggle.textContent = '‚òÄÔ∏è';
      }
    })();

    // ---- ACCESS CODE LOGIC ----
    dom.accessCodeBtn.addEventListener('click', async () => {
      dom.accessError.style.display = 'none';
      const code = dom.accessCode.value.trim();
      if (!code) {
        dom.accessError.textContent = 'Please enter a code.'; dom.accessError.style.display = '';
        return;
      }
      dom.accessCodeBtn.disabled = true;
      try {
        // ---- BACKEND VALIDATION ----
        const resp = await fetch('https://europe-west3-igfap-452720.cloudfunctions.net/validateAccessCode', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });
        if (resp.ok) {
          const data = await resp.json();
          if (data.valid) { showSection('modules'); }
          else { dom.accessError.textContent = 'Invalid access code.'; dom.accessError.style.display = ''; }
        } else {
          dom.accessError.textContent = 'A server error occurred.'; dom.accessError.style.display = '';
        }
      } catch (err) {
        dom.accessError.textContent = 'Network error.'; dom.accessError.style.display = '';
      } finally {
        dom.accessCodeBtn.disabled = false;
      }
    });

    // ---- MODULE NAVIGATION ----
    dom.moduleComaBtn.addEventListener('click', ()=> showSection('coma'));
    dom.moduleStrokeBtn.addEventListener('click', ()=> showSection('stroke'));
    dom.comaBackBtn.addEventListener('click', ()=> showSection('modules'));

    // ---- DISCLAIMER MODAL ----
    function requestDisclaimer() {
      return new Promise(resolve => {
        dom.disclaimerModal.classList.add('visible');
        dom.confirmDisclaimerBtn.onclick = function() {
          dom.disclaimerModal.classList.remove('visible');
          resolve();
        };
      });
    }

    // ---- COMA MODULE LOGIC ----
    dom.comaForm.addEventListener('submit', async e => {
      e.preventDefault();
      dom.comaError.style.display = 'none'; dom.comaResult.style.display = 'none';
      const value = parseFloat(dom.comaInput.value);
      if (isNaN(value) || value < parseInt(dom.comaInput.min) || value > parseInt(dom.comaInput.max)) {
        dom.comaError.textContent = 'Please enter a valid GFAP value (29‚Äì10001).'; dom.comaError.style.display = '';
        return;
      }
      await requestDisclaimer();
      dom.comaCalcBtn.disabled = true;
      try {
        // ---- BACKEND CALL ----
        const resp = await fetch('https://europe-west3-igfap-452720.cloudfunctions.net/calculateComaRisk', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gfap: value })
        });
        if (resp.ok) {
          const data = await resp.json();
          dom.comaResult.innerHTML = `<strong>Probability of ICH: ${(data.probability*100).toFixed(1)}%</strong>`;
          dom.comaResult.style.display = '';
        } else {
          dom.comaError.textContent = 'A server error occurred.'; dom.comaError.style.display = '';
        }
      } catch (err) {
        dom.comaError.textContent = 'Network error.'; dom.comaError.style.display = '';
      } finally {
        dom.comaCalcBtn.disabled = false;
      }
    });

    // ---- FAST-ED CALCULATOR MODAL LOGIC ----
    dom.openFastEdBtn.addEventListener('click', ()=> dom.fastEdModalOverlay.classList.add('visible'));
    dom.closeFastEdModalBtn.addEventListener('click', ()=> dom.fastEdModalOverlay.classList.remove('visible'));
    dom.applyFastEdBtn.addEventListener('click', () => {
      // Calculate FAST-ED total
      const face = parseInt(document.getElementById('fast-ed-face').value)||0;
      const arm = parseInt(document.getElementById('fast-ed-arm').value)||0;
      const speech = parseInt(document.getElementById('fast-ed-speech').value)||0;
      const eyes = parseInt(document.getElementById('fast-ed-eyes').value)||0;
      const denial = parseInt(document.getElementById('fast-ed-denial').value)||0;
      const total = face + arm + speech + eyes + denial;
      document.getElementById('fast_ed_score').value = total;
      // Sync arm/eye to checkboxes:
      document.getElementById('armparese').checked = (arm > 0);
      document.getElementById('eye_deviation').checked = (eyes > 0);
      dom.fastEdModalOverlay.classList.remove('visible');
    });

    // ---- STROKE TRIAGE LOGIC ----
    dom.strokeForm.addEventListener('submit', async function(e){
      e.preventDefault();
      dom.strokeError.style.display = 'none'; dom.resultsArea.style.display = 'none';
      // Gather input
      const ids = ['gfap_value','age_years','systolic_bp','diastolic_bp','fast_ed_score','headache','eye_deviation','armparese','beinparese','atrial_fibrillation','antiplatelets','vigilanzminderung','antcoagulated_noak'];
      const data = {};
      let valid = true;
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === 'checkbox') data[id] = el.checked ? 1 : 0;
        else {
          const v = parseFloat(el.value);
          if (el.required && isNaN(v)) valid = false;
          data[id] = v;
        }
      });
      if (!valid) {
        dom.strokeError.textContent = 'Please fill all required fields with valid numbers.'; dom.strokeError.style.display = '';
        return;
      }
      await requestDisclaimer();
      dom.strokeForm.querySelector('button[type="submit"]').disabled = true;
      try {
        // ICH calculation (local, same as before)
        const model = {
          INTERCEPT: -0.72549447,
          COEFFICIENTS: {'gfap_value': 0.98845868, 'age_years': -0.20927375, 'systolic_bp': 0.36337294, 'headache': 0.43796113, 'eye_deviation': -0.26763354, 'armparese': 0.11730522, 'beinparese': 0.42467409, 'atrial_fibrillation': -0.24686695, 'antiplatelets': -0.52928134 },
          SCALER_PARAMS: {'gfap_value': { center: 3.78418963, scale: 0.98704051 }, 'age_years': { center: 78.0, scale: 18.0 }, 'systolic_bp': { center: 160.0, scale: 41.5 } },
          CALIBRATION: { A: 1.15, B: -0.20 }
        };
        // Logistic regression calculation
        const ichInputs = {...data, gfap_value: Math.log1p(data.gfap_value)};
        let logOdds = model.INTERCEPT;
        const impacts = {};
        for (const [feature, coef] of Object.entries(model.COEFFICIENTS)) {
          let value = ichInputs[feature];
          if (model.SCALER_PARAMS[feature]) {
            const s = model.SCALER_PARAMS[feature];
            value = (value - s.center) / s.scale;
          }
          impacts[feature] = value * coef;
          logOdds += value * coef;
        }
        const calibrated = model.CALIBRATION.A * logOdds + model.CALIBRATION.B;
        const ichProb = 1 / (1 + Math.exp(-calibrated));
        // LVO prediction (backend)
        let lvoProb = null, lvoImpacts = null;
        try {
          const fetchOptions = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) };
          const [predRes, explRes] = await Promise.all([
            fetch('https://lvo-ppv-service-564499947017.europe-west3.run.app/predict', fetchOptions),
            fetch('https://lvo-ppv-service-564499947017.europe-west3.run.app/explain', fetchOptions)
          ]);
          if (predRes.ok && explRes.ok) {
            const pred = await predRes.json();
            const expl = await explRes.json();
            lvoProb = pred.lvo_probability;
            lvoImpacts = expl.feature_impacts;
          }
        } catch(e){}
        // TRIAGE
        let type = "unclear";
        if (lvoProb === null) type = "error";
        else {
          if (lvoProb > 0.6 && lvoProb > ichProb * 2) type = "lvo";
          else if (ichProb > 0.5 && ichProb > lvoProb * 2) type = "ich";
          else if (ichProb < 0.2 && lvoProb < 0.2) type = "mimic";
        }
        // RENDER
        const triageText = {
          lvo: { title: "LVO LIKELY", rec: "Proceed directly to the nearest LVO-capable Comprehensive Stroke Center." },
          ich: { title: "STRONG SUSPICION OF ICH", rec: "Proceed to the nearest center with neurosurgical capabilities. Thrombectomy not indicated." },
          mimic: { title: "ICH & LVO UNLIKELY", rec: "Re-evaluate for Stroke Mimics (e.g., seizure, migraine, hypoglycemia). Proceed to nearest appropriate facility." },
          unclear: { title: "UNCLEAR STROKE TYPE", rec: "LVO cannot be ruled out. Default to LVO protocol: proceed to LVO-capable center if feasible." },
          error: { title: "LVO DATA UNAVAILABLE", rec: "Could not retrieve LVO data. ICH analysis is shown below. Proceed based on clinical judgment." }
        };
        const icons = {
          lvo: 'üß†<span style="color:var(--lvo-border)">‚ö°Ô∏è</span>',
          ich: 'üß†<span style="color:var(--ich-border)">ü©∏</span>',
          unclear: 'üß†‚ùì', mimic: 'üë©‚Äç‚öïÔ∏èü©∫', error: 'üì°‚ö†Ô∏è'
        };
        dom.triageRec.innerHTML =
          `<div class="triage-card ${type}">
            <div class="icon">${icons[type]}</div>
            <h3>${triageText[type].title}</h3>
            <p>${triageText[type].rec}</p>
          </div>`;
        // Probability panels
        dom.ichProbPanel.innerHTML = `<h4>ICH Details</h4>
          <div class="probability-meter-container">
            <div class="probability-meter-marker" style="left:calc(${(ichProb*100).toFixed(0)}% - 3px);"></div>
            <span class="probability-meter-label" style="left:${(ichProb*100).toFixed(0)}%;">${(ichProb*100).toFixed(1)}%</span>
          </div>`;
        dom.lvoProbPanel.innerHTML = (lvoProb===null) ? `<h4>LVO Details</h4><p>Data unavailable.</p>` :
          `<h4>LVO Details</h4>
            <div class="probability-meter-container">
              <div class="probability-meter-marker" style="left:calc(${(lvoProb*100).toFixed(0)}% - 3px);"></div>
              <span class="probability-meter-label" style="left:${(lvoProb*100).toFixed(0)}%;">${(lvoProb*100).toFixed(1)}%</span>
            </div>`;
        // Drivers panels
        dom.ichDriversPanel.innerHTML = renderDriversPanel(impacts, 'ICH');
        dom.lvoDriversPanel.innerHTML = renderDriversPanel(lvoImpacts, 'LVO');
        // Show results
        dom.resultsArea.style.display = '';
        dom.resultsArea.scrollIntoView({behavior:"smooth",block:"start"});
        dom.analysisDetails.classList.remove('expanded');
        dom.analysisToggle.textContent = 'View Detailed Analysis';
      } catch(err) {
        dom.strokeError.textContent = 'A server or network error occurred.'; dom.strokeError.style.display = '';
      } finally {
        dom.strokeForm.querySelector('button[type="submit"]').disabled = false;
      }
    });

    // --- ANALYSIS DETAILS TOGGLE ---
    dom.analysisToggle.addEventListener('click', function() {
      const d = dom.analysisDetails;
      d.classList.toggle('expanded');
      dom.analysisToggle.textContent = d.classList.contains('expanded') ? 'Hide Detailed Analysis' : 'View Detailed Analysis';
    });

    // --- DRIVER PANEL RENDER ---
    function renderDriversPanel(impacts, label) {
      if (!impacts) return `<h4>${label} Drivers</h4><p>Data unavailable.</p>`;
      const sorted = Object.entries(impacts).filter(([k,v])=>Math.abs(v)>0.01).sort((a,b)=>Math.abs(b[1])-Math.abs(a[1]));
      const maxAbs = sorted.length>0 ? Math.abs(sorted[0][1]) : 0;
      let posHTML = '', negHTML = '';
      sorted.forEach(([key,val])=>{
        const barWidth= (maxAbs > 0) ? (Math.abs(val) / maxAbs) * 100 : 0;
        const fieldName = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        const itemHTML = `<div class="driver-item">
            <span class="driver-label">${fieldName}</span>
            <div class="driver-bar-container">
                <div class="driver-bar ${val >= 0 ? 'positive' : 'negative'}" style="width: ${barWidth}%;"></div>
            </div>
          </div>`;
        if (val >= 0) posHTML += itemHTML;
        else negHTML += itemHTML;
      });
      return `<h4>${label} Drivers</h4>
        <div class="drivers-columns">
          <div class="driver-column"><h5>Increasing Risk</h5><div>${posHTML || '<p style="text-align:center;font-size:0.9em;opacity:0.7;">None</p>'}</div></div>
          <div class="driver-column"><h5>Decreasing Risk</h5><div>${negHTML || '<p style="text-align:center;font-size:0.9em;opacity:0.7;">None</p>'}</div></div>
        </div>`;
    }

    // ---- LANGUAGE SWITCH (stub, simple) ----
    function switchLanguage(lang) {
      // For full localization, expand here.
      document.documentElement.lang = lang;
      // Example: update UI labels if multi-language is required.
    }

    // ---- CLOSE MODALS WHEN CLICKING OUTSIDE ----
    [dom.fastEdModalOverlay, dom.disclaimerModal].forEach(modal => {
      modal.addEventListener('click', function(e){
        if (e.target === modal) modal.classList.remove('visible');
      });
    });

    // ---- ENTER KEY ACCESS CODE SUBMIT ----
    dom.accessCode.addEventListener('keydown', e=>{
      if (e.key==='Enter') dom.accessCodeBtn.click();
    });

    // ---- STARTUP: show access code section only ----
    showSection('access');

  </script>
</body>
</html>