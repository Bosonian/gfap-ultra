<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iGFAP Check</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#007bff" />

  <link rel="icon" href="icon-192.png" sizes="192x192" type="image/png" />
  <link rel="icon" href="icon-512.png" sizes="512x512" type="image/png" />

  <style>
    :root {
        --primary-color: #007bff; --primary-hover: #0056b3; --background-color: #f4f7f9;
        --container-bg: #ffffff; --text-color: #333; --border-color: #dee2e6; --input-bg: #f8f9fa;
        
        /* Triage Card Colors */
        --lvo-bg: #e1f5fe; --lvo-text: #01579b; --lvo-border: #0288d1;
        --ich-bg: #fbe9e7; --ich-text: #b71c1c; --ich-border: #d84315;
        --unclear-bg: #fffde7; --unclear-text: #f57f17; --unclear-border: #fbc02d;
        --mimic-bg: #e8f5e9; --mimic-text: #1b5e20; --mimic-border: #388e3c;
        
        --driver-positive-bg: #e74c3c; --driver-negative-bg: #3498db;
        --meter-green: #28a745; --meter-yellow: #ffc107; --meter-red: #dc3545;
    }

    body.dark-mode {
        --primary-color: #409eff; --primary-hover: #3a8ee6; --background-color: #121212;
        --container-bg: #1e1e1e; --text-color: #f1f1f1; --border-color: #444; --input-bg: #2a2a2a;

        --lvo-bg: #1a3a5b; --lvo-text: #b3e5fc; --lvo-border: #4fc3f7;
        --ich-bg: #5c2a30; --ich-text: #ffcdd2; --ich-border: #ff8a65;
        --unclear-bg: #4d442a; --unclear-text: #fff59d; --unclear-border: #ffee58;
        --mimic-bg: #2a5032; --mimic-text: #c8e6c9; --mimic-border: #81c784;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
        margin: 0; 
        padding: 80px 15px 40px; 
        background-color: var(--background-color); 
        color: var(--text-color); 
        transition: background-color 0.3s ease, color 0.3s ease; 
    }

    .container { 
        max-width: 750px; 
        margin: 20px auto; 
        padding: 25px; 
        background-color: var(--container-bg); 
        border-radius: 12px; 
        box-shadow: 0 6px 20px rgba(0,0,0,0.1); 
        border: 1px solid var(--border-color); 
        transition: background-color 0.3s, border-color 0.3s;
    }
    
    .hidden { display: none !important; }

    /* --- Header --- */
    .app-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 10px 25px; 
        background-color: var(--container-bg); 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        position: fixed; 
        top: 0; left: 0; right: 0; 
        z-index: 1000; 
        border-bottom: 1px solid var(--border-color); 
        transition: background-color 0.3s, border-color 0.3s, color 0.3s; 
    }
    .app-header h1 { font-size: 1.4em; margin: 0; color: var(--primary-color); }
    .header-right { display: flex; align-items: center; gap: 15px; }
    .language-switcher button { background: none; border: none; padding: 5px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
    .language-switcher button:hover { opacity: 1; }
    .language-switcher img { width: 24px; height: 16px; border-radius: 3px; vertical-align: middle; }
    #darkModeToggle { background: none; border: none; color: var(--text-color); font-size: 1.5rem; line-height: 1; cursor: pointer; padding: 8px; }
    .home-button { background: none; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    
    /* --- Form Elements --- */
    h2 { text-align: center; margin-bottom: 25px; }
    .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .input-group, .checkbox-group { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--input-bg); }
    .checkbox-group label { display: flex; align-items: center; cursor: pointer; font-weight: normal; height: 100%;}
    input[type="checkbox"] { width: 1.3em; height: 1.3em; margin-right: 12px; accent-color: var(--primary-color); }
    label { display: block; margin-bottom: 6px; font-weight: bold; }
    input[type="number"], input[type="password"], select { width: 100%; padding: 10px; font-size: 16px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--container-bg); color: var(--text-color); transition: border-color 0.2s, background-color 0.3s, color 0.3s; }
    input:focus, select:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 25%, transparent); }
    button.primary, button.secondary { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; transition: background-color 0.3s ease; font-weight: bold; }
    button.primary { background-color: var(--primary-color); color: white; width: 100%; margin-top: 25px; font-size: 1.1em;}
    button.secondary { background: none; border: 1px solid var(--primary-color); color: var(--primary-color); }
    button.primary:hover:not(:disabled) { background-color: var(--primary-hover); }
    button.primary:disabled { background-color: #a0a0a0; cursor: wait; }
    
    .score-display { display: flex; align-items: center; justify-content: space-between; background-color: color-mix(in srgb, var(--input-bg) 50%, var(--background-color)); grid-column: 1 / -1; }
    .score-value { font-size: 1.8em; font-weight: bold; color: var(--primary-color); }

    /* --- Results --- */
    .result { margin-top: 20px; padding: 15px; border-radius: 8px; background-color: var(--input-bg); }
    #results-area { display: none; margin-top: 30px; }
    #analysis-details { margin-top: 25px; } /* Always visible now */
    .triage-card { padding: 20px; border-radius: 12px; border-left: 8px solid; text-align: center; }
    .triage-card .icon { font-size: 2.5rem; margin-bottom: 10px; }
    .triage-card h3 { margin: 0 0 10px 0; font-size: 1.5em; }
    .triage-card p { margin: 0; font-size: 1.1em; }
    .triage-card.lvo { background-color: var(--lvo-bg); color: var(--lvo-text); border-left-color: var(--lvo-border); }
    .triage-card.ich { background-color: var(--ich-bg); color: var(--ich-text); border-left-color: var(--ich-border); }
    .triage-card.unclear { background-color: var(--unclear-bg); color: var(--unclear-text); border-left-color: var(--unclear-border); }
    .triage-card.mimic { background-color: var(--mimic-bg); color: var(--mimic-text); border-left-color: var(--mimic-border); }
    .triage-card.no_lvo { background-color: var(--mimic-bg); color: var(--mimic-text); border-left-color: var(--mimic-border); }
    .probabilities { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 25px; }
    .prob-panel { flex: 1; min-width: 250px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; }
    .prob-panel h4 { margin: 0 0 15px 0; text-align: center; }
    .probability-meter-container { width: 100%; height: 20px; background: linear-gradient(to right, var(--meter-green) 25%, var(--meter-yellow) 50%, var(--meter-red) 100%); border-radius: 10px; position: relative; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
    .probability-meter-marker { position: absolute; top: -3px; bottom: -3px; width: 6px; background-color: var(--text-color); border: 2px solid var(--container-bg); border-radius: 3px; box-shadow: 0 0 5px rgba(0,0,0,0.5); transition: left 0.5s ease-out; }
    .probability-meter-label { position: absolute; top: 100%; transform: translateX(-50%); font-size: 1em; font-weight: bold; padding-top: 5px; }
    .drivers-title { text-align: center; margin: 30px 0 15px; font-size: 1.3em; }
    .drivers-container { display: flex; gap: 25px; flex-wrap: wrap; }
    .drivers-panel { flex: 1; min-width: 300px; }
    .drivers-panel h4 { text-align: center; margin-bottom: 15px; }
    .drivers-columns { display: flex; gap: 15px; }
    .driver-column { flex: 1; min-width: 0; }
    .driver-column h5 { margin: 0 0 10px 0; text-align: center; font-size: 0.9em; opacity: 0.8; }
    .driver-item { display: flex; align-items: center; margin-bottom: 8px; gap: 8px; }
    .driver-label { flex-shrink: 0; width: 45%; text-align: right; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; }
    .driver-bar-container { flex-grow: 1; height: 16px; background-color: color-mix(in srgb, var(--border-color) 50%, transparent); border-radius: 5px; overflow: hidden; }
    .driver-bar { height: 100%; border-radius: 5px; transition: width 0.5s ease-out; width: 0; }
    .driver-bar.positive { background-color: var(--driver-positive-bg); }
    .driver-bar.negative { background-color: var(--driver-negative-bg); }
    .error-message { color: var(--ich-text); background-color: var(--ich-bg); padding: 12px; border: 1px solid var(--ich-border); border-radius: 6px; display: none; margin-top: 20px; text-align: center; }

    /* --- Modal Styles --- */
    .modal-overlay { 
        position: fixed; 
        top: 0; left: 0; 
        width: 100%; height: 100%; 
        background: rgba(0,0,0,0.7); 
        z-index: 2000; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        padding: 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }
    .modal-overlay.visible {
        opacity: 1;
        pointer-events: auto;
    }
    .modal-content {
        background: var(--container-bg);
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-content p {
        margin: 0 0 20px 0;
    }
  </style>
</head>

<body>
  <header class="app-header">
    <h1 id="appTitle" data-translate="appTitle">iGFAP Check</h1>
    <div class="header-right">
       <div class="language-switcher">
           <button onclick="switchLanguage('en')" aria-label="Switch to English"><img src="https://flagcdn.com/gb.svg" alt="English Flag"></button>
           <button onclick="switchLanguage('de')" aria-label="Switch to German"><img src="https://flagcdn.com/de.svg" alt="German Flag"></button>
       </div>
      <button id="darkModeToggle" aria-label="Toggle dark mode">üåô</button>
      <button class="home-button" id="homeButton"><span data-translate="homeButton">üè† Home</span></button>
    </div>
  </header>

  <section id="codeEntrySection" class="container">
    <p data-translate="accessPrompt">üîë Please enter your access code:</p>
    <div class="input-group">
      <input type="password" id="accessCodeInput"/>
    </div>
    <button class="primary" id="accessCodeButton"><span data-translate="submitButton">Submit</span></button>
    <p id="accessError" class="error-message hidden" style="margin-top:15px;"></p>
  </section>

  <section id="moduleSelectionSection" class="container hidden">
    <h2 data-translate="moduleSelectionTitle">Check probability for:</h2>
    <button class="primary" id="comaModuleButton" style="margin-bottom: 15px;">
      <span data-translate="comaModuleButtonText">Intracranial hemorrhage in comatose patients (GCS 3-8)</span>
    </button>
    <button class="primary" id="strokeModuleButton">
      <span data-translate="strokeModuleButtonText">Intracerebral hemorrhage in patients with stroke symptoms (Unified Model)</span>
    </button>
  </section>

  <section id="comaModuleSection" class="container hidden">
    <h2 data-translate="comaModuleTitle">Intracranial hemorrhage in comatose patients (GCS 3-8)</h2>
    <div class="input-group">
      <label for="gfapComaInput" data-translate="gfapComaLabel">GFAP Value (pg/mL)</label>
      <input type="number" id="gfapComaInput" min="29" max="10001" placeholder="" />
    </div>
    <p id="comaError" class="error-message hidden"></p>
    <button class="primary" id="calculateComaButton"><span data-translate="calculateComaButton">Calculate Probability</span></button>
    <button class="secondary" id="comaBackButton" style="width: 100%; margin-top: 15px;"><span data-translate="backButton">‚¨ÖÔ∏è Back</span></button>
    <div class="result hidden" id="comaResult" aria-live="polite"></div>
  </section>

  <section id="unifiedStrokeModuleSection" class="hidden">
    <main class="container">
        <h2 data-translate="formTitle">Patient Data Entry</h2>
        <form id="triage-form">
            <div class="input-grid">
                <div class="input-group"><label for="gfap_value" data-translate="gfapLabel">GFAP Value (pg/mL)</label><input type="number" id="gfap_value" required></div>
                <div class="input-group"><label for="age_years" data-translate="ageLabel">Age (years)</label><input type="number" id="age_years" required></div>
                <div class="input-group"><label for="systolic_bp" data-translate="sbpLabel">Systolic BP</label><input type="number" id="systolic_bp" required></div>
                <div class="input-group"><label for="diastolic_bp" data-translate="dbpLabel">Diastolic BP</label><input type="number" id="diastolic_bp" required></div>
                
                <div class="checkbox-group"><label><input type="checkbox" id="headache"><span data-translate="headacheLabel">Headache</span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="beinparese"><span data-translate="beinpareseLabel">Leg Paresis</span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="atrial_fibrillation"><span data-translate="afibLabel">Atrial Fibrillation</span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="antiplatelets"><span data-translate="antiplateletsLabel">On Antiplatelets</span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="vigilanzminderung"><span data-translate="vigilanceLabel">Vigilance Reduction</span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="antcoagulated_noak"><span data-translate="noakLabel">On NOAK</span></label></div>

                <div class="input-group fast-ed-component"><label for="fast_ed_face" data-translate="fastEdFace">Facial Palsy</label><select id="fast_ed_face" required><option value="0" data-translate="fastEdFace0">Normal symmetry</option><option value="1" data-translate="fastEdFace1">Minor paralysis</option></select></div>
                <div class="input-group fast-ed-component"><label for="fast_ed_arm" data-translate="fastEdArm">Arm Weakness</label><select id="fast_ed_arm" required><option value="0" data-translate="fastEdArm0">No drift</option><option value="1" data-translate="fastEdArm1">Drifts down</option><option value="2" data-translate="fastEdArm2">Falls rapidly</option></select></div>
                <div class="input-group fast-ed-component"><label for="fast_ed_speech" data-translate="fastEdSpeech">Speech Changes</label><select id="fast_ed_speech" required><option value="0" data-translate="fastEdSpeech0">Normal</option><option value="1" data-translate="fastEdSpeech1">Mild-moderate</option><option value="2" data-translate="fastEdSpeech2">Severe / Mute</option></select></div>
                <div class="input-group fast-ed-component"><label for="fast_ed_eyes" data-translate="fastEdEyes">Eye Deviation</label><select id="fast_ed_eyes" required><option value="0" data-translate="fastEdEyes0">Absent</option><option value="1" data-translate="fastEdEyes1">Present</option></select></div>
                <div class="input-group fast-ed-component"><label for="fast_ed_denial" data-translate="fastEdDenial">Denial / Neglect</label><select id="fast_ed_denial" required><option value="0" data-translate="fastEdDenial0">Absent</option><option value="1" data-translate="fastEdDenial1">Present</option></select></div>

                <div class="input-group score-display">
                    <label data-translate="calculatedFastEdLabel">Calculated FAST-ED Score:</label>
                    <span id="fast-ed-score-display" class="score-value">0</span>
                </div>
            </div>

            <p id="error-message" class="error-message"></p>
            <button type="submit" id="calculate-btn" class="primary" data-translate="analyzeButton">Analyze Stroke Probability</button>
            <button type="button" class="secondary" id="strokeBackButton" style="width: 100%; margin-top: 15px;"><span data-translate="backButton">‚¨ÖÔ∏è Back</span></button>
        </form>
        
        <div id="results-area">
            <div id="triage-recommendation"></div>
            <div id="analysis-details">
                <div class="probabilities">
                    <div class="prob-panel" id="ich-prob-panel"></div>
                    <div class="prob-panel" id="lvo-prob-panel"></div>
                </div>
                <h3 class="drivers-title" data-translate="driversTitle">Prediction Drivers</h3>
                <div class="drivers-container">
                    <div class="drivers-panel" id="ich-drivers-panel"></div>
                    <div class="drivers-panel" id="lvo-drivers-panel"></div>
                </div>
            </div>
        </div>
    </main>
  </section>

  <footer style="text-align:center; margin-top:20px; padding-bottom: 20px;">
    <p>¬© <span id="currentYear"></span> iGFAP. All rights reserved.</p>
  </footer>

  <div id="disclaimerModal" class="modal-overlay">
    <div class="modal-content">
      <p class="disclaimer-text" data-translate="disclaimerText">
        The calculations are for research purposes only, do not make clinical decisions based on it.
      </p>
      <button class="primary" id="disclaimerConfirmButton">
        <span data-translate="confirmButton">Confirm</span>
      </button>
    </div>
  </div>

  <script>
    const translations = { /* Translations object as before */ };
    
    // Main Application Controller
    document.addEventListener('DOMContentLoaded', () => {
        const sections = {
            // disclaimer is now controlled by its own function
            access: document.getElementById('codeEntrySection'),
            moduleSelection: document.getElementById('moduleSelectionSection'),
            coma: document.getElementById('comaModuleSection'),
            unifiedStroke: document.getElementById('unifiedStrokeModuleSection')
        };
        const buttons = {
            disclaimerConfirm: document.getElementById('disclaimerConfirmButton'),
            accessCode: document.getElementById('accessCodeButton'),
            // ... other buttons
        };
        const errors = { /* ... */ };
        let isUnifiedModuleInitialized = false;

        // NEW: Reusable function to request user confirmation
        function requestDisclaimerConfirmation() {
            return new Promise(resolve => {
                const modal = document.getElementById('disclaimerModal');
                
                const handler = () => {
                    modal.classList.remove('visible');
                    buttons.disclaimerConfirm.removeEventListener('click', handler);
                    resolve();
                };

                buttons.disclaimerConfirm.addEventListener('click', handler);
                
                modal.classList.add('visible');
            });
        }

        function showSection(sectionToShow) { /* ... */ }
        function hideErrors() { /* ... */ }
        window.switchLanguage = function(lang) { /* ... */ };
        
        // REMOVED: Initial disclaimer show logic

        buttons.accessCode.addEventListener('click', () => { /* ... */ });
        
        // ... navigation button listeners ...

        buttons.coma.addEventListener('click', () => showSection('coma'));
        buttons.stroke.addEventListener('click', () => {
            showSection('unifiedStroke');
            if (!isUnifiedModuleInitialized) {
                strokeModule.initialize();
                isUnifiedModuleInitialized = true;
            }
        });
        
        // UPDATED: Coma calculation now waits for disclaimer
        buttons.calculateComa.addEventListener('async click', async () => {
            hideErrors();
            await requestDisclaimerConfirmation(); // Wait for confirmation
            
            const input = document.getElementById('gfapComaInput');
            // ... rest of the validation and calculation logic
        });
        
        // ... page initialization ...
    });

    // Stroke Module Scope
    const strokeModule = (() => {
        // ... as before ...

        async function handleAnalyze(event) {
            event.preventDefault();

            await requestDisclaimerConfirmation(); // Wait for confirmation

            setLoading(true);
            // ... rest of the analysis logic
        }

        // ... rest of the stroke module functions ...
        
        return { initialize };
    })();
  </script>
  
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./sw.js")
          .then((reg) => console.log("Service Worker registered:", reg.scope))
          .catch((err) => console.error("SW registration failed:", err));
      });
    }
  </script>
</body>
</html>
