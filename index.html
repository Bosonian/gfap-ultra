<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ICH Prediction Tool</title>
  <style>
    :root {
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --background-color: #f8f9fa;
      --container-bg: #ffffff;
      --text-color: #333;
      --result-high-bg: #f8d7da;
      --result-high-text: #721c24;
      --result-high-border: #f5c6cb;
      --result-low-bg: #d4edda;
      --result-low-text: #155724;
      --result-low-border: #c3e6cb;
      --disclaimer-bg: #fff3cd;
      --disclaimer-text: #856404;
      --disclaimer-border: #ffeeba;
      --driver-positive-bg: #e74c3c;
      --driver-negative-bg: #3498db;
    }
    body.dark-mode {
      --background-color: #1e1e1e;
      --container-bg:   #2d2d2d;
      --text-color:     #f1f1f1;
      /* ‚Ä¶ other dark mode overrides ‚Ä¶ */
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0; padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .container {
      max-width: 650px;
      margin: 80px auto 20px;
      padding: 25px;
      background-color: var(--container-bg);
      border-radius: 12px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 25px;
      background: var(--container-bg);
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      border-bottom: 1px solid #ddd;
    }
    .app-header h1 { margin: 0; color: var(--primary-color); }
    .header-right { display: flex; gap: 10px; }
    .header-right button { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
    h2 { text-align: center; margin-bottom: 25px; }
    .disclaimer {
      padding: 15px; margin-bottom: 20px;
      border: 1px solid var(--disclaimer-border);
      background: var(--disclaimer-bg);
      color: var(--disclaimer-text);
      border-radius: 8px; text-align: center; font-size: 0.9em;
    }
    .input-group, .checkbox-group, .select-group {
      margin-bottom: 15px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: var(--container-bg);
    }
    .checkbox-group label { display: flex; align-items: center; cursor: pointer; }
    input[type="number"], select {
      width: 100%; padding: 12px; font-size: 16px;
      border: 1px solid #ccc; border-radius: 5px;
      background: var(--container-bg); color: var(--text-color);
      transition: border-color 0.2s;
    }
    button.primary {
      width: 100%; padding: 12px; margin-top: 15px;
      border: none; border-radius: 5px;
      background: var(--primary-color); color: #fff;
      font-size: 16px; font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button.primary:hover { background: var(--primary-hover); }

    .result {
      margin-top: 25px;
      padding: 20px;
      border: 1px solid;
      border-radius: 8px;
      text-align: center;
      display: none;
    }
    .result.high-risk {
      background: var(--result-high-bg);
      color: var(--result-high-text);
      border-color: var(--result-high-border);
    }
    .result.low-risk {
      background: var(--result-low-bg);
      color: var(--result-low-text);
      border-color: var(--result-low-border);
    }

    /* Omitted driver section CSS for brevity */
  </style>
</head>
<body>
  <header class="app-header">
    <h1 id="appTitle">iGFAP Check</h1>
    <div class="header-right">
      <div class="language-switcher">
        <button onclick="switchLanguage('en')"><img src="https://flagcdn.com/gb.svg" alt="EN"></button>
        <button onclick="switchLanguage('de')"><img src="https://flagcdn.com/de.svg" alt="DE"></button>
      </div>
      <button id="darkModeToggle">üåô</button>
    </div>
  </header>

  <main class="container" id="mainSection">
    <h2 id="strokeModuleTitle">Intracerebral Hemorrhage Prediction</h2>
    <div class="disclaimer">
      <strong id="disclaimerTitle">For Informational Purposes Only</strong>
      <p id="disclaimerText">This tool is not a substitute for professional medical advice.</p>
    </div>
    <form id="ich-form">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;">
        <div class="input-group">
          <label for="age_years" id="ageLabel">Age (years)</label>
          <input type="number" id="age_years" min="0" required>
        </div>
        <div class="input-group">
          <label for="systolic_bp" id="sbpLabel">Systolic BP (mmHg)</label>
          <input type="number" id="systolic_bp" min="0" required>
        </div>
        <div class="input-group">
          <label for="gfap_value" id="gfapLabel">GFAP Value (pg/mL)</label>
          <input type="number" id="gfap_value" min="0" required>
        </div>
        <div class="checkbox-group">
          <label><input type="checkbox" id="eye_deviation"><span id="eyeDeviationLabel">Eye Deviation?</span></label>
        </div>
        <div class="checkbox-group">
          <label><input type="checkbox" id="armparese"><span id="armpareseLabel">Arm Paresis?</span></label>
        </div>
        <div class="checkbox-group">
          <label><input type="checkbox" id="beinparese"><span id="beinpareseLabel">Leg Paresis?</span></label>
        </div>
        <div class="checkbox-group">
          <label><input type="checkbox" id="atrial_fibrillation"><span id="afibLabel">Atrial Fibrillation?</span></label>
        </div>
        <div class="checkbox-group">
          <label><input type="checkbox" id="antiplatelets"><span id="antiplateletsLabel">On Antiplatelets?</span></label>
        </div>
        <div class="select-group" style="grid-column:1/-1;">
          <label for="headache" id="headacheLabel">Headache?</label>
          <select id="headache">
            <option value="0" id="headacheNo">No</option>
            <option value="1" id="headacheYes">Yes</option>
            <option value="-1" id="headacheUnknown">Unknown</option>
          </select>
        </div>
      </div>
      <button type="button" id="calculate-btn" class="primary">Calculate</button>
    </form>

    <div class="result" id="result-container">
      <div class="result-label" id="result-title"></div>
      <div id="gauge-container" style="width:200px; margin:0 auto;"></div>
    </div>

    <section id="drivers-section" style="display:none;">
      <!-- driver bars as before -->
    </section>
  </main>

  <footer style="text-align:center; padding:20px; font-size:0.9em; opacity:0.7;">
    <p>¬© <span id="currentYear"></span> All rights reserved.</p>
  </footer>

  <script>
    // --- Piecewise calibration map exported from Python ---
    const X_MAP = [0.00,0.054,0.142,0.225,0.321,0.488,0.626,0.770,0.826,0.976,1.00];
    const Y_MAP = [0.00,0.036,0.042,0.286,0.500,1.000,1.000,1.000,1.000,1.000,1.00];
    const LOW_THRESH = 0.10;  // green‚Üíyellow
    const OP_THRESH  = 0.32;  // yellow‚Üíred

    // --- Model parameters (unchanged) ---
    const INTERCEPT = -0.72549447;
    const COEFFICIENTS = {
      age_years: -0.20927375,
      eye_deviation: -0.26763354,
      armparese: 0.11730522,
      beinparese: 0.42467409,
      atrial_fibrillation: -0.24686695,
      systolic_bp: 0.36337294,
      antiplatelets: -0.52928134,
      gfap_value: 0.98845868,
      headache: 0.43796113
    };
    const MEDIANS = { age_years:78, eye_deviation:0, armparese:1, beinparese:1,
                      atrial_fibrillation:0, systolic_bp:160,
                      antiplatelets:0, gfap_value:3.78418963, headache:0 };
    const IQRS = { age_years:18, eye_deviation:1, armparese:1, beinparese:1,
                   atrial_fibrillation:1, systolic_bp:41.5,
                   antiplatelets:1, gfap_value:0.98704051, headache:0.5 };
    const IMPUTED_HEADACHE = 0.0;

    // --- Helper: piecewise‚Äêlinear interpolation ---
    function calibratePiecewise(p) {
      if (p <= X_MAP[0]) return Y_MAP[0];
      if (p >= X_MAP[X_MAP.length-1]) return Y_MAP[Y_MAP.length-1];
      for (let i = 0; i < X_MAP.length-1; i++) {
        if (p >= X_MAP[i] && p <= X_MAP[i+1]) {
          const t = (p - X_MAP[i]) / (X_MAP[i+1] - X_MAP[i]);
          return Y_MAP[i] + t * (Y_MAP[i+1] - Y_MAP[i]);
        }
      }
      return p;
    }

    // --- Helper: draw SVG arc paths ---
    function describeArc(x,y,r,start,end) {
      const toRad = a => (a * Math.PI)/180;
      const sx = x + r * Math.cos(toRad(start));
      const sy = y + r * Math.sin(toRad(start));
      const ex = x + r * Math.cos(toRad(end));
      const ey = y + r * Math.sin(toRad(end));
      const laf = (end - start)<=180 ? 0 : 1;
      return `M${sx} ${sy}A${r} ${r} 0 ${laf} 0 ${ex} ${ey}`;
    }

    // --- Render the three‚Äëzone gauge ---
    function renderGauge(score) {
      const w=200, h=120, cx=w/2, cy=h, r=90;
      const deg = v => 180*(1-v);
      const svg = `
        <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
          <!-- green -->
          <path d="${describeArc(cx,cy,r,180,deg(LOW_THRESH))}"
                stroke="#4caf50" stroke-width="15" fill="none"/>
          <!-- yellow -->
          <path d="${describeArc(cx,cy,r,deg(LOW_THRESH),deg(OP_THRESH))}"
                stroke="#ffeb3b" stroke-width="15" fill="none"/>
          <!-- red -->
          <path d="${describeArc(cx,cy,r,deg(OP_THRESH),0)}"
                stroke="#f44336" stroke-width="15" fill="none"/>
          <!-- needle -->
          <line x1="${cx}" y1="${cy}"
                x2="${cx+(r-15)*Math.cos(Math.PI*(1-score))}"
                y2="${cy-(r-15)*Math.sin(Math.PI*(1-score))}"
                stroke="#333" stroke-width="3"/>
          <circle cx="${cx}" cy="${cy}" r="5" fill="#333"/>
        </svg>`;
      document.getElementById('gauge-container').innerHTML = svg;
    }

    // --- Compute & display prediction ---
    function calculateProbability() {
      const form = document.getElementById('ich-form');
      if (!form.checkValidity()) { form.reportValidity(); return; }

      // Gather inputs
      const inputs = {};
      ['age_years','systolic_bp','gfap_value'].forEach(id => {
        inputs[id] = parseFloat(document.getElementById(id).value);
      });
      ['eye_deviation','armparese','beinparese','atrial_fibrillation','antiplatelets']
        .forEach(id => {
          inputs[id] = document.getElementById(id).checked ? 1 : 0;
        });
      inputs.headache = parseFloat(document.getElementById('headache').value);
      if (inputs.headache === -1) inputs.headache = IMPUTED_HEADACHE;
      inputs.gfap_value = Math.log1p(inputs.gfap_value);

      // Scale & combine
      let logOdds = INTERCEPT;
      const contributions = {};
      for (let k in COEFFICIENTS) {
        const delta = IQRS[k] ? (inputs[k]-MEDIANS[k])/IQRS[k] : 0;
        const contrib = delta * COEFFICIENTS[k];
        contributions[k] = contrib;
        logOdds += contrib;
      }

      // Raw probability -> calibrated score
      const p_raw = 1/(1+Math.exp(-logOdds));
      const score = calibratePiecewise(p_raw);

      // Decide high/low risk on calibrated score
      const decision = score >= OP_THRESH ? 'high-risk' : 'low-risk';
      displayResults(score, decision);
      displayDrivers(contributions);
    }

    function displayResults(score, decision) {
      const c = document.getElementById('result-container');
      c.style.display = 'block';
      c.className = `result ${decision}`;
      const t = translations[currentLang];
      document.getElementById('result-title').textContent =
        decision==='high-risk' ? t.highRisk : t.lowRisk;
      renderGauge(score);
    }

    // ‚Ä¶ rest of your driver, dark‚Äëmode, translation code unchanged ‚Ä¶
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('currentYear').textContent = new Date().getFullYear();
      document.getElementById('calculate-btn').addEventListener('click', calculateProbability);
      // init dark mode, language‚Ä¶
    });
  </script>
</body>
</html>
