<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iGFAP Check</title>
    <style>
        :root {
            --primary-color: #007bff; --primary-hover: #0056b3; --background-color: #f4f7f9;
            --container-bg: #ffffff; --text-color: #333; --border-color: #dee2e6;
            --result-green-bg: #d4edda; --result-green-text: #155724; --result-green-border: #28a745;
            --result-amber-bg: #fff3cd; --result-amber-text: #856404; --result-amber-border: #ffc107;
            --result-red-bg: #f8d7da; --result-red-text: #721c24; --result-red-border: #dc3545;
            --driver-positive-bg: #e74c3c; --driver-negative-bg: #3498db;
            --meter-green: #28a745; --meter-yellow: #ffc107; --meter-red: #dc3545;
        }
        body.dark-mode {
            --primary-color: #409eff; --primary-hover: #3a8ee6; --background-color: #121212;
            --container-bg: #1e1e1e; --text-color: #f1f1f1; --border-color: #444;
            --result-green-bg: #2a5032; --result-green-text: #c3e6cb; --result-green-border: #2ecc71;
            --result-amber-bg: #4d442a; --result-amber-text: #ffeeba; --result-amber-border: #f1c40f;
            --result-red-bg: #5c2a30; --result-red-text: #f5c6cb; --result-red-border: #f56c6c;
            --driver-positive-bg: #c0392b; --driver-negative-bg: #2980b9;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 80px 15px 20px 15px; background-color: var(--background-color); color: var(--text-color); transition: background-color 0.3s ease, color 0.3s ease; }
        .container { max-width: 650px; margin: 0 auto; padding: 25px; background-color: var(--container-bg); border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); border: 1px solid var(--border-color); }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 25px; background-color: var(--container-bg); color: var(--text-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; border-bottom: 1px solid var(--border-color); }
        .app-header h1 { font-size: 1.4em; margin: 0; color: var(--primary-color); }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .language-switcher button { background: none; border: none; padding: 5px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
        .language-switcher button:hover { opacity: 1; }
        .language-switcher img { width: 24px; height: 16px; border-radius: 3px; }
        #darkModeToggle { background: none; border: none; color: var(--text-color); font-size: 1.5rem; line-height: 1; cursor: pointer; padding: 8px; }
        h2 { text-align: center; margin-bottom: 25px; }
        .disclaimer { padding: 15px; margin-bottom: 20px; border: 1px solid var(--result-low-border); background-color: var(--result-low-bg); color: var(--result-low-text); border-radius: 8px; text-align: center; font-size: 0.9em; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .input-group, .checkbox-group { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--background-color); }
        .checkbox-group label { display: flex; align-items: center; cursor: pointer; font-weight: bold; height: 100%;}
        input[type="checkbox"] { width: 1.3em; height: 1.3em; margin-right: 12px; accent-color: var(--primary-color); }
        label { display: block; margin-bottom: 6px; font-weight: bold; }
        input[type="number"] { width: 100%; padding: 10px; font-size: 16px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--container-bg); color: var(--text-color); transition: border-color 0.2s; }
        input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 25%, transparent); }
        button.primary { padding: 12px; margin-top: 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; width: 100%; font-weight: bold; background-color: var(--primary-color); color: white; }
        button.primary:hover { background-color: var(--primary-hover); }
        .result { margin-top: 25px; padding: 20px; border-radius: 8px; text-align: center; border-left: 5px solid; display: none; }
        .result.high-risk { background-color: var(--result-red-bg); color: var(--result-red-text); border-left-color: var(--result-red-border); }
        .result.medium-risk { background-color: var(--result-amber-bg); color: var(--result-amber-text); border-left-color: var(--result-amber-border); }
        .result.low-risk { background-color: var(--result-green-bg); color: var(--result-green-text); border-left-color: var(--result-green-border); }
        .probability-meter-container { width: 100%; height: 25px; /* THE FIX IS HERE: New 3-color gradient */ background: linear-gradient(to right, var(--meter-green) 25%, var(--meter-yellow) 50%, var(--meter-red) 100%); border-radius: 15px; position: relative; margin: 20px 0 30px 0; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
        .probability-meter-marker { position: absolute; top: -5px; bottom: -5px; width: 6px; background-color: var(--text-color); border-radius: 3px; box-shadow: 0 0 5px rgba(0,0,0,0.5); transition: left 0.5s ease-out; }
        .probability-meter-label { position: absolute; bottom: 100%; transform: translateX(-50%); font-size: 1.1em; font-weight: bold; padding-bottom: 5px; }
        #drivers-section { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color); display: none; }
        #drivers-section h3 { text-align: center; margin-bottom: 15px; }
        #drivers-columns { display: flex; gap: 20px; }
        .driver-column { flex: 1; min-width: 0; }
        .driver-column h4 { margin-top: 0; text-align: center; font-size: 1em; }
        .driver-item { display: flex; align-items: center; margin-bottom: 8px; gap: 8px; }
        .driver-label { flex-shrink: 0; width: 40%; text-align: right; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; }
        .driver-bar-container { flex-grow: 1; height: 18px; background-color: #eee; border-radius: 3px; }
        body.dark-mode .driver-bar-container { background-color: #555; }
        .driver-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease-out; }
        .driver-bar.positive { background-color: var(--driver-positive-bg); }
        .driver-bar.negative { background-color: var(--driver-negative-bg); }
    </style>
</head>
<body>

    <header class="app-header">
        <h1 data-translate="appTitle"></h1>
        <div class="header-right">
             <div class="language-switcher">
                <button onclick="switchLanguage('en')" aria-label="Switch to English"><img src="https://flagcdn.com/gb.svg" alt="English Flag"></button>
                <button onclick="switchLanguage('de')" aria-label="Switch to German"><img src="https://flagcdn.com/de.svg" alt="German Flag"></button>
            </div>
            <button id="darkModeToggle" aria-label="Toggle dark mode">🌙</button>
        </div>
    </header>

    <main id="mainSection" class="container">
        <h2 data-translate="strokeModuleTitle"></h2>
        <div class="disclaimer"><strong data-translate="disclaimerTitle"></strong><p data-translate="disclaimerText"></p></div>
        <form id="ich-form">
            <div class="input-grid">
                <div class="input-group"><label for="gfap_value" data-translate="gfapLabel"></label><input type="number" id="gfap_value" placeholder="e.g., 2875" required min="29" max="10001"></div>
                <div class="input-group"><label for="age_years" data-translate="ageLabel"></label><input type="number" id="age_years" placeholder="e.g., 75" required></div>
                <div class="input-group"><label for="systolic_bp" data-translate="sbpLabel"></label><input type="number" id="systolic_bp" placeholder="e.g., 160" required></div>
                <div class="checkbox-group"><label><input type="checkbox" id="headache"><span data-translate="headacheLabel"></span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="eye_deviation"><span data-translate="eyeDeviationLabel"></span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="armparese"><span data-translate="armpareseLabel"></span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="beinparese"><span data-translate="beinpareseLabel"></span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="atrial_fibrillation"><span data-translate="afibLabel"></span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="antiplatelets"><span data-translate="antiplateletsLabel"></span></label></div>
            </div>
            <button type="button" id="calculate-btn" class="primary" data-translate="calculateButton"></button>
        </form>
        <p id="error-message" class="error-message hidden"></p>
        <div class="result" id="result-container">
            <div class="result-label" id="result-title"></div>
            <div class="probability-meter-container">
                <div class="probability-meter-marker" id="prob-meter-marker"></div> 
                <span class="probability-meter-label" id="prob-meter-label"></span>
            </div>
            <section id="drivers-section">
                <h3 data-translate="driversTitle"></h3>
                <div id="drivers-columns">
                    <div class="driver-column"><h4 data-translate="increasingRiskTitle"></h4><div id="positive-drivers"></div></div>
                    <div class="driver-column"><h4 data-translate="decreasingRiskTitle"></h4><div id="negative-drivers"></div></div>
                </div>
            </section>
        </div>
    </main>

    <footer style="text-align:center; padding: 20px; font-size: 0.9em; opacity: 0.7;">
        <p>© <span id="currentYear"></span> All rights reserved.</p>
    </footer>

    <script>
        const MODEL_PARAMS = {
            INTERCEPT: -0.72549447,
            COEFFICIENTS: {'age_years': -0.20927375, 'eye_deviation': -0.26763354, 'armparese': 0.11730522, 'beinparese': 0.42467409, 'atrial_fibrillation': -0.24686695, 'systolic_bp': 0.36337294, 'antiplatelets': -0.52928134, 'gfap_value': 0.98845868, 'headache': 0.43796113 },
            SCALER_PARAMS: {'gfap_value': { center: 3.78418963, scale: 0.98704051 }, 'age_years': { center: 78.0, scale: 18.0 }, 'systolic_bp': { center: 160.0, scale: 41.5 } },
            CALIBRATION_A: 1.15, CALIBRATION_B: -0.20 
        };
        const FEATURES = Object.keys(MODEL_PARAMS.COEFFICIENTS);
        const CONTINUOUS_FEATURES = Object.keys(MODEL_PARAMS.SCALER_PARAMS);

        const translations = {
            en: {
                appTitle: "iGFAP Check", strokeModuleTitle: "ICH Probability Assessment", disclaimerTitle: "For Research Purposes Only", disclaimerText: "This tool is not a substitute for professional medical advice.",
                gfapLabel: "GFAP Value (pg/mL)", ageLabel: "Age (years)", sbpLabel: "Systolic BP (mmHg)",
                headacheLabel: "Headache", eyeDeviationLabel: "Eye Deviation", armpareseLabel: "Arm Paresis", beinpareseLabel: "Leg Paresis",
                afibLabel: "History of AFib", antiplateletsLabel: "On Antiplatelets",
                calculateButton: "Calculate ICH Probability",
                highRisk: "High Probability of ICH (>50%)", mediumRisk: "Medium Probability of ICH (25-50%)", lowRisk: "Low Probability of ICH (<25%)",
                invalidInput: "Please fill all fields.", driversTitle: "Prediction Drivers", increasingRiskTitle: "Factors Increasing Risk", decreasingRiskTitle: "Factors Decreasing Risk",
                featureNames: { 'age_years': 'Age', 'eye_deviation': 'Eye Deviation', 'armparese': 'Arm Paresis', 'beinparese': 'Leg Paresis', 'atrial_fibrillation': 'Atrial Fibrillation', 'systolic_bp': 'Systolic BP', 'antiplatelets': 'On Antiplatelets', 'gfap_value': 'GFAP', 'headache': 'Headache' },
            },
            de: {
                appTitle: "iGFAP Check", strokeModuleTitle: "ICB-Wahrscheinlichkeitsbewertung", disclaimerTitle: "Nur zu Forschungszwecken", disclaimerText: "Dieses Tool ist kein Ersatz für professionelle medizinische Beratung.",
                gfapLabel: "GFAP-Wert (pg/mL)", ageLabel: "Alter (Jahre)", sbpLabel: "Systolischer RR (mmHg)",
                headacheLabel: "Kopfschmerzen", eyeDeviationLabel: "Blickdeviation", armpareseLabel: "Armparese", beinpareseLabel: "Beinparese",
                afibLabel: "Vorhofflimmern-Anamnese", antiplateletsLabel: "Unter TAH",
                calculateButton: "ICB-Wahrscheinlichkeit berechnen",
                highRisk: "Hohe Wahrscheinlichkeit für ICB (>50%)", mediumRisk: "Mittlere Wahrscheinlichkeit für ICB (25-50%)", lowRisk: "Geringe Wahrscheinlichkeit für ICB (<25%)",
                invalidInput: "Bitte füllen Sie alle Felder aus.", driversTitle: "Treiber der Vorhersage", increasingRiskTitle: "Risikoerhöhende Faktoren", decreasingRiskTitle: "Risikomindernde Faktoren",
                featureNames: { 'age_years': 'Alter', 'eye_deviation': 'Blickdeviation', 'armparese': 'Armparese', 'beinparese': 'Beinparese', 'atrial_fibrillation': 'Vorhofflimmern', 'systolic_bp': 'Systolischer RR', 'antiplatelets': 'Unter TAH', 'gfap_value': 'GFAP', 'headache': 'Kopfschmerzen' },
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            if (localStorage.getItem('darkMode') === 'enabled') { document.body.classList.add('dark-mode'); document.getElementById('darkModeToggle').textContent = '☀️'; }
            switchLanguage(localStorage.getItem('language') || 'en');
            document.getElementById('calculate-btn').addEventListener('click', calculateProbability);
            document.getElementById('darkModeToggle').addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                document.getElementById('darkModeToggle').textContent = document.body.classList.contains('dark-mode') ? '☀️' : '🌙';
                localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
            });
        });

        function switchLanguage(lang) {
            window.currentLang = lang;
            const t = translations[lang];
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                if (t[key]) el.textContent = t[key];
            });
        }
        window.switchLanguage = switchLanguage;

        function calculateProbability() {
            const errorMsg = document.getElementById('error-message');
            errorMsg.style.display = 'none';
            const inputs = {};
            for (const key of FEATURES) {
                const el = document.getElementById(key);
                if (!el) continue;
                if (el.type === 'checkbox') {
                    inputs[key] = el.checked ? 1 : 0;
                } else if (el.value === '' || el.value === null) {
                    errorMsg.textContent = translations[window.currentLang].invalidInput;
                    errorMsg.style.display = 'block';
                    return;
                } else {
                    inputs[key] = parseFloat(el.value);
                }
            }
            if (inputs.headache === -1) inputs.headache = 0.0;
            inputs.gfap_value = Math.log1p(inputs.gfap_value);

            const contributions = {};
            let logOdds = MODEL_PARAMS.INTERCEPT;
            for (const key in MODEL_PARAMS.COEFFICIENTS) {
                let featureValue = inputs[key];
                if (CONTINUOUS_FEATURES.includes(key)) {
                    featureValue = (featureValue - MODEL_PARAMS.SCALER_PARAMS[key].center) / MODEL_PARAMS.SCALER_PARAMS[key].scale;
                }
                const contribution = featureValue * MODEL_PARAMS.COEFFICIENTS[key];
                contributions[key] = contribution;
                logOdds += contribution;
            }
            
            const rawProb = 1 / (1 + Math.exp(-logOdds));
            const calibratedLogOdds = MODEL_PARAMS.CALIBRATION_A * logOdds + MODEL_PARAMS.CALIBRATION_B;
            const calibratedProb = 1 / (1 + Math.exp(-calibratedLogOdds));

            displayResults(calibratedProb, contributions);
        }

        function displayResults(probability, contributions) {
            const resultContainer = document.getElementById('result-container');
            const resultTitle = document.getElementById('result-title');
            const meterMarker = document.getElementById('prob-meter-marker');
            const meterLabel = document.getElementById('prob-meter-label');
            
            resultContainer.style.display = 'block';
            const t = translations[window.currentLang];
            let decisionClass, decisionLabelKey;
            
            if (probability < 0.25) {
                decisionClass = 'low-risk';
                decisionLabelKey = 'lowRisk';
            } else if (probability < 0.50) {
                decisionClass = 'medium-risk';
                decisionLabelKey = 'mediumRisk';
            } else {
                decisionClass = 'high-risk';
                decisionLabelKey = 'highRisk';
            }

            resultContainer.className = `result ${decisionClass}`;
            resultTitle.textContent = t[decisionLabelKey];
            
            const markerPosition = Math.min(Math.max(probability, 0), 1) * 100;
            meterMarker.style.left = `calc(${markerPosition}% - 3px)`;
            meterLabel.style.left = `${markerPosition}%`;
            meterLabel.textContent = `${(probability * 100).toFixed(0)}%`;
            
            displayDrivers(contributions);
            resultContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function displayDrivers(contributions){
            const driversSection = document.getElementById('drivers-section');
            const posContainer = document.getElementById('positive-drivers');
            const negContainer = document.getElementById('negative-drivers');
            posContainer.innerHTML = ''; negContainer.innerHTML = '';

            const sortedDrivers = Object.entries(contributions).filter(([, val]) => Math.abs(val) > 0.01).sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));
            const maxAbsContribution = sortedDrivers.length > 0 ? Math.abs(sortedDrivers[0][1]) : 0;
            const t = translations[window.currentLang];

            sortedDrivers.forEach(([key, value]) => {
                const container = value > 0 ? posContainer : negContainer;
                const item = document.createElement('div');
                item.className = 'driver-item';
                const label = document.createElement('span');
                label.className = 'driver-label';
                label.textContent = t.featureNames[key] || key;
                const barContainer = document.createElement('div');
                barContainer.className = 'driver-bar-container';
                const bar = document.createElement('div');
                bar.className = 'driver-bar ' + (value > 0 ? 'positive' : 'negative');
                const barWidth = (maxAbsContribution > 0) ? (Math.abs(value) / maxAbsContribution) * 100 : 0;
                setTimeout(() => { bar.style.width = `${barWidth}%`; }, 10);
                barContainer.appendChild(bar);
                item.appendChild(label);
                item.appendChild(barContainer);
                container.appendChild(item);
            });
            driversSection.style.display = 'block';
        }
    </script>
</body>
</html>
