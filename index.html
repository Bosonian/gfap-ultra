<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>iGFAP Triage App</title>
  <meta name="theme-color" content="#007bff" />
  <style>
    /* 1. Minimal CSS Reset */
    html { line-height: 1.15; -webkit-text-size-adjust: 100%; }
    body { margin: 0; }

    :root {
      --primary-color: #007bff; --primary-hover: #0056b3; --background-color: #f4f7f9;
      --container-bg: #ffffff; --text-color: #333; --border-color: #dee2e6; --input-bg: #f8f9fa;
      --lvo-bg: #e1f5fe; --lvo-text: #01579b; --lvo-border: #0288d1;
      --ich-bg: #fbe9e7; --ich-text: #b71c1c; --ich-border: #d84315;
      --unclear-bg: #fffde7; --unclear-text: #f57f17; --unclear-border: #fbc02d;
      --mimic-bg: #e8f5e9; --mimic-text: #1b5e20; --mimic-border: #388e3c;
      --driver-positive-bg: #e74c3c; --driver-negative-bg: #3498db;
      --meter-green: #28a745; --meter-yellow: #ffc107; --meter-red: #dc3545;
    }
    body.dark-mode {
      --primary-color: #409eff; --primary-hover: #3a8ee6; --background-color: #121212;
      --container-bg: #1e1e1e; --text-color: #f1f1f1; --border-color: #444; --input-bg: #2a2a2a;
      --lvo-bg: #1a3a5b; --lvo-text: #b3e5fc; --lvo-border: #4fc3f7;
      --ich-bg: #5c2a30; --ich-text: #ffcdd2; --ich-border: #ff8a65;
      --unclear-bg: #4d442a; --unclear-text: #fff59d; --unclear-border: #ffee58;
      --mimic-bg: #2a5032; --mimic-text: #c8e6c9; --mimic-border: #81c784;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 80px 10px 40px;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    .container { max-width: 750px; margin: 20px auto; padding: 25px; background-color: var(--container-bg); border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); border: 1px solid var(--border-color); }
    .hidden { display: none !important; }
    .app-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 25px; background-color: var(--container-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; border-bottom: 1px solid var(--border-color); }
    .app-header h1 { font-size: 1.4em; margin: 0; color: var(--primary-color);}
    .header-right { display: flex; align-items: center; gap: 15px; }
    .language-switcher button { background: none; border: none; padding: 5px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;}
    .language-switcher button:hover { opacity: 1;}
    .language-switcher img { width: 24px; height: 16px; border-radius: 3px; vertical-align: middle;}
    #darkModeToggle { background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer; padding: 8px; }
    h2, h3 { text-align: center; margin-bottom: 25px;}
    h3 { font-size: 1.1em; opacity: 0.9; }
    .input-group, .checkbox-group { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--input-bg);}
    .checkbox-group label { display: flex; align-items: center; cursor: pointer; font-weight: normal; }
    input[type="checkbox"] { width: 1.3em; height: 1.3em; margin-right: 10px; accent-color: var(--primary-color); }
    label { display: block; margin-bottom: 6px; font-weight: bold;}
    input[type="number"], input[type="password"], select { width: 100%; padding: 10px; font-size: 16px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--container-bg); color: var(--text-color); }
    input:focus, select:focus { border-color: var(--primary-color); outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
    button.primary, button.secondary { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; position: relative;}
    button.primary { background-color: var(--primary-color); color: white; width: 100%; margin-top: 15px;}
    button.secondary { background: none; border: 1px solid var(--primary-color); color: var(--primary-color);}
    button.primary:hover:not(:disabled) { background-color: var(--primary-hover);}
    button:disabled { background-color: #a0a0a0; cursor: wait; color: #e0e0e0; }
    .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;}
    .grid-col-span-2 { grid-column: 1 / -1; }
    .error-message { color: var(--ich-text); background-color: var(--ich-bg); padding: 12px; border: 1px solid var(--ich-border); border-radius: 6px; margin-top: 20px; text-align: center;}
    .loading-spinner { position: absolute; left: 20px; top: 50%; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; transform: translateY(-50%); }
    @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }
    .result { margin-top: 20px; padding: 15px; border-radius: 8px; background-color: var(--input-bg); }
    .triage-card { padding: 20px; border-radius: 12px; border-left: 8px solid; text-align: center;}
    .triage-card.lvo { background-color: var(--lvo-bg); color: var(--lvo-text); border-left-color: var(--lvo-border);}
    .triage-card.ich, .triage-card.ich_only { background-color: var(--ich-bg); color: var(--ich-text); border-left-color: var(--ich-border);}
    .triage-card.unclear { background-color: var(--unclear-bg); color: var(--unclear-text); border-left-color: var(--unclear-border);}
    .triage-card.mimic, .triage-card.mimic_only { background-color: var(--mimic-bg); color: var(--mimic-text); border-left-color: var(--mimic-border);}
    .triage-card.error { background-color: var(--unclear-bg); color: var(--unclear-text); border-left-color: var(--unclear-border);}
    .triage-card .icon { font-size: 2.5rem; margin-bottom: 10px; }
    .drivers-title { text-align: center; margin: 30px 0 15px; font-size: 1.3em;}
    .drivers-panel { flex: 1; min-width: 220px;}
    .drivers-columns { display: flex; gap: 15px;}
    .driver-column { flex: 1;}
    .driver-column h5 { margin: 0 0 10px 0; text-align: center; font-size: 0.9em; opacity: 0.8;}
    .driver-item { display: flex; align-items: center; margin-bottom: 8px; gap: 8px;}
    .driver-label { flex-shrink: 0; width: 45%; text-align: right; font-size: 0.9em;}
    .driver-bar-container { flex-grow: 1; height: 16px; background-color: color-mix(in srgb, var(--border-color) 50%, transparent); border-radius: 5px;}
    .driver-bar { height: 100%; border-radius: 5px; transition: width 0.5s ease-out;}
    .driver-bar.positive { background-color: var(--driver-positive-bg);}
    .driver-bar.negative { background-color: var(--driver-negative-bg);}
    .prob-panel { min-width: 220px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px;}
    .probability-meter-container { width: 100%; height: 20px; background: linear-gradient(to right, var(--meter-green) 25%, var(--meter-yellow) 50%, var(--meter-red) 100%); border-radius: 10px; position: relative;}
    .probability-meter-marker { position: absolute; top: -3px; bottom: -3px; width: 6px; background-color: var(--text-color); border: 2px solid var(--container-bg); border-radius: 3px;}
    .probability-meter-label { position: absolute; top: 100%; transform: translateX(-50%); font-size: 1em; font-weight: bold; padding-top: 5px;}
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
    .modal-overlay.visible { opacity: 1; pointer-events: auto; }
    .modal { background: var(--container-bg); padding: 25px; border-radius: 12px; max-width: 400px; width: 95%; box-shadow: 0 5px 15px rgba(0,0,0,0.25);}
    .score-header { display: flex; justify-content: space-between; align-items: center; background-color: var(--input-bg); padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; }
    .score-header h3 { margin: 0; text-align: left; flex-grow: 1; }
    .dynamic-score-display { font-size: 1.6em; font-weight: bold; color: var(--primary-color); padding: 2px 12px; background-color: var(--container-bg); border-radius: 6px; border: 1px solid var(--border-color); }
  </style>
</head>
<body>
  <header class="app-header">
    <h1 id="appTitle" data-translate="appTitle">iGFAP Triage App</h1>
    <div class="header-right">
      <div class="language-switcher">
        <button id="langEnBtn" aria-label="Switch to English"><img src="https://flagcdn.com/gb.svg" alt="English"></button>
        <button id="langDeBtn" aria-label="Switch to German"><img src="https://flagcdn.com/de.svg" alt="Deutsch"></button>
      </div>
      <button id="darkModeToggle" aria-label="Toggle dark mode">🌙</button>
    </div>
  </header>

  <main>
    <section id="moduleSelectionSection" class="container">
      <h2 data-translate="moduleSelectionTitle">Select Module</h2>
      <button class="primary" id="comaModuleBtn"><span data-translate="comaModuleButtonText">Coma ICH Probability</span></button>
      <button class="primary" id="strokeModuleBtn"><span data-translate="strokeModuleButtonText">Stroke Triage Assistant</span></button>
    </section>

    <section id="comaModuleSection" class="container hidden">
      <h2 data-translate="comaModuleTitle">Coma ICH Probability</h2>
      <form id="comaForm">
        <div class="input-group">
          <label for="gfapComaInput" data-translate="gfapComaLabel">GFAP Value (pg/mL)</label>
          <input type="number" id="gfapComaInput" min="29" max="10001" required />
        </div>
        <button class="primary" id="calculateComaButton" type="submit"><span data-translate="calculateComaButton">Calculate</span></button>
        <button class="secondary" id="comaBackButton" type="button" style="margin-top:10px;"><span data-translate="backButton">⬅️ Back</span></button>
      </form>
      <div id="comaResult" class="result hidden" style="margin-top: 16px;"></div>
      <p id="comaError" class="error-message hidden"></p>
    </section>

    <section id="strokeModuleSection" class="container hidden">
        <!-- Content will be generated by strokeModule -->
    </section>
  </main>
  
  <div id="disclaimerModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="disclaimerModalTitle">
    <div class="modal">
      <h3 id="disclaimerModalTitle" data-translate="disclaimerTitle">Disclaimer</h3>
      <p data-translate="disclaimerText">The calculations are for research purposes only; do not make clinical decisions based on them.</p>
      <button class="primary" id="disclaimerConfirmBtn"><span data-translate="confirmButton">Confirm</span></button>
    </div>
  </div>

  <footer style="text-align:center; margin-top:20px; padding-bottom: 20px;">
    <p>© <span id="currentYear"></span> iGFAP Triage App</p>
  </footer>

  <script>
    // ---- TRANSLATIONS ----
    const translations = {
        en: {
            appTitle: "iGFAP Triage App",
            moduleSelectionTitle: "Select Module", comaModuleButtonText: "Coma ICH Probability", strokeModuleButtonText: "Stroke Triage Assistant",
            comaModuleTitle: "Coma ICH Probability", gfapComaLabel: "GFAP Value (pg/mL)", calculateComaButton: "Calculate", backButton: "⬅️ Back", invalidInput: "Please enter a valid number.", serverError: "A server error occurred. Please try again later.",
            disclaimerTitle: "Disclaimer", disclaimerText: "The calculations are for research purposes only; do not make clinical decisions based on them.", confirmButton: "Confirm",
            formTitle: "Stroke Triage Assistant", gfapLabel: "GFAP Value (pg/mL)", ageLabel: "Age (years)", sbpLabel: "Systolic BP", dbpLabel: "Diastolic BP",
            headacheLabel: "Headache", beinpareseLabel: "Leg Paresis", afibLabel: "Atrial Fibrillation", antiplateletsLabel: "On Antiplatelets", vigilanceLabel: "Vigilance Reduction", noakLabel: "On NOAK",
            analyzeButton: "Analyze", analysisToggle: "View Detailed Analysis", analysisToggleHide: "Hide Detailed Analysis",
            fastEdTitle: "FAST-ED Components (LVO screen if score ≥ 4)", fastEdScoreLabel: "Score:",
            fastEdFace: "Facial Palsy", fastEdFace0: "Normal", fastEdFace1: "Minor", fastEdFace2: "Major",
            fastEdArm: "Arm Weakness", fastEdArm0: "No drift", fastEdArm1: "Drifts", fastEdArm2: "Falls rapidly",
            fastEdSpeech: "Speech Changes", fastEdSpeech0: "Normal", fastEdSpeech1: "Mild-moderate", fastEdSpeech2: "Severe / Mute",
            fastEdEyes: "Eye Deviation", fastEdEyes0: "Absent", fastEdEyes1: "Present",
            fastEdDenial: "Denial / Neglect", fastEdDenial0: "Absent", fastEdDenial1: "Present",
            invalidStrokeInput: "Please fill all fields with valid numbers.",
            toggleDarkMode: "Toggle dark mode", toggleLightMode: "Toggle light mode",
            triage: { 
                lvo_title: "LVO LIKELY", lvo_rec: "Proceed directly to the nearest LVO-capable Comprehensive Stroke Center.", 
                ich_title: "STRONG SUSPICION OF ICH", ich_rec: "Proceed to the nearest center with neurosurgical capabilities. Thrombectomy not indicated.", 
                unclear_title: "UNCLEAR STROKE TYPE", unclear_rec: "LVO cannot be ruled out. Default to LVO protocol: proceed to LVO-capable center if feasible.", 
                mimic_title: "ICH & LVO UNLIKELY", mimic_rec: "Re-evaluate for Stroke Mimics. Proceed to nearest appropriate facility.",
                ich_only_title: "SUSPICION OF ICH (LVO Unlikely)", ich_only_rec: "LVO screen not indicated (FAST-ED < 4). Proceed to the nearest center with neurosurgical capabilities.",
                mimic_only_title: "ICH & LVO UNLIKELY", mimic_only_rec: "LVO screen not indicated (FAST-ED < 4). Re-evaluate for Stroke Mimics. Proceed to nearest appropriate facility.",
                error_title: "LVO DATA UNAVAILABLE", error_rec: "Could not retrieve LVO data. ICH analysis is shown below. Proceed based on clinical judgment."
            },
            featureNames: { gfapValue: 'GFAP', ageYears: 'Age', systolicBp: 'Systolic BP', headache: 'Headache', eyeDeviation: 'Eye Deviation', armParesis: 'Arm Paresis', legParesis: 'Leg Paresis', atrialFibrillation: 'AFib History', onAntiplatelets: 'On Antiplatelets'},
            driversTitle: "Prediction Drivers", increasingRisk: "Increasing Risk", decreasingRisk: "Decreasing Risk", ichTitle: "ICH Details", lvoTitle: "LVO Details",
        },
        de: {
            appTitle: "iGFAP Triage App",
            moduleSelectionTitle: "Modul auswählen", comaModuleButtonText: "Koma ICB-Wahrscheinlichkeit", strokeModuleButtonText: "Schlaganfall-Triage-Assistent",
            comaModuleTitle: "Koma ICB-Wahrscheinlichkeit", gfapComaLabel: "GFAP-Wert (pg/mL)", calculateComaButton: "Berechnen", backButton: "⬅️ Zurück", invalidInput: "Bitte geben Sie eine gültige Nummer ein.", serverError: "Ein Serverfehler ist aufgetreten. Bitte versuchen Sie es später erneut.",
            disclaimerTitle: "Haftungsausschluss", disclaimerText: "Die Berechnungen dienen nur zu Forschungszwecken; treffen Sie keine klinischen Entscheidungen auf dieser Grundlage.", confirmButton: "Bestätigen",
            formTitle: "Schlaganfall-Triage-Assistent", gfapLabel: "GFAP-Wert (pg/mL)", ageLabel: "Alter (Jahre)", sbpLabel: "Systolischer RR", dbpLabel: "Diastolischer RR",
            headacheLabel: "Kopfschmerzen", beinpareseLabel: "Beinparese", afibLabel: "Vorhofflimmern", antiplateletsLabel: "Thrombozytenaggregationshemmer", vigilanceLabel: "Vigilanzminderung", noakLabel: "Unter NOAK",
            analyzeButton: "Analysieren", analysisToggle: "Detaillierte Analyse anzeigen", analysisToggleHide: "Detaillierte Analyse ausblenden",
            fastEdTitle: "FAST-ED Komponenten (LVO Screen bei Score ≥ 4)", fastEdScoreLabel: "Score:",
            fastEdFace: "Fazialisparese", fastEdFace0: "Normal", fastEdFace1: "Leicht", fastEdFace2: "Schwer",
            fastEdArm: "Armschwäche", fastEdArm0: "Kein Absinken", fastEdArm1: "Sinkt ab", fastEdArm2: "Fällt schnell",
            fastEdSpeech: "Sprachstörung", fastEdSpeech0: "Normal", fastEdSpeech1: "Leicht bis mäßig", fastEdSpeech2: "Schwer / Stumm",
            fastEdEyes: "Blickdeviation", fastEdEyes0: "Fehlend", fastEdEyes1: "Vorhanden",
            fastEdDenial: "Neglect / Anosognosie", fastEdDenial0: "Fehlend", fastEdDenial1: "Vorhanden",
            invalidStrokeInput: "Bitte füllen Sie alle Pflichtfelder mit gültigen Zahlen aus.",
            toggleDarkMode: "Dunkelmodus umschalten", toggleLightMode: "Heller Modus umschalten",
            triage: { 
                lvo_title: "LVO Wahrscheinlich", lvo_rec: "Fahren Sie direkt zum nächsten Thrombektomie-fähigen Zentrum.", 
                ich_title: "Starker Verdacht auf ICB", ich_rec: "Fahren Sie zum nächstgelegenen Zentrum mit neurochirurgischer Abteilung. Thrombektomie nicht indiziert.", 
                unclear_title: "UNKLARER SCHLAGANFALLTYP", unclear_rec: "LVO kann nicht ausgeschlossen werden. Standardmäßig LVO-Protokoll: Fahren Sie, wenn möglich, zu einem Thrombektomie-fähigen Zentrum.",
                mimic_title: "ICB & LVO UNWAHRSCHEINLICH", mimic_rec: "Erwägen Sie Schlaganfall-Mimics. Fahren Sie zur nächstgelegenen geeigneten Einrichtung.",
                ich_only_title: "VERDACHT AUF ICB (LVO Unwahrscheinlich)", ich_only_rec: "LVO-Screening nicht indiziert (FAST-ED < 4). Fahren Sie zum nächstgelegenen Zentrum mit neurochirurgischer Abteilung.",
                mimic_only_title: "ICB & LVO UNWAHRSCHEINLICH", mimic_only_rec: "LVO-Screening nicht indiziert (FAST-ED < 4). Erwägen Sie Schlaganfall-Mimics. Fahren Sie zur nächstgelegenen geeigneten Einrichtung.",
                error_title: "LVO-DATEN NICHT VERFÜGBAR", error_rec: "LVO-Daten konnten nicht abgerufen werden. ICB-Analyse unten angezeigt. Handeln Sie nach klinischem Ermessen." 
            },
            featureNames: { gfapValue: 'GFAP', ageYears: 'Alter', systolicBp: 'Systol. RR', headache: 'Kopfschmerzen', eyeDeviation: 'Blickdeviation', armParesis: 'Armparese', legParesis: 'Beinparese', atrialFibrillation: 'Vorhofflimmern', onAntiplatelets: 'Thrombozytenhemmer' },
            driversTitle: "Treiber der Vorhersage", increasingRisk: "Risikoerhöhend", decreasingRisk: "Risikomindernd", ichTitle: "ICB-Details", lvoTitle: "LVO-Details",
        }
    };
    
    // ---- Main Application Controller ----
    const mainController = (() => {
        const dom = { sections: { moduleSelection: document.getElementById('moduleSelectionSection'), coma: document.getElementById('comaModuleSection'), stroke: document.getElementById('strokeModuleSection') }, buttons: { disclaimerConfirm: document.getElementById('disclaimerConfirmBtn'), langEn: document.getElementById('langEnBtn'), langDe: document.getElementById('langDeBtn'), darkModeToggle: document.getElementById('darkModeToggle') }, disclaimerModal: document.getElementById('disclaimerModal'), };
        let currentLanguage = 'en', activeElementBeforeModal;
        const showSection = (sectionName) => { Object.values(dom.sections).forEach(s => s.classList.add('hidden')); if(dom.sections[sectionName]) dom.sections[sectionName].classList.remove('hidden'); window.scrollTo(0,0); };
        const setLoadingState = (button, isLoading) => { button.disabled = isLoading; if (isLoading) { const spinner = document.createElement('div'); spinner.className = 'loading-spinner'; button.prepend(spinner); } else { const spinner = button.querySelector('.loading-spinner'); if (spinner) spinner.remove(); } };
        const switchLanguage = (lang) => { currentLanguage = lang; localStorage.setItem('language', lang); const t = translations[lang] || translations.en; document.documentElement.lang = lang; document.querySelectorAll('[data-translate]').forEach(el => { const key = el.dataset.translate; if (t[key]) (el.querySelector('span') || el).textContent = t[key]; }); const isDarkMode = document.body.classList.contains('dark-mode'); dom.buttons.darkModeToggle.setAttribute('aria-label', isDarkMode ? t.toggleLightMode : t.toggleDarkMode); };
        const handleFocusTrap = (e) => { const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'; const modal = e.currentTarget; const focusableContent = modal.querySelectorAll(focusableElements); if(focusableContent.length === 0) return; const firstFocusableElement = focusableContent[0]; const lastFocusableElement = focusableContent[focusableContent.length - 1]; if (e.key !== 'Tab') return; if (e.shiftKey) { if (document.activeElement === firstFocusableElement) { lastFocusableElement.focus(); e.preventDefault(); } } else { if (document.activeElement === lastFocusableElement) { firstFocusableElement.focus(); e.preventDefault(); } } };
        const requestDisclaimer = () => { return new Promise(resolve => { const modal = dom.disclaimerModal; activeElementBeforeModal = document.activeElement; const handler = () => { modal.classList.remove('visible'); modal.removeEventListener('keydown', handleFocusTrap); dom.buttons.disclaimerConfirm.removeEventListener('click', handler); if(activeElementBeforeModal) activeElementBeforeModal.focus(); resolve(); }; dom.buttons.disclaimerConfirm.addEventListener('click', handler); modal.addEventListener('keydown', handleFocusTrap); modal.classList.add('visible'); setTimeout(() => dom.buttons.disclaimerConfirm.focus(), 10); }); };
        const init = () => {
            dom.buttons.darkModeToggle.addEventListener('click', () => { const isDarkMode = document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled'); dom.buttons.darkModeToggle.textContent = isDarkMode ? '☀️' : '🌙'; const t = translations[currentLanguage]; dom.buttons.darkModeToggle.setAttribute('aria-label', isDarkMode ? t.toggleLightMode : t.toggleDarkMode); });
            dom.buttons.langEn.addEventListener('click', () => switchLanguage('en')); dom.buttons.langDe.addEventListener('click', () => switchLanguage('de'));
            const sharedCallbacks = { showSection, setLoadingState, requestDisclaimer, getLang: () => currentLanguage };
            comaModule.init(sharedCallbacks); strokeModule.init(sharedCallbacks);
            document.getElementById('currentYear').textContent = new Date().getFullYear(); const savedLang = localStorage.getItem('language') || (navigator.language.startsWith('de') ? 'de' : 'en'); switchLanguage(savedLang);
            const savedTheme = localStorage.getItem('darkMode'); if (savedTheme === 'enabled' || (savedTheme === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.body.classList.add('dark-mode'); dom.buttons.darkModeToggle.textContent = '☀️'; }
            showSection('moduleSelection');
        };
        return { init };
    })();
    
    // ---- Coma Module ----
    const comaModule = (() => {
        let dom = {}; let callbacks = {};
        const init = (parentCallbacks) => { dom = { form: document.getElementById('comaForm'), input: document.getElementById('gfapComaInput'), button: document.getElementById('calculateComaButton'), backButton: document.getElementById('comaBackButton'), result: document.getElementById('comaResult'), error: document.getElementById('comaError'), moduleBtn: document.getElementById('comaModuleBtn') }; callbacks = parentCallbacks; dom.form.addEventListener('submit', handleComaSubmit); dom.moduleBtn.addEventListener('click', () => callbacks.showSection('coma')); dom.backButton.addEventListener('click', () => callbacks.showSection('moduleSelection')); };
        const handleComaSubmit = async (e) => { e.preventDefault(); dom.error.classList.add('hidden'); dom.result.classList.add('hidden'); const value = parseFloat(dom.input.value); if (isNaN(value) || value < parseFloat(dom.input.min) || value > parseFloat(dom.input.max)) { dom.error.textContent = translations[callbacks.getLang()].invalidInput; dom.error.classList.remove('hidden'); return; } await callbacks.requestDisclaimer(); callbacks.setLoadingState(dom.button, true); try { const response = await fetch('https://europe-west3-igfap-452720.cloudfunctions.net/calculateComaRisk', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ gfap: value }) }); if (response.ok) { const data = await response.json(); if (data.result && typeof data.result.probability !== 'undefined') { dom.result.textContent = 'Probability of ICH: '; const strongEl = document.createElement('strong'); strongEl.textContent = `${(data.result.probability * 100).toFixed(1)}%`; dom.result.appendChild(strongEl); dom.result.classList.remove('hidden'); } else { throw new Error('Invalid response format from server.'); } } else { throw new Error(`Server responded with status ${response.status}`); } } catch (error) { console.error("Coma Risk Fetch Error:", error); dom.error.textContent = translations[callbacks.getLang()].serverError; dom.error.classList.remove('hidden'); } finally { callbacks.setLoadingState(dom.button, false); } };
        return { init };
    })();
    
    // ---- Stroke Module ----
    const strokeModule = (() => {
        let dom = {}; let callbacks = {};
        const api = { lvoPrediction: 'https://lvo-ppv-service-564499947017.europe-west3.run.app/predict', lvoExplanation: 'https://lvo-ppv-service-564499947017.europe-west3.run.app/explain' };
        const ichModel = { INTERCEPT: -0.72549447, COEFFICIENTS: {'gfapValue': 0.98845868, 'ageYears': -0.20927375, 'systolicBp': 0.36337294, 'headache': 0.43796113, 'eyeDeviation': -0.26763354, 'armParesis': 0.11730522, 'legParesis': 0.42467409, 'atrialFibrillation': -0.24686695, 'onAntiplatelets': -0.52928134 }, SCALER_PARAMS: {'gfapValue': { center: 3.78418963, scale: 0.98704051 }, 'ageYears': { center: 78.0, scale: 18.0 }, 'systolicBp': { center: 160.0, scale: 41.5 } }, CALIBRATION: { A: 1.15, B: -0.20 } };
        const modelInputs = ['gfapValue', 'ageYears', 'systolicBp', 'diastolicBp', 'headache', 'eyeDeviation', 'armParesis', 'legParesis', 'atrialFibrillation', 'onAntiplatelets', 'vigilanceReduction', 'onNoak'];

        const init = (parentCallbacks) => {
            callbacks = parentCallbacks; document.getElementById('strokeModuleBtn').addEventListener('click', () => { callbacks.showSection('stroke'); if (!dom.form) createForm(); });
        };
        
        const createForm = () => {
            const section = document.getElementById('strokeModuleSection');
            section.innerHTML = `
              <h2 data-translate="formTitle">Stroke Triage Assistant</h2>
              <form id="triageForm">
                <div class="input-grid">
                  <div class="input-group"><label for="gfapValue" data-translate="gfapLabel">GFAP Value (pg/mL)</label><input type="number" id="gfapValue" min="29" max="10001" required></div>
                  <div class="input-group"><label for="ageYears" data-translate="ageLabel">Age (years)</label><input type="number" id="ageYears" min="18" required></div>
                  <div class="input-group"><label for="systolicBp" data-translate="sbpLabel">Systolic BP</label><input type="number" id="systolicBp" required></div>
                  <div class="input-group"><label for="diastolicBp" data-translate="dbpLabel">Diastolic BP</label><input type="number" id="diastolicBp" required></div>
                  <div class="grid-col-span-2 score-header"><h3 data-translate="fastEdTitle"></h3><span id="fastEdScoreDisplay" class="dynamic-score-display">0</span></div>
                  <div class="input-group"><label for="strokeFastEdFace" data-translate="fastEdFace">Facial Palsy</label><select id="strokeFastEdFace"><option value="0" data-translate="fastEdFace0">Normal</option><option value="1" data-translate="fastEdFace1">Minor</option><option value="2" data-translate="fastEdFace2">Major</option></select></div>
                  <div class="input-group"><label for="strokeFastEdArm" data-translate="fastEdArm">Arm Weakness</label><select id="strokeFastEdArm"><option value="0" data-translate="fastEdArm0">No drift</option><option value="1" data-translate="fastEdArm1">Drifts</option><option value="2" data-translate="fastEdArm2">Falls rapidly</option></select></div>
                  <div class="input-group"><label for="strokeFastEdSpeech" data-translate="fastEdSpeech">Speech Changes</label><select id="strokeFastEdSpeech"><option value="0" data-translate="fastEdSpeech0">Normal</option><option value="1" data-translate="fastEdSpeech1">Mild-moderate</option><option value="2" data-translate="fastEdSpeech2">Severe / Mute</option></select></div>
                  <div class="input-group"><label for="strokeFastEdEyes" data-translate="fastEdEyes">Eye Deviation</label><select id="strokeFastEdEyes"><option value="0" data-translate="fastEdEyes0">Absent</option><option value="1" data-translate="fastEdEyes1">Present</option></select></div>
                  <div class="input-group"><label for="strokeFastEdDenial" data-translate="fastEdDenial">Denial / Neglect</label><select id="strokeFastEdDenial"><option value="0" data-translate="fastEdDenial0">Absent</option><option value="1" data-translate="fastEdDenial1">Present</option></select></div>
                  <div class="grid-col-span-2"><h3>Additional Clinical Signs</h3></div>
                  <div class="checkbox-group"><label><input type="checkbox" id="headache"><span data-translate="headacheLabel">Headache</span></label></div>
                  <div class="checkbox-group"><label><input type="checkbox" id="legParesis"><span data-translate="beinpareseLabel">Leg Paresis</span></label></div>
                  <div class="checkbox-group"><label><input type="checkbox" id="atrialFibrillation"><span data-translate="afibLabel">Atrial Fibrillation</span></label></div>
                  <div class="checkbox-group"><label><input type="checkbox" id="onAntiplatelets"><span data-translate="antiplateletsLabel">On Antiplatelets</span></label></div>
                  <div class="checkbox-group"><label><input type="checkbox" id="vigilanceReduction"><span data-translate="vigilanceLabel">Vigilance Reduction</span></label></div>
                  <div class="checkbox-group"><label><input type="checkbox" id="onNoak"><span data-translate="noakLabel">On NOAK</span></label></div>
                  <div class="hidden"><input type="checkbox" id="armParesis"><input type="checkbox" id="eyeDeviation"></div>
                </div>
                <button type="submit" id="calculateStrokeButton" class="primary"><span data-translate="analyzeButton">Analyze</span></button>
                <button type="button" class="secondary" id="strokeBackButton" style="margin-top:10px;"><span data-translate="backButton">⬅️ Back</span></button>
              </form>
              <p id="strokeError" class="error-message hidden"></p>
              <div id="resultsArea" class="hidden">
                <div id="triageRecommendation"></div>
                <div style="text-align:center;"><button id="analysisToggle" class="secondary" style="margin-top:20px;"><span data-translate="analysisToggle">View Detailed Analysis</span></button></div>
                <div id="analysisDetails" class="hidden" style="margin-top:20px;display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                    <div class="prob-panel" id="ichProbPanel"></div><div class="prob-panel" id="lvoProbPanel"></div>
                    <h3 class="drivers-title" data-translate="driversTitle" style="grid-column:1/-1;"></h3>
                    <div class="drivers-panel" id="ichDriversPanel"></div><div class="drivers-panel" id="lvoDriversPanel"></div>
                </div>
              </div>`;
            dom = { form: section.querySelector('#triageForm'), button: section.querySelector('#calculateStrokeButton'), backButton: section.querySelector('#strokeBackButton'), error: section.querySelector('#strokeError'), resultsArea: section.querySelector('#resultsArea'), triageRec: section.querySelector('#triageRecommendation'), analysisToggle: section.querySelector('#analysisToggle'), analysisDetails: section.querySelector('#analysisDetails'), ichProbPanel: section.querySelector('#ichProbPanel'), lvoProbPanel: section.querySelector('#lvoProbPanel'), ichDriversPanel: section.querySelector('#ichDriversPanel'), lvoDriversPanel: section.querySelector('#lvoDriversPanel'), fastEdScoreDisplay: section.querySelector('#fastEdScoreDisplay'), fastEdInputs: Array.from(section.querySelectorAll('[id^="strokeFastEd"]')) };
            dom.form.addEventListener('submit', handleAnalyze);
            dom.backButton.addEventListener('click', () => callbacks.showSection('moduleSelection'));
            dom.analysisToggle.addEventListener('click', toggleAnalysis);
            dom.fastEdInputs.forEach(el => el.addEventListener('change', updateFastEdScoreDisplay));
            callbacks.getLang() !== 'en' && callbacks.switchLanguage(callbacks.getLang()); // Re-translate dynamic content
            updateFastEdScoreDisplay();
        };

        const updateDerivedCheckboxes = () => { const armValue = parseInt(document.getElementById('strokeFastEdArm').value) || 0; const eyeValue = parseInt(document.getElementById('strokeFastEdEyes').value) || 0; document.getElementById('armParesis').checked = (armValue > 0); document.getElementById('eyeDeviation').checked = (eyeValue > 0); };
        const getFastEdScore = () => dom.fastEdInputs.reduce((score, el) => score + (parseInt(el.value) || 0), 0);
        const updateFastEdScoreDisplay = () => { updateDerivedCheckboxes(); dom.fastEdScoreDisplay.textContent = getFastEdScore(); };
        const toggleAnalysis = () => { const isHidden = dom.analysisDetails.classList.toggle('hidden'); const key = isHidden ? 'analysisToggle' : 'analysisToggleHide'; dom.analysisToggle.querySelector('span').textContent = translations[callbacks.getLang()][key]; };

        const handleAnalyze = async (e) => {
            e.preventDefault(); dom.error.classList.add('hidden'); dom.resultsArea.classList.add('hidden');
            const data = collectInputs(); if (!data) return;
            await callbacks.requestDisclaimer(); callbacks.setLoadingState(dom.button, true);
            const ichData = calculateIch(data);
            try {
                let lvoData = null;
                if (data.fastEdScore >= 4) lvoData = await fetchLvo(data);
                const triageOutcome = determineTriage(ichData, lvoData, data.fastEdScore);
                renderResults(triageOutcome);
            } catch (error) {
                console.error("LVO Fetch Error:", error);
                renderResults({ type: 'error', ichData, lvoData: null }); // Reliability Fix: Explicitly render error state
            } finally {
                callbacks.setLoadingState(dom.button, false);
                dom.resultsArea.classList.remove('hidden');
                dom.resultsArea.scrollIntoView({behavior:"smooth", block:"start"});
            }
        };

        const collectInputs = () => { const data = { fastEdScore: getFastEdScore() }; let isValid = true; modelInputs.forEach(id => { const el = document.getElementById(id); if (!el) return; if (el.type === 'checkbox') { data[id] = el.checked ? 1 : 0; } else { const v = parseFloat(el.value); if (el.required && (isNaN(v) || (el.min && v < parseFloat(el.min)) || (el.max && v > parseFloat(el.max)))) isValid = false; data[id] = v; } }); if (!isValid) { dom.error.textContent = translations[callbacks.getLang()].invalidStrokeInput; dom.error.classList.remove('hidden'); return null; } return data; };
        const remapKeysForBackend = (data) => { const remappedData = {}; const keyMap = { gfapValue: 'gfap_value', ageYears: 'age_years', systolicBp: 'systolic_bp', diastolicBp: 'diastolic_bp', fastEdScore: 'fast_ed_score', headache: 'headache', eyeDeviation: 'eye_deviation', armParesis: 'armparese', legParesis: 'beinparese', atrialFibrillation: 'atrial_fibrillation', onAntiplatelets: 'antiplatelets', vigilanceReduction: 'vigilanzminderung', onNoak: 'antcoagulated_noak' }; for(const key in data) { if(keyMap[key]) remappedData[keyMap[key]] = data[key]; } return remappedData; };
        const calculateIch = (data) => { const ichInputs = {...data, gfapValue: Math.log1p(data.gfapValue)}; let logOdds = ichModel.INTERCEPT; const impacts = {}; for (const [feature, coef] of Object.entries(ichModel.COEFFICIENTS)) { let value = ichInputs[feature]; if (ichModel.SCALER_PARAMS[feature]) { const s = ichModel.SCALER_PARAMS[feature]; value = (value - s.center) / s.scale; } impacts[feature] = value * coef; logOdds += value * coef; } const calibrated = ichModel.CALIBRATION.A * logOdds + ichModel.CALIBRATION.B; const probability = 1 / (1 + Math.exp(-calibrated)); return { probability, impacts }; };
        const fetchLvo = async (data) => { const remappedData = remapKeysForBackend(data); const fetchOptions = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(remappedData) }; const [predRes, explRes] = await Promise.all([ fetch(api.lvoPrediction, fetchOptions), fetch(api.lvoExplanation, fetchOptions) ]); if (!predRes.ok || !explRes.ok) throw new Error(`API Error: Prediction ${predRes.status}, Explanation ${explRes.status}`); const pred = await predRes.json(); const expl = await explRes.json(); if (typeof pred.lvo_probability === 'undefined' || typeof expl.feature_impacts === 'undefined') throw new Error('Invalid API response format'); return { probability: pred.lvo_probability, impacts: expl.feature_impacts }; };

        const determineTriage = (ichData, lvoData, fastEdScore) => { if (fastEdScore < 4) { const type = ichData.probability > 0.5 ? "ich_only" : "mimic_only"; return { type, ichData, lvoData: null }; } if (!lvoData) return { type: "error", ichData, lvoData }; const ichProb = ichData.probability; const lvoProb = lvoData.probability; if (ichProb < 0.2 && lvoProb < 0.2) return { type: "mimic", ichData, lvoData }; if (ichProb > 0.5 && ichProb > lvoProb) return { type: "ich", ichData, lvoData }; if (lvoProb > 0.6 && lvoProb > ichProb) return { type: "lvo", ichData, lvoData }; return { type: "unclear", ichData, lvoData }; };
        
        // --- SECURE RENDERING FUNCTIONS ---
        const renderResults = (outcome) => {
            const t = translations[callbacks.getLang()]; const triageText = t.triage;
            const icons = { lvo: '🧠⚡️', ich: '🧠🩸', unclear: '🧠❓', mimic: '‍⚕️🩺', error: '📡⚠️', ich_only: '🧠🩸', mimic_only: '‍⚕️🩺' };
            
            // Security Fix: Create elements safely, no .innerHTML
            dom.triageRec.innerHTML = ''; // Clear previous results
            const card = document.createElement('div');
            card.className = `triage-card ${outcome.type}`;
            const iconEl = document.createElement('div');
            iconEl.className = 'icon';
            iconEl.textContent = icons[outcome.type]; // Safe
            const titleEl = document.createElement('h3');
            titleEl.textContent = triageText[`${outcome.type}_title`]; // Safe
            const recEl = document.createElement('p');
            recEl.textContent = triageText[`${outcome.type}_rec`]; // Safe
            card.append(iconEl, titleEl, recEl);
            dom.triageRec.appendChild(card);
            
            dom.analysisDetails.style.gridTemplateColumns = outcome.lvoData ? '1fr 1fr' : '1fr';
            dom.lvoProbPanel.style.display = outcome.lvoData ? 'block' : 'none';
            dom.lvoDriversPanel.style.display = outcome.lvoData ? 'block' : 'none';
            dom.ichProbPanel.innerHTML = ''; dom.ichProbPanel.appendChild(renderProbPanel('ich', outcome.ichData));
            dom.ichDriversPanel.innerHTML = ''; dom.ichDriversPanel.appendChild(renderDriversPanel(outcome.ichData.impacts, 'ich'));
            if (outcome.lvoData) {
                dom.lvoProbPanel.innerHTML = ''; dom.lvoProbPanel.appendChild(renderProbPanel('lvo', outcome.lvoData));
                dom.lvoDriversPanel.innerHTML = ''; dom.lvoDriversPanel.appendChild(renderDriversPanel(outcome.lvoData.impacts, 'lvo'));
            }
        };

        const renderProbPanel = (type, data) => { const t = translations[callbacks.getLang()]; const wrapper = document.createDocumentFragment(); const title = document.createElement('h4'); title.textContent = t[`${type}Title`]; wrapper.appendChild(title); if (!data) { const p = document.createElement('p'); p.textContent = 'Data unavailable.'; wrapper.appendChild(p); return wrapper; } const prob = data.probability; const meter = document.createElement('div'); meter.className = 'probability-meter-container'; const marker = document.createElement('div'); marker.className = 'probability-meter-marker'; marker.style.left = `calc(${(prob*100).toFixed(0)}% - 3px)`; const label = document.createElement('span'); label.className = 'probability-meter-label'; label.style.left = `${(prob*100).toFixed(0)}%`; label.textContent = `${(prob*100).toFixed(1)}%`; meter.append(marker, label); wrapper.appendChild(meter); return wrapper; };
        
        const renderDriversPanel = (impacts, type) => {
            const t = translations[callbacks.getLang()]; const wrapper = document.createDocumentFragment();
            const driversTitle = document.querySelector('.drivers-title');
            if(driversTitle) driversTitle.textContent = t.driversTitle;

            if (!impacts) { const p = document.createElement('p'); p.textContent = 'Data unavailable.'; wrapper.appendChild(p); return wrapper; }
            const sorted = Object.entries(impacts).filter(([, val])=>Math.abs(val)>0.01).sort((a,b)=>Math.abs(b[1])-Math.abs(a[1]));
            if (sorted.length === 0) return wrapper;
            const maxAbs = Math.abs(sorted[0][1]); const columns = document.createElement('div'); columns.className = 'drivers-columns';
            const posCol = document.createElement('div'); posCol.className = 'driver-column'; const negCol = document.createElement('div'); negCol.className = 'driver-column';
            const posTitle = document.createElement('h5'); posTitle.textContent = t.increasingRisk; posCol.appendChild(posTitle);
            const negTitle = document.createElement('h5'); negTitle.textContent = t.decreasingRisk; negCol.appendChild(negTitle);
            
            sorted.forEach(([key, val]) => {
                const barWidth = (maxAbs > 0) ? (Math.abs(val) / maxAbs) * 100 : 0;
                // Security Fix: Create elements safely, no .innerHTML
                const item = document.createElement('div'); item.className = 'driver-item';
                const label = document.createElement('span'); label.className = 'driver-label'; label.textContent = t.featureNames[key] || key;
                const barContainer = document.createElement('div'); barContainer.className = 'driver-bar-container';
                const bar = document.createElement('div'); bar.className = `driver-bar ${val >= 0 ? 'positive' : 'negative'}`; bar.style.width = `${barWidth}%`;
                barContainer.appendChild(bar); item.append(label, barContainer);
                if (val >= 0) posCol.appendChild(item); else negCol.appendChild(item);
            });
            if(posCol.children.length > 1) columns.appendChild(posCol); if(negCol.children.length > 1) columns.appendChild(negCol);
            wrapper.appendChild(columns); return wrapper;
        };
        return { init };
    })();
    
    // ---- App Initialization ----
    document.addEventListener('DOMContentLoaded', mainController.init);
  </script>
</body>
</html>
