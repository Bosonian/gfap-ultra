<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stroke Triage Assistant - Professional Edition</title>
    <meta name="theme-color" content="#00529B" />
    <meta name="description" content="Professional stroke triage assistant for emergency medical services" />
    <style>
        /* Enhanced CSS with improved accessibility and safety features */
        :root {
            --primary-color: #00529B;
            --primary-hover: #003d73;
            --danger-color: #D4001A;
            --danger-hover: #a30014;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --background-color: #f5f7fa;
            --container-bg: #ffffff;
            --text-color: #2c3e50;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --input-bg: #f8f9fa;
            --info-bg: #fff3cd;
            --info-text: #664d03;
            --info-border: #ffc107;
            --critical-bg: #f8d7da;
            --critical-text: #721c24;
            --critical-border: #f5c6cb;
            --driver-positive-bg: #dc3545;
            --driver-negative-bg: #28a745;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
        }

        body.dark-mode {
            --primary-color: #4a9eff;
            --primary-hover: #3a8ee6;
            --background-color: #0f1419;
            --container-bg: #1a1f2e;
            --text-color: #e1e8ed;
            --text-secondary: #8899a6;
            --border-color: #2f3336;
            --input-bg: #253341;
            --info-bg: #3d3415;
            --info-text: #ffd93d;
            --critical-bg: #3d1418;
            --critical-text: #ff6b6b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            line-height: 1.6;
            background-color: var(--background-color);
            color: var(--text-color);
            padding-top: 70px;
            transition: background-color var(--transition-normal), color var(--transition-normal);
            min-height: 100vh;
        }

        /* Header Styles */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-header h1 {
            font-size: 1.3rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .emergency-badge {
            background: var(--danger-color);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #darkModeToggle, #helpButton {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        #darkModeToggle:hover, #helpButton:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        /* Container Styles */
        .container {
            max-width: 800px;
            margin: 30px auto;
            padding: 30px;
            background-color: var(--container-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 30px;
            padding: 15px;
            background: linear-gradient(90deg, #f0f4f8 0%, #e2e8f0 100%);
            border-radius: 12px;
        }

        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--input-bg);
            border: 3px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all var(--transition-normal);
            position: relative;
        }

        .progress-step.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(0, 82, 155, 0.1);
        }

        .progress-step.completed {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .progress-step.completed::after {
            content: '✓';
            position: absolute;
            font-size: 1.2rem;
        }

        .progress-line {
            width: 60px;
            height: 3px;
            background: var(--border-color);
            transition: background var(--transition-normal);
        }

        .progress-line.completed {
            background: var(--success-color);
        }

        /* Typography */
        h2 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 10px;
            text-align: center;
        }

        h3 {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 20px;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1rem;
        }

        /* Triage Questions */
        .triage-question {
            text-align: center;
            font-size: 1.4rem;
            margin-bottom: 30px;
            color: var(--text-color);
            font-weight: 500;
        }

        .triage-question small {
            display: block;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: normal;
        }

        /* Button Styles */
        .triage-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .triage-buttons button {
            padding: 20px;
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-md);
        }

        .triage-buttons button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .triage-buttons button:hover::before {
            width: 300px;
            height: 300px;
        }

        .yes-btn { background: linear-gradient(135deg, var(--danger-color), #ff1744); }
        .yes-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212, 0, 26, 0.3); }

        .no-btn { background: linear-gradient(135deg, var(--success-color), #2ecc71); }
        .no-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3); }

        /* Form Styles */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-group, .checkbox-group {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--input-bg);
            transition: all var(--transition-fast);
        }

        .input-group:hover, .checkbox-group:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 82, 155, 0.1);
        }

        .input-group.error {
            border-color: var(--danger-color);
            background-color: rgba(212, 0, 26, 0.05);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-help {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        input[type="number"], select {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 2px solid transparent;
            border-radius: 8px;
            background-color: var(--container-bg);
            color: var(--text-color);
            transition: all var(--transition-fast);
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 82, 155, 0.1);
        }

        input[type="number"]:invalid { border-color: var(--danger-color); }

        .checkbox-group { display: flex; flex-direction: column; gap: 12px; }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background var(--transition-fast);
        }

        .checkbox-wrapper:hover { background: rgba(0, 82, 155, 0.05); }

        input[type="checkbox"] {
            width: 22px;
            height: 22px;
            margin-right: 12px;
            accent-color: var(--primary-color);
            cursor: pointer;
        }

        .checkbox-label { font-weight: normal; font-size: 1rem; flex: 1; }

        /* Primary and Secondary Buttons */
        button.primary {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        button.primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 82, 155, 0.3);
        }

        button.primary:active { transform: translateY(0); }

        button.secondary {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            background: transparent;
            color: var(--primary-color);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            margin-top: 15px;
        }

        button.secondary:hover {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-md);
        }

        button:disabled {
            background: #a0a0a0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Result Cards */
        .result-card {
            padding: 25px;
            border-radius: 16px;
            border-left: 6px solid;
            margin-bottom: 20px;
            animation: slideIn 0.4s ease;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .result-card.ich {
            background: linear-gradient(135deg, #fbe9e7 0%, #ffccbc 100%);
            color: #b71c1c;
            border-left-color: var(--danger-color);
        }

        .result-card.lvo {
            background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%);
            color: #01579b;
            border-left-color: var(--primary-color);
        }

        .result-card.info {
            background: linear-gradient(135deg, var(--info-bg) 0%, #ffe082 100%);
            color: var(--info-text);
            border-left-color: var(--info-border);
        }

        .result-card.critical {
            background: linear-gradient(135deg, var(--critical-bg) 0%, #f8bbd0 100%);
            color: var(--critical-text);
            border-left-color: var(--danger-color);
            animation: criticalPulse 2s infinite;
        }

        @keyframes criticalPulse {
            0%, 100% { box-shadow: var(--shadow-md); }
            50% { box-shadow: 0 0 20px rgba(212, 0, 26, 0.3); }
        }

        .result-card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-card h3 small {
            font-size: 0.8rem;
            opacity: 0.8;
            font-weight: normal;
        }

        .probability-display {
            font-size: 3rem;
            font-weight: bold;
            margin: 20px 0;
            text-align: center;
            position: relative;
        }

        .probability-meter {
            width: 100%;
            height: 30px;
            background: rgba(0,0,0,0.1);
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .probability-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #ffc107 50%, #f44336 100%);
            transition: width 1s ease;
            border-radius: 15px;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .probability-marker {
            position: absolute;
            top: -25px;
            transform: translateX(-50%);
            font-size: 0.8rem;
            font-weight: bold;
            padding: 2px 8px;
            background: var(--text-color);
            color: white;
            border-radius: 4px;
        }

        .probability-marker::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid var(--text-color);
        }

        /* Drivers Section */
        .drivers-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid var(--border-color);
        }

        .drivers-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        @media (min-width: 768px) {
            .drivers-grid { grid-template-columns: 1fr 1fr; }
        }

        .drivers-panel {
            background: var(--input-bg);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
        }

        .drivers-panel h4 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .driver-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }

        .driver-icon.ich { background: var(--danger-color); }
        .driver-icon.lvo { background: var(--primary-color); }

        .driver-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 8px;
            background: var(--container-bg);
            transition: all var(--transition-fast);
        }

        .driver-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-sm);
        }

        .driver-label {
            flex: 0 0 140px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .driver-bar-container {
            flex: 1;
            height: 22px;
            background: rgba(0,0,0,0.05);
            border-radius: 11px;
            overflow: hidden;
            position: relative;
        }

        .driver-bar {
            height: 100%;
            border-radius: 11px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .driver-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer { to { left: 100%; } }

        .driver-bar.positive { background: linear-gradient(90deg, #ff6b6b, #ff4757); }
        .driver-bar.negative { background: linear-gradient(90deg, #51cf66, #2ecc71); }

        .driver-value {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Critical Alert */
        .critical-alert {
            background: linear-gradient(135deg, var(--danger-color), #ff1744);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            animation: criticalAlert 2s infinite;
            box-shadow: var(--shadow-lg);
        }

        @keyframes criticalAlert {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .critical-alert h4 {
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-icon {
            font-size: 1.5rem;
            animation: alertBlink 1s infinite;
        }

        @keyframes alertBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Help Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 16px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-close {
            font-size: 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-secondary);
            transition: color var(--transition-fast);
        }

        .modal-close:hover { color: var(--danger-color); }

        /* Disclaimer */
        .disclaimer {
            background: var(--info-bg);
            color: var(--info-text);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--warning-color);
            font-size: 0.9rem;
        }

        .disclaimer strong { display: block; margin-bottom: 5px; }

        /* Footer */
        footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }

        .footer-links a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        .footer-links a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container { margin: 15px; padding: 20px; }
            .triage-buttons { grid-template-columns: 1fr; }
            .input-grid { grid-template-columns: 1fr; }
            .probability-display { font-size: 2.5rem; }
            .drivers-grid { grid-template-columns: 1fr; }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus Styles */
        *:focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Print Styles */
        @media print {
            body { padding-top: 0; }
            .app-header { position: static; box-shadow: none; }
            .container { box-shadow: none; border: 1px solid #000; }
            button { display: none; }
            .result-card { page-break-inside: avoid; }
        }

        /* Loading State */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Tooltips */
        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--text-color);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity var(--transition-fast);
            font-size: 0.85rem;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        /* Error States */
        .error-message {
            color: var(--danger-color);
            font-size: 0.85rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .error-icon { font-size: 1rem; }
    </style>
</head>
<body>
<header class="app-header" role="banner">
    <div class="header-content">
        <h1>Stroke Triage Assistant</h1>
        <span class="emergency-badge">Emergency Tool</span>
    </div>
    <div class="header-controls">
        <button id="helpButton" aria-label="Help and Instructions" title="Help">❓</button>
        <button id="darkModeToggle" aria-label="Toggle dark mode" title="Dark Mode">🌙</button>
    </div>
</header>

<main role="main">
    <div id="appContainer"></div>
</main>

<!-- Help Modal -->
<div id="helpModal" class="modal" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Quick Reference Guide</h2>
            <button class="modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <h3>Glasgow Coma Scale (GCS)</h3>
            <ul>
                <li><strong>GCS &lt; 8:</strong> Comatose patient - use Coma Module</li>
                <li><strong>GCS 8-12:</strong> Moderate impairment</li>
                <li><strong>GCS 13-15:</strong> Mild impairment</li>
            </ul>
            <h3>FAST-ED Score Components</h3>
            <ul>
                <li><strong>Facial Palsy:</strong> 0-1 points</li>
                <li><strong>Arm Weakness:</strong> 0-2 points</li>
                <li><strong>Speech Changes:</strong> 0-2 points</li>
                <li><strong>Time:</strong> Critical factor</li>
                <li><strong>Eye Deviation:</strong> 0-2 points</li>
                <li><strong>Denial/Neglect:</strong> 0-2 points</li>
            </ul>
            <h3>Critical Values</h3>
            <ul>
                <li><strong>Systolic BP &gt; 180:</strong> Increased ICH risk</li>
                <li><strong>GFAP &gt; 500 pg/mL:</strong> Significant marker</li>
                <li><strong>FAST-ED ≥ 4:</strong> Consider LVO</li>
            </ul>
            <div class="disclaimer">
                <strong>⚠️ Clinical Disclaimer:</strong>
                This tool is for clinical decision support only. Always use clinical judgment and follow local protocols. Not a replacement for physician assessment.
            </div>
        </div>
    </div>
</div>

<footer role="contentinfo">
    <p>© <span id="currentYear"></span> iGFAP Project - Professional Edition</p>
    <div class="footer-links">
        <a href="#" id="privacyLink">Privacy Policy</a>
        <a href="#" id="disclaimerLink">Medical Disclaimer</a>
        <a href="#" id="versionLink">Version 2.0.1</a>
    </div>
</footer>

<script>
'use strict';

// Enhanced Application with safety features and error handling
const App = {
  container: null,
  state: {
    currentScreen: 'triage1',
    results: null,
    sessionId: null,
    startTime: null,
    formData: {},
    validationErrors: {}
  },

  // Configuration
  config: {
    autoSaveInterval: 5000,
    sessionTimeout: 30 * 60 * 1000, // 30 minutes
    criticalThresholds: {
      ich: { high: 60, critical: 80 },
      lvo: { high: 50, critical: 70 }
    },
    gfapRanges: { min: 29, max: 10001, normal: 100, elevated: 500, critical: 1000 }
  },

  init() {
    this.container = document.getElementById('appContainer');
    if (!this.container) {
      console.error('App container not found');
      return;
    }
    this.state.sessionId = this.generateSessionId();
    this.state.startTime = Date.now();
    this.setupEventListeners();
    this.initializeTheme();
    this.render();
    this.startAutoSave();
    this.setupSessionTimeout();

    // Set current year
    const yearElement = document.getElementById('currentYear');
    if (yearElement) {
      yearElement.textContent = new Date().getFullYear();
    }
    console.log('App initialized with session:', this.state.sessionId);
  },

  generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  },

  setupEventListeners() {
    // Dark mode toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    if (darkModeToggle) {
      darkModeToggle.addEventListener('click', () => this.toggleDarkMode());
    }

    // Help modal
    const helpButton = document.getElementById('helpButton');
    const helpModal = document.getElementById('helpModal');
    const modalClose = helpModal?.querySelector('.modal-close');

    if (helpButton && helpModal) {
      helpButton.addEventListener('click', () => {
        helpModal.classList.add('show');
        helpModal.setAttribute('aria-hidden', 'false');
      });
      modalClose?.addEventListener('click', () => {
        helpModal.classList.remove('show');
        helpModal.setAttribute('aria-hidden', 'true');
      });
      helpModal.addEventListener('click', (e) => {
        if (e.target === helpModal) {
          helpModal.classList.remove('show');
          helpModal.setAttribute('aria-hidden', 'true');
        }
      });
    }

    // Footer links
    document.getElementById('privacyLink')?.addEventListener('click', (e) => {
      e.preventDefault();
      this.showPrivacyPolicy();
    });
    document.getElementById('disclaimerLink')?.addEventListener('click', (e) => {
      e.preventDefault();
      this.showDisclaimer();
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const helpModalEsc = document.getElementById('helpModal');
        helpModalEsc?.classList.remove('show');
      }
    });

    // Before unload warning
    window.addEventListener('beforeunload', (e) => {
      if (this.hasUnsavedData()) {
        e.preventDefault();
        e.returnValue = 'You have unsaved data. Are you sure you want to leave?';
      }
    });
  },

  initializeTheme() {
    const savedTheme = localStorage.getItem('theme');
    const darkModeToggle = document.getElementById('darkModeToggle');
    if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.body.classList.add('dark-mode');
      if (darkModeToggle) darkModeToggle.textContent = '☀️';
    }
  },

  toggleDarkMode() {
    const darkModeToggle = document.getElementById('darkModeToggle');
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    if (darkModeToggle) {
      darkModeToggle.textContent = isDark ? '☀️' : '🌙';
    }
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  },

  startAutoSave() {
    setInterval(() => { this.saveFormData(); }, this.config.autoSaveInterval);
  },

  saveFormData() {
    const forms = this.container.querySelectorAll('form');
    forms.forEach(form => {
      const formData = new FormData(form);
      const module = form.dataset.module;
      if (module) {
        this.state.formData[module] = {};
        formData.forEach((value, key) => {
          this.state.formData[module][key] = value;
        });
      }
    });
  },

  restoreFormData(module) {
    if (!this.state.formData[module]) return;
    const form = this.container.querySelector(`form[data-module="${module}"]`);
    if (!form) return;
    Object.entries(this.state.formData[module]).forEach(([key, value]) => {
      const input = form.elements[key];
      if (input) {
        if (input.type === 'checkbox') {
          input.checked = value === 'on' || value === true || value === 'true';
        } else {
          input.value = value;
        }
      }
    });
  },

  setupSessionTimeout() {
    setTimeout(() => {
      if (confirm('Your session has been idle for 30 minutes. Would you like to continue?')) {
        this.setupSessionTimeout();
      } else {
        this.reset();
      }
    }, this.config.sessionTimeout);
  },

  hasUnsavedData() {
    return Object.keys(this.state.formData).length > 0 && !this.state.results;
  },

  navigate(screen) {
    this.logEvent('navigate', { from: this.state.currentScreen, to: screen });
    this.state.currentScreen = screen;
    this.render();
    window.scrollTo(0, 0);
    // Announce screen change for screen readers
    this.announceScreenChange(screen);
  },

  announceScreenChange(screen) {
    const announcement = document.createElement('div');
    announcement.className = 'sr-only';
    announcement.setAttribute('role', 'status');
    announcement.setAttribute('aria-live', 'polite');
    const screenNames = {
      'triage1': 'Coma assessment',
      'triage2': 'Examination capability assessment',
      'coma': 'Coma module',
      'limited': 'Limited data module',
      'full': 'Full stroke assessment',
      'results': 'Assessment results'
    };
    announcement.textContent = `Navigated to ${screenNames[screen] || screen}`;
    document.body.appendChild(announcement);
    setTimeout(() => announcement.remove(), 1000);
  },

  handleTriage1(isComatose) {
    this.logEvent('triage1_answer', { comatose: isComatose });
    this.navigate(isComatose ? 'coma' : 'triage2');
  },

  handleTriage2(isExaminable) {
    this.logEvent('triage2_answer', { examinable: isExaminable });
    this.navigate(isExaminable ? 'full' : 'limited');
  },

  reset() {
    if (this.hasUnsavedData()) {
      if (!confirm('Are you sure you want to start over? All entered data will be lost.')) {
        return;
      }
    }
    this.logEvent('reset');
    this.state = {
      currentScreen: 'triage1',
      results: null,
      sessionId: this.generateSessionId(),
      startTime: Date.now(),
      formData: {},
      validationErrors: {}
    };
    this.render();
  },

  validateInput(name, value, rules) {
    const errors = [];
    if (rules.required && !value && value !== 0) {
      errors.push('This field is required');
    }
    if (rules.min !== undefined && value !== '' && !isNaN(value) && parseFloat(value) < rules.min) {
      errors.push(`Value must be at least ${rules.min}`);
    }
    if (rules.max !== undefined && value !== '' && !isNaN(value) && parseFloat(value) > rules.max) {
      errors.push(`Value must be at most ${rules.max}`);
    }
    if (rules.pattern && !rules.pattern.test(value)) {
      errors.push('Invalid format');
    }
    return errors;
  },

  validateForm(form) {
    const validationRules = {
      age_years: { required: true, min: 0, max: 120 },
      systolic_bp: { required: true, min: 60, max: 300 },
      diastolic_bp: { required: true, min: 30, max: 200 },
      gfap_value: { required: true, min: this.config.gfapRanges.min, max: this.config.gfapRanges.max },
      fast_ed_score: { required: true, min: 0, max: 9 }
    };

    let isValid = true;
    this.state.validationErrors = {};

    Object.entries(validationRules).forEach(([name, rules]) => {
      const input = form.elements[name];
      if (input) {
        const errors = this.validateInput(name, input.value, rules);
        if (errors.length > 0) {
          this.state.validationErrors[name] = errors;
          isValid = false;
        }
      }
    });
    return isValid;
  },

  async runModels(inputs, module) {
    this.logEvent('run_models', { module, inputs });
    return new Promise((resolve) => {
      // Simulate processing time
      setTimeout(() => {
        const results = this.calculateResults(inputs, module);
        this.state.results = results;
        this.logEvent('models_complete', { module, results });
        resolve(results);
      }, 1500);
    });
  },

  calculateResults(inputs, module) {
    let results = {};

    if (module === 'coma') {
      // Coma module: ICH prediction only
      const logGFAP = Math.log10(Math.max(inputs.gfap_value, 1));
      const logit = -6.30 + 2.25 * logGFAP;
      const probability = 1 / (1 + Math.exp(-logit));

      results.ich = {
        probability: Math.min(Math.max(probability, 0.01), 0.99),
        module: 'Coma',
        drivers: this.calculateDrivers(inputs, 'ich', module),
        confidence: this.calculateConfidence(inputs, module)
      };

    } else if (module === 'limited') {
      // Limited module: ICH prediction only
      let ichScore = 0;

      // Risk factors
      if (inputs.systolic_bp > 180) ichScore += 3;
      else if (inputs.systolic_bp > 160) ichScore += 2;
      else if (inputs.systolic_bp > 140) ichScore += 1;

      if (inputs.gfap_value > this.config.gfapRanges.critical) ichScore += 4;
      else if (inputs.gfap_value > this.config.gfapRanges.elevated) ichScore += 3;
      else if (inputs.gfap_value > this.config.gfapRanges.normal) ichScore += 1;

      if (inputs.vigilanzminderung) ichScore += 2;
      if (inputs.age_years > 75) ichScore += 1;

      const ichProb = Math.min(0.05 + (ichScore * 0.1), 0.95);
      results.ich = {
        probability: ichProb,
        module: 'Limited Data',
        drivers: this.calculateDrivers(inputs, 'ich', module),
        confidence: this.calculateConfidence(inputs, module)
      };
      results.lvo = { notPossible: true };

    } else if (module === 'full') {
      // Full module: Both ICH and LVO predictions

      // ICH calculation
      let ichScore = 0;
      if (inputs.systolic_bp > 180) ichScore += 2;
      else if (inputs.systolic_bp > 160) ichScore += 1.5;
      else if (inputs.systolic_bp > 140) ichScore += 0.5;

      if (inputs.gfap_value > this.config.gfapRanges.critical) ichScore += 3;
      else if (inputs.gfap_value > this.config.gfapRanges.elevated) ichScore += 2;
      else if (inputs.gfap_value > this.config.gfapRanges.normal) ichScore += 1;

      if (inputs.headache) ichScore += 2;
      if (inputs.vigilanzminderung) ichScore += 1.5;
      if (inputs.anticoagulated_noak) ichScore += 1;

      const ichProb = Math.min(0.05 + (ichScore * 0.08), 0.95);
      results.ich = {
        probability: ichProb,
        module: 'Full Stroke',
        drivers: this.calculateDrivers(inputs, 'ich', module),
        confidence: this.calculateConfidence(inputs, module)
      };

      // LVO calculation
      let lvoScore = 0;
      if (inputs.fast_ed_score >= 6) lvoScore += 4;
      else if (inputs.fast_ed_score >= 4) lvoScore += 3;
      else if (inputs.fast_ed_score >= 2) lvoScore += 1;

      if (inputs.eye_deviation) lvoScore += 2.5;
      if (inputs.armparese) lvoScore += 2;
      if (inputs.beinparese) lvoScore += 1.5;
      if (inputs.atrial_fibrillation) lvoScore += 1;

      // Negative predictors
      if (inputs.systolic_bp < 120) lvoScore -= 1;
      if (inputs.age_years < 50) lvoScore -= 0.5;

      const lvoProb = Math.min(Math.max(0.05 + (lvoScore * 0.1), 0.01), 0.95);
      results.lvo = {
        probability: lvoProb,
        module: 'Full Stroke',
        drivers: this.calculateDrivers(inputs, 'lvo', module),
        confidence: this.calculateConfidence(inputs, module)
      };
    }

    return results;
  },

  calculateDrivers(inputs, type, module) {
    const drivers = {};
    if (type === 'ich') {
      // ICH drivers
      if (inputs.gfap_value !== undefined) {
        const gfapImpact = this.normalizeImpact(inputs.gfap_value, this.config.gfapRanges.min, this.config.gfapRanges.critical);
        drivers['GFAP Value'] = gfapImpact * 0.5;
      }
      if (inputs.systolic_bp !== undefined) {
        const bpImpact = this.normalizeImpact(inputs.systolic_bp, 120, 200);
        drivers['Systolic BP'] = bpImpact * 0.3;
      }
      if (inputs.headache !== undefined && inputs.headache) {
        drivers['Headache'] = 0.2;
      }
      if (inputs.vigilanzminderung !== undefined && inputs.vigilanzminderung) {
        drivers['Vigilance↓'] = 0.15;
      }
      if (inputs.age_years !== undefined) {
        const ageImpact = this.normalizeImpact(inputs.age_years, 40, 80);
        drivers['Age'] = ageImpact * -0.1;
      }
    } else if (type === 'lvo') {
      // LVO drivers
      if (inputs.fast_ed_score !== undefined) {
        const fastImpact = this.normalizeImpact(inputs.fast_ed_score, 0, 9);
        drivers['FAST-ED'] = fastImpact * 0.6;
      }
      if (inputs.eye_deviation !== undefined && inputs.eye_deviation) {
        drivers['Eye Deviation'] = 0.3;
      }
      if (inputs.armparese !== undefined && inputs.armparese) {
        drivers['Arm Paresis'] = 0.25;
      }
      if (inputs.beinparese !== undefined && inputs.beinparese) {
        drivers['Leg Paresis'] = 0.2;
      }
      if (inputs.atrial_fibrillation !== undefined && inputs.atrial_fibrillation) {
        drivers['Atrial Fib'] = 0.15;
      }
      if (inputs.systolic_bp !== undefined && inputs.systolic_bp < 120) {
        drivers['Low BP'] = -0.2;
      }
    }
    return drivers;
  },

  normalizeImpact(value, min, max) {
    return Math.max(0, Math.min(1, (value - min) / (max - min)));
  },

  calculateConfidence(inputs, module) {
    // Calculate confidence based on data completeness and quality
    let confidence = 0.5; // Base confidence
    if (module === 'full') {
      confidence = 0.85; // Full data available
    } else if (module === 'limited') {
      confidence = 0.65; // Limited data
    } else if (module === 'coma') {
      confidence = 0.75; // Single strong predictor
    }
    // Adjust based on GFAP value reliability
    if (inputs.gfap_value > this.config.gfapRanges.critical) {
      confidence += 0.1;
    }
    return Math.min(confidence, 0.95);
  },

  async handleSubmit(e, module) {
    e.preventDefault();
    const form = e.target;

    // Validate form
    if (!this.validateForm(form)) {
      this.showValidationErrors();
      return;
    }

    // Collect inputs
    const formData = new FormData(form);
    const inputs = {};
    formData.forEach((value, key) => {
      const element = form.elements[key];
      if (element && element.type === 'checkbox') {
        inputs[key] = element.checked;
      } else {
        const n = parseFloat(value);
        inputs[key] = isNaN(n) ? value : n;
      }
    });

    // Show loading state
    const button = form.querySelector('button[type=submit]');
    const originalContent = button ? button.innerHTML : '';
    if (button) {
      button.disabled = true;
      button.innerHTML = '<span class="loading-spinner"></span> Analyzing...';
    }

    try {
      // Run models
      await this.runModels(inputs, module);
      this.navigate('results');
    } catch (error) {
      console.error('Error running models:', error);
      this.showError('An error occurred during analysis. Please try again.');
      if (button) {
        button.disabled = false;
        button.innerHTML = originalContent;
      }
    }
  },

  showValidationErrors() {
    Object.entries(this.state.validationErrors).forEach(([name, errors]) => {
      const input = this.container.querySelector(`[name="${name}"]`);
      if (input) {
        const group = input.closest('.input-group');
        if (group) {
          group.classList.add('error');
          // Remove existing error messages
          group.querySelectorAll('.error-message').forEach(el => el.remove());
          // Add new error message
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error-message';
          errorDiv.innerHTML = `<span class="error-icon">⚠️</span> ${errors[0]}`;
          group.appendChild(errorDiv);
        }
      }
    });
  },

  showError(message) {
    const alert = document.createElement('div');
    alert.className = 'critical-alert';
    alert.innerHTML = `<h4><span class="alert-icon">⚠️</span> Error</h4><p>${message}</p>`;
    this.container.prepend(alert);
    setTimeout(() => alert.remove(), 5000);
  },

  showPrivacyPolicy() {
    alert('Privacy Policy: This tool processes data locally. No patient data is stored or transmitted.');
  },

  showDisclaimer() {
    alert('Medical Disclaimer: This tool is for clinical decision support only. Always use clinical judgment and follow local protocols.');
  },

  logEvent(eventName, data = {}) {
    // Log events for audit trail
    const event = {
      timestamp: Date.now(),
      session: this.state.sessionId,
      event: eventName,
      data: data
    };
    console.log('Event:', event);
    // In production, send to analytics service
    // this.sendToAnalytics(event);
  },

  render() {
    const screens = {
      triage1: this.renderTriage1,
      triage2: this.renderTriage2,
      coma: this.renderComaModule,
      limited: this.renderLimitedModule,
      full: this.renderFullModule,
      results: this.renderResults
    };

    const renderFunction = screens[this.state.currentScreen] || this.renderTriage1;
    this.container.innerHTML = renderFunction.call(this);

    // Restore form data if available
    const form = this.container.querySelector('form');
    if (form && form.dataset.module) {
      this.restoreFormData(form.dataset.module);
    }

    this.attachDynamicEventListeners();
  },

  attachDynamicEventListeners() {
    // Triage buttons
    this.container.querySelectorAll('[data-action]').forEach(button => {
      button.addEventListener('click', (e) => {
        const { action, value } = e.currentTarget.dataset;
        const boolVal = value === 'true';
        if (action === 'triage1') this.handleTriage1(boolVal);
        else if (action === 'triage2') this.handleTriage2(boolVal);
        else if (action === 'reset') this.reset();
      });
    });

    // Form submissions
    this.container.querySelectorAll('form[data-module]').forEach(form => {
      form.addEventListener('submit', (e) => {
        this.handleSubmit(e, form.dataset.module);
      });
    });

    // Input validation visual reset
    this.container.querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener('blur', () => {
        const group = input.closest('.input-group');
        if (group) {
          group.classList.remove('error');
          group.querySelectorAll('.error-message').forEach(el => el.remove());
        }
      });
    });

    // Print button
    const printButton = this.container.querySelector('#printResults');
    if (printButton) {
      printButton.addEventListener('click', () => window.print());
    }
  },

  renderProgressIndicator(currentStep) {
    const steps = [
      { id: 1, label: 'Triage' },
      { id: 2, label: 'Assessment' },
      { id: 3, label: 'Results' }
    ];
    let html = `<div class="progress-indicator">`;
    steps.forEach((step, index) => {
      const isActive = step.id === currentStep;
      const isCompleted = step.id < currentStep;
      html += `
        <div class="progress-step ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">
          ${isCompleted ? '' : step.id}
        </div>
      `;
      if (index < steps.length - 1) {
        html += `<div class="progress-line ${isCompleted ? 'completed' : ''}"></div>`;
      }
    });
    html += `</div>`;
    return html;
  },

  renderTriage1() {
    return `
      <div class="container">
        ${this.renderProgressIndicator(1)}
        <h2>Initial Assessment</h2>
        <p class="subtitle">Emergency Stroke Triage Protocol</p>
        <div class="triage-question">
          Is the patient comatose?
          <small>Glasgow Coma Scale &lt; 8</small>
        </div>
        <div class="disclaimer">
          <strong>⚠️ Time-Critical Assessment</strong>
          Every minute counts in stroke care. Complete assessment rapidly while maintaining accuracy.
        </div>
        <div class="triage-buttons">
          <button class="yes-btn" data-action="triage1" data-value="true">YES - Comatose</button>
          <button class="no-btn" data-action="triage1" data-value="false">NO - Conscious</button>
        </div>
      </div>
    `;
  },

  renderTriage2() {
    return `
      <div class="container">
        ${this.renderProgressIndicator(1)}
        <h2>Examination Capability</h2>
        <p class="subtitle">Determine Assessment Module</p>
        <div class="triage-question">
          Can the patient be reliably examined?
          <small>Patient is not aphasic, confused, or uncooperative</small>
        </div>
        <div class="triage-buttons">
          <button class="yes-btn" data-action="triage2" data-value="true">YES - Full Exam Possible</button>
          <button class="no-btn" data-action="triage2" data-value="false">NO - Limited Exam Only</button>
        </div>
      </div>
    `;
  },

  renderComaModule() {
    return `
      <div class="container">
        ${this.renderProgressIndicator(2)}
        <h2>Coma Module</h2>
        <p class="subtitle">ICH Risk Assessment for Comatose Patients</p>
        <div class="critical-alert">
          <h4><span class="alert-icon">🚨</span> Critical Patient</h4>
          <p>Patient is comatose (GCS &lt; 8). Rapid assessment required.</p>
        </div>
        <form data-module="coma">
          <div class="input-grid">
            <div class="input-group">
              <label for="gfap_value">
                GFAP Value (pg/mL)
                <span class="tooltip">ℹ️
                  <span class="tooltiptext">Glial Fibrillary Acidic Protein - Brain injury biomarker</span>
                </span>
              </label>
              <input type="number" id="gfap_value" name="gfap_value" min="${this.config.gfapRanges.min}" max="${this.config.gfapRanges.max}" step="0.1" required aria-describedby="gfap-help">
              <div id="gfap-help" class="input-help">
                Range: ${this.config.gfapRanges.min} - ${this.config.gfapRanges.max} pg/mL
              </div>
            </div>
          </div>
          <button type="submit" class="primary">Analyze ICH Risk</button>
          <button type="button" class="secondary" data-action="reset">Start Over</button>
        </form>
      </div>
    `;
  },

  renderLimitedModule() {
    return `
      <div class="container">
        ${this.renderProgressIndicator(2)}
        <h2>Limited Data Module</h2>
        <p class="subtitle">ICH Risk Assessment with Limited Examination</p>
        <form data-module="limited">
          <div class="input-grid">
            <div class="input-group">
              <label for="age_years">Age (years)</label>
              <input type="number" name="age_years" id="age_years" min="0" max="120" required aria-describedby="age-help">
              <div id="age-help" class="input-help">Patient's age in years</div>
            </div>
            <div class="input-group">
              <label for="systolic_bp">Systolic BP (mmHg)</label>
              <input type="number" name="systolic_bp" id="systolic_bp" min="60" max="300" required aria-describedby="sbp-help">
              <div id="sbp-help" class="input-help">Normal: 90-140 mmHg</div>
            </div>
            <div class="input-group">
              <label for="diastolic_bp">Diastolic BP (mmHg)</label>
              <input type="number" name="diastolic_bp" id="diastolic_bp" min="30" max="200" required aria-describedby="dbp-help">
              <div id="dbp-help" class="input-help">Normal: 60-90 mmHg</div>
            </div>
            <div class="input-group">
              <label for="gfap_value">
                GFAP Value (pg/mL)
                <span class="tooltip">ℹ️
                  <span class="tooltiptext">Glial Fibrillary Acidic Protein</span>
                </span>
              </label>
              <input type="number" name="gfap_value" id="gfap_value" min="${this.config.gfapRanges.min}" max="${this.config.gfapRanges.max}" step="0.1" required>
            </div>
          </div>
          <div class="checkbox-group">
            <label class="checkbox-wrapper">
              <input type="checkbox" name="vigilanzminderung" id="vigilanzminderung">
              <span class="checkbox-label">Vigilance Reduction (Decreased alertness)</span>
            </label>
          </div>
          <button type="submit" class="primary">Analyze ICH Risk</button>
          <button type="button" class="secondary" data-action="reset">Start Over</button>
        </form>
      </div>
    `;
  },

  renderFullModule() {
    return `
      <div class="container">
        ${this.renderProgressIndicator(2)}
        <h2>Full Stroke Module</h2>
        <p class="subtitle">Complete ICH and LVO Risk Assessment</p>
        <form data-module="full">
          <h3>Basic Information</h3>
          <div class="input-grid">
            <div class="input-group">
              <label for="age_years">Age (years)</label>
              <input type="number" name="age_years" id="age_years" min="0" max="120" required>
            </div>
            <div class="input-group">
              <label for="systolic_bp">Systolic BP (mmHg)</label>
              <input type="number" name="systolic_bp" id="systolic_bp" min="60" max="300" required>
            </div>
            <div class="input-group">
              <label for="diastolic_bp">Diastolic BP (mmHg)</label>
              <input type="number" name="diastolic_bp" id="diastolic_bp" min="30" max="200" required>
            </div>
          </div>

          <h3>Biomarkers & Scores</h3>
          <div class="input-grid">
            <div class="input-group">
              <label for="gfap_value">
                GFAP Value (pg/mL)
                <span class="tooltip">ℹ️
                  <span class="tooltiptext">Brain injury biomarker</span>
                </span>
              </label>
              <input type="number" name="gfap_value" id="gfap_value" min="${this.config.gfapRanges.min}" max="${this.config.gfapRanges.max}" step="0.1" required>
            </div>
            <div class="input-group">
              <label for="fast_ed_score">
                FAST-ED Score
                <span class="tooltip">ℹ️
                  <span class="tooltiptext">0-9 scale for LVO screening</span>
                </span>
              </label>
              <input type="number" name="fast_ed_score" id="fast_ed_score" min="0" max="9" required>
            </div>
          </div>

          <h3>Clinical Symptoms</h3>
          <div class="input-grid">
            <div class="checkbox-group">
              <label class="checkbox-wrapper">
                <input type="checkbox" name="headache" id="headache">
                <span class="checkbox-label">Headache</span>
              </label>
              <label class="checkbox-wrapper">
                <input type="checkbox" name="vigilanzminderung" id="vigilanzminderung">
                <span class="checkbox-label">Vigilance Reduction</span>
              </label>
            </div>
            <div class="checkbox-group">
              <label class="checkbox-wrapper">
                <input type="checkbox" name="armparese" id="armparese">
                <span class="checkbox-label">Arm Paresis</span>
              </label>
              <label class="checkbox-wrapper">
                <input type="checkbox" name="beinparese" id="beinparese">
                <span class="checkbox-label">Leg Paresis</span>
              </label>
            </div>
            <div class="checkbox-group">
              <label class="checkbox-wrapper">
                <input type="checkbox" name="eye_deviation" id="eye_deviation">
                <span class="checkbox-label">Eye Deviation</span>
              </label>
            </div>
          </div>

          <h3>Medical History</h3>
          <div class="input-grid">
            <div class="checkbox-group">
              <label class="checkbox-wrapper">
                <input type="checkbox" name="atrial_fibrillation" id="atrial_fibrillation">
                <span class="checkbox-label">Atrial Fibrillation</span>
              </label>
            </div>
            <div class="checkbox-group">
              <label class="checkbox-wrapper">
                <input type="checkbox" name="anticoagulated_noak" id="anticoagulated_noak">
                <span class="checkbox-label">On NOAC/DOAC</span>
              </label>
            </div>
            <div class="checkbox-group">
              <label class="checkbox-wrapper">
                <input type="checkbox" name="antiplatelets" id="antiplatelets">
                <span class="checkbox-label">On Antiplatelets</span>
              </label>
            </div>
          </div>

          <button type="submit" class="primary">Analyze Stroke Risk</button>
          <button type="button" class="secondary" data-action="reset">Start Over</button>
        </form>
      </div>
    `;
  },

  renderResults() {
    const { ich, lvo } = this.state.results;
    let ichHtml = '', lvoHtml = '', recommendationsHtml = '';

    // Calculate recommendations
    const recommendations = this.generateRecommendations(ich, lvo);

    if (ich) {
      const ichPercent = Math.round(ich.probability * 100);
      const isCritical = ichPercent > this.config.criticalThresholds.ich.critical;
      // const isHigh = ichPercent > this.config.criticalThresholds.ich.high; // available if needed

      ichHtml = `
        <div class="result-card ${isCritical ? 'critical' : 'ich'}">
          <h3> 🧠 ICH Probability <small>(${ich.module} Module)</small> </h3>
          <div class="probability-display">${ichPercent}%</div>
          <div class="probability-meter">
            <div class="probability-fill" style="width: ${ichPercent}%"></div>
            <div class="probability-marker" style="left: ${ichPercent}%">${ichPercent}%</div>
          </div>
          <p><strong>Risk Level:</strong> ${this.getRiskLevel(ichPercent, 'ich')}</p>
          <p><strong>Confidence:</strong> ${(ich.confidence * 100).toFixed(0)}%</p>
        </div>
      `;
    }

    if (lvo) {
      if (lvo.notPossible) {
        lvoHtml = `
          <div class="result-card info">
            <h3>🔍 LVO Prediction</h3>
            <p>LVO assessment not possible with limited data.</p>
            <p>A full neurological examination is required for LVO screening.</p>
          </div>
        `;
      } else {
        const lvoPercent = Math.round(lvo.probability * 100);
        const isCritical = lvoPercent > this.config.criticalThresholds.lvo.critical;
        // const isHigh = lvoPercent > this.config.criticalThresholds.lvo.high;

        lvoHtml = `
          <div class="result-card ${isCritical ? 'critical' : 'lvo'}">
            <h3> 🩸 LVO Probability <small>(${lvo.module} Module)</small> </h3>
            <div class="probability-display">${lvoPercent}%</div>
            <div class="probability-meter">
              <div class="probability-fill" style="width: ${lvoPercent}%"></div>
              <div class="probability-marker" style="left: ${lvoPercent}%">${lvoPercent}%</div>
            </div>
            <p><strong>Risk Level:</strong> ${this.getRiskLevel(lvoPercent, 'lvo')}</p>
            <p><strong>Confidence:</strong> ${(lvo.confidence * 100).toFixed(0)}%</p>
          </div>
        `;
      }
    }

    // Recommendations section
    recommendationsHtml = `
      <div class="result-card info">
        <h3>📋 Clinical Recommendations</h3>
        <ul style="text-align: left; margin: 10px 0;">
          ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
        </ul>
        <p style="margin-top: 15px;">
          <strong>Time since assessment started:</strong> ${this.formatTime(Date.now() - this.state.startTime)}
        </p>
      </div>
    `;

    // Drivers visualization
    const driversHtml = this.renderDriversSection(ich, lvo);

    return `
      <div class="container">
        ${this.renderProgressIndicator(3)}
        <h2>Assessment Results</h2>
        <p class="subtitle">Clinical Decision Support Analysis</p>
        ${ich && ich.probability > 0.6 ? this.renderCriticalAlert() : ''}
        <div style="display: flex; flex-direction: column; gap: 20px;">
          ${ichHtml}
          ${lvoHtml}
          ${recommendationsHtml}
        </div>
        ${driversHtml}
        <button type="button" class="primary" id="printResults"> 📄 Print Results </button>
        <button type="button" class="secondary" data-action="reset"> Start New Assessment </button>
        <div class="disclaimer">
          <strong>⚠️ Important:</strong> These results are for clinical decision support only. Always use clinical judgment and follow institutional protocols. Results generated at ${new Date().toLocaleTimeString()}.
        </div>
      </div>
    `;
  },

  renderCriticalAlert() {
    return `
      <div class="critical-alert">
        <h4><span class="alert-icon">🚨</span> CRITICAL FINDING</h4>
        <p>High probability of intracerebral hemorrhage detected.</p>
        <p><strong>Immediate actions required:</strong></p>
        <ul style="margin: 10px 0; padding-left: 20px;">
          <li>Initiate stroke protocol immediately</li>
          <li>Urgent CT imaging required</li>
          <li>Consider blood pressure management</li>
          <li>Prepare for potential neurosurgical consultation</li>
        </ul>
      </div>
    `;
  },

  renderDriversSection(ich, lvo) {
    if (!ich?.drivers && !lvo?.drivers) return '';
    let html = `
      <div class="drivers-section">
        <h3>Prediction Drivers</h3>
        <div class="drivers-grid">
    `;
    if (ich?.drivers) {
      html += this.renderDriversPanel(ich.drivers, 'ICH', 'ich');
    }
    if (lvo?.drivers && !lvo.notPossible) {
      html += this.renderDriversPanel(lvo.drivers, 'LVO', 'lvo');
    }
    html += `
        </div>
      </div>
    `;
    return html;
  },

  renderDriversPanel(drivers, title, type) {
    if (!drivers || Object.keys(drivers).length === 0) return '';
    const sorted = Object.entries(drivers).sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));
    const maxAbs = Math.max(...sorted.map(([, val]) => Math.abs(val)));
    let html = `
      <div class="drivers-panel">
        <h4>
          <span class="driver-icon ${type}">${type === 'ich' ? 'I' : 'L'}</span>
          ${title} Risk Factors
        </h4>
    `;
    sorted.forEach(([feature, impact]) => {
      const percentage = Math.abs(impact) * 100;
      const width = maxAbs > 0 ? (Math.abs(impact) / maxAbs) * 100 : 0;
      const isPositive = impact >= 0;
      html += `
        <div class="driver-item">
          <span class="driver-label">${feature}</span>
          <div class="driver-bar-container">
            <div class="driver-bar ${isPositive ? 'positive' : 'negative'}" style="width: ${width}%">
              <span class="driver-value">${isPositive ? '+' : ''}${percentage.toFixed(0)}%</span>
            </div>
          </div>
        </div>
      `;
    });
    html += `</div>`;
    return html;
  },

  getRiskLevel(probabilityPercent, type) {
    const p = Number(probabilityPercent);
    const thresholds = this.config.criticalThresholds[type];
    if (p >= thresholds.critical) {
      return '🔴 CRITICAL RISK';
    } else if (p >= thresholds.high) {
      return '🟠 HIGH RISK';
    } else if (p >= 30) {
      return '🟡 MODERATE RISK';
    } else {
      return '🟢 LOW RISK';
    }
  },

  generateRecommendations(ich, lvo) {
    const recommendations = [];
    if (ich) {
      const ichPercent = ich.probability * 100;
      if (ichPercent > 80) {
        recommendations.push('🚨 IMMEDIATE: Urgent CT imaging required');
        recommendations.push('🚨 Consider immediate BP management if SBP > 150');
        recommendations.push('🚨 Prepare for potential neurosurgical consultation');
      } else if (ichPercent > 60) {
        recommendations.push('⚠️ HIGH PRIORITY: Expedite CT imaging');
        recommendations.push('⚠️ Monitor blood pressure closely');
        recommendations.push('⚠️ Consider withholding anticoagulation');
      } else if (ichPercent > 30) {
        recommendations.push('📍 Standard stroke protocol with close monitoring');
        recommendations.push('📍 Obtain CT imaging as per protocol');
      } else {
        recommendations.push('✓ Low ICH risk - proceed with standard evaluation');
      }
    }
    if (lvo && !lvo.notPossible) {
      const lvoPercent = lvo.probability * 100;
      if (lvoPercent > 70) {
        recommendations.push('🚁 Consider direct transport to comprehensive stroke center');
        recommendations.push('🚁 Alert interventional team for potential thrombectomy');
      } else if (lvoPercent > 50) {
        recommendations.push('🏥 Transport to stroke-capable facility');
        recommendations.push('🏥 Consider CTA for LVO confirmation');
      } else if (lvoPercent > 30) {
        recommendations.push('📊 Moderate LVO risk - standard stroke evaluation');
      }
    }
    // Time-based recommendations
    recommendations.push('⏱️ Document symptom onset time accurately');
    recommendations.push('📞 Notify receiving facility early for resource preparation');
    return recommendations;
  },

  formatTime(milliseconds) {
    const seconds = Math.floor(milliseconds / 1000);
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
  }
};

// Initialize app when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  App.init();
});
</script>
</body>
</html>
