<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stroke Triage Assistant</title>
    <style>
        :root {
            --primary-color: #007bff; --primary-hover: #0056b3; --background-color: #f4f7f9;
            --container-bg: #ffffff; --text-color: #333; --border-color: #dee2e6; --input-bg: #f8f9fa;
            
            /* Triage Card Colors */
            --lvo-bg: #e1f5fe; --lvo-text: #01579b; --lvo-border: #0288d1;
            --ich-bg: #fbe9e7; --ich-text: #b71c1c; --ich-border: #d84315;
            --unclear-bg: #fffde7; --unclear-text: #f57f17; --unclear-border: #fbc02d;
            --mimic-bg: #e8f5e9; --mimic-text: #1b5e20; --mimic-border: #388e3c;
            
            --driver-positive-bg: #e74c3c; --driver-negative-bg: #3498db;
            --meter-green: #28a745; --meter-yellow: #ffc107; --meter-red: #dc3545;
        }

        body.dark-mode {
            --primary-color: #409eff; --primary-hover: #3a8ee6; --background-color: #121212;
            --container-bg: #1e1e1e; --text-color: #f1f1f1; --border-color: #444; --input-bg: #2a2a2a;

            --lvo-bg: #1a3a5b; --lvo-text: #b3e5fc; --lvo-border: #4fc3f7;
            --ich-bg: #5c2a30; --ich-text: #ffcdd2; --ich-border: #ff8a65;
            --unclear-bg: #4d442a; --unclear-text: #fff59d; --unclear-border: #ffee58;
            --mimic-bg: #2a5032; --mimic-text: #c8e6c9; --mimic-border: #81c784;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0; 
            padding: 80px 15px 40px; 
            background-color: var(--background-color); 
            color: var(--text-color); 
            transition: background-color 0.3s ease, color 0.3s ease; 
        }

        .container { 
            max-width: 750px; 
            margin: 0 auto; 
            padding: 25px; 
            background-color: var(--container-bg); 
            border-radius: 12px; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.1); 
            border: 1px solid var(--border-color); 
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* --- Header --- */
        .app-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 25px; 
            background-color: var(--container-bg); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            position: fixed; 
            top: 0; left: 0; right: 0; 
            z-index: 1000; 
            border-bottom: 1px solid var(--border-color); 
            transition: background-color 0.3s, border-color 0.3s, color 0.3s; 
        }
        .app-header h1 { font-size: 1.4em; margin: 0; color: var(--primary-color); }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .language-switcher button { background: none; border: none; padding: 5px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
        .language-switcher button:hover { opacity: 1; }
        .language-switcher img { width: 24px; height: 16px; border-radius: 3px; vertical-align: middle; }
        #darkModeToggle { background: none; border: none; color: var(--text-color); font-size: 1.5rem; line-height: 1; cursor: pointer; padding: 8px; }

        h2 { text-align: center; margin-bottom: 25px; }
        
        /* --- Form --- */
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .input-group, .checkbox-group { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--input-bg); }
        .input-with-button { display: flex; align-items: center; gap: 10px; }
        .input-with-button input { flex-grow: 1; }
        .input-with-button button { flex-shrink: 0; padding: 8px 12px; font-size: 0.9em; }

        .checkbox-group label { display: flex; align-items: center; cursor: pointer; font-weight: normal; height: 100%;}
        input[type="checkbox"] { width: 1.3em; height: 1.3em; margin-right: 12px; accent-color: var(--primary-color); }
        label { display: block; margin-bottom: 6px; font-weight: bold; }
        input[type="number"] { width: 100%; padding: 10px; font-size: 16px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--container-bg); color: var(--text-color); transition: border-color 0.2s, background-color 0.3s, color 0.3s; }
        input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 25%, transparent); }
        button.primary, button.secondary { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; transition: background-color 0.3s ease; font-weight: bold; }
        button.primary { background-color: var(--primary-color); color: white; width: 100%; margin-top: 25px; font-size: 1.1em;}
        button.secondary { background: none; border: 1px solid var(--primary-color); color: var(--primary-color); }
        button.primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        button.primary:disabled { background-color: #a0a0a0; cursor: wait; }

        /* --- Results --- */
        #results-area { display: none; margin-top: 30px; }
        .triage-card { padding: 20px; border-radius: 12px; border-left: 8px solid; text-align: center; }
        .triage-card .icon { font-size: 2.5rem; margin-bottom: 10px; }
        .triage-card h3 { margin: 0 0 10px 0; font-size: 1.5em; }
        .triage-card p { margin: 0; font-size: 1.1em; }

        .triage-card.lvo { background-color: var(--lvo-bg); color: var(--lvo-text); border-left-color: var(--lvo-border); }
        .triage-card.ich { background-color: var(--ich-bg); color: var(--ich-text); border-left-color: var(--ich-border); }
        .triage-card.unclear { background-color: var(--unclear-bg); color: var(--unclear-text); border-left-color: var(--unclear-border); }
        .triage-card.mimic { background-color: var(--mimic-bg); color: var(--mimic-text); border-left-color: var(--mimic-border); }

        /* --- Analysis Details --- */
        #analysis-toggle { background: none; border: 1px solid var(--primary-color); color: var(--primary-color); border-radius: 8px; padding: 8px 16px; cursor: pointer; margin-top: 20px; transition: background-color 0.2s, color 0.2s; }
        #analysis-toggle:hover { background-color: var(--primary-color); color: white; }
        #analysis-details { max-height: 0; overflow: hidden; transition: max-height 0.7s ease-in-out, margin-top 0.7s ease-in-out; }
        #analysis-details.expanded { max-height: 2000px; /* Large enough to not clip content */ margin-top: 25px; }
        
        .probabilities { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 25px; }
        .prob-panel { flex: 1; min-width: 250px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; }
        .prob-panel h4 { margin: 0 0 15px 0; text-align: center; }
        .probability-meter-container { width: 100%; height: 20px; background: linear-gradient(to right, var(--meter-green) 25%, var(--meter-yellow) 50%, var(--meter-red) 100%); border-radius: 10px; position: relative; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
        .probability-meter-marker { position: absolute; top: -3px; bottom: -3px; width: 6px; background-color: var(--text-color); border: 2px solid var(--container-bg); border-radius: 3px; box-shadow: 0 0 5px rgba(0,0,0,0.5); transition: left 0.5s ease-out; }
        .probability-meter-label { position: absolute; top: 100%; transform: translateX(-50%); font-size: 1em; font-weight: bold; padding-top: 5px; }

        .drivers-title { text-align: center; margin: 30px 0 15px; font-size: 1.3em; }
        .drivers-container { display: flex; gap: 25px; flex-wrap: wrap; }
        .drivers-panel { flex: 1; min-width: 300px; }
        .drivers-panel h4 { text-align: center; margin-bottom: 15px; }
        .drivers-columns { display: flex; gap: 15px; }
        .driver-column { flex: 1; min-width: 0; }
        .driver-column h5 { margin: 0 0 10px 0; text-align: center; font-size: 0.9em; opacity: 0.8; }
        .driver-item { display: flex; align-items: center; margin-bottom: 8px; gap: 8px; }
        .driver-label { flex-shrink: 0; width: 45%; text-align: right; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; }
        .driver-bar-container { flex-grow: 1; height: 16px; background-color: color-mix(in srgb, var(--border-color) 50%, transparent); border-radius: 5px; overflow: hidden; }
        .driver-bar { height: 100%; border-radius: 5px; transition: width 0.5s ease-out; width: 0; }
        .driver-bar.positive { background-color: var(--driver-positive-bg); }
        .driver-bar.negative { background-color: var(--driver-negative-bg); }

        .error-message { color: var(--ich-text); background-color: var(--ich-bg); padding: 12px; border: 1px solid var(--ich-border); border-radius: 6px; display: none; margin-top: 20px; }

        /* --- Modal Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px 0; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal { display: flex; flex-direction: column; background: var(--container-bg); padding: 25px; border-radius: 12px; max-width: 500px; width: 95%; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 100%; }
        .modal-header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .modal-body { flex-grow: 1; overflow-y: auto; padding-right: 15px; margin-right: -15px; }
        .modal-body .input-group { margin-bottom: 15px; }
        .modal-body select { width: 100%; padding: 10px; font-size: 1em; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--container-bg); color: var(--text-color); }
        .modal-footer { flex-shrink: 0; margin-top: 25px; text-align: right; }
    </style>
</head>
<body>

    <header class="app-header">
        <h1 data-translate="appTitle">Stroke Triage Assistant</h1>
        <div class="header-right">
             <div class="language-switcher">
                 <button onclick="switchLanguage('en')" aria-label="Switch to English"><img src="https://flagcdn.com/gb.svg" alt="English Flag"></button>
                 <button onclick="switchLanguage('de')" aria-label="Switch to German"><img src="https://flagcdn.com/de.svg" alt="German Flag"></button>
             </div>
            <button id="darkModeToggle" aria-label="Toggle dark mode">🌙</button>
        </div>
    </header>

    <main class="container">
        <h2 data-translate="formTitle">Patient Data Entry</h2>
        <form id="triage-form">
            <div class="input-grid">
                <!-- Inputs for both models -->
                <div class="input-group"><label for="gfap_value" data-translate="gfapLabel">GFAP Value (pg/mL)</label><input type="number" id="gfap_value" required></div>
                <div class="input-group"><label for="age_years" data-translate="ageLabel">Age (years)</label><input type="number" id="age_years" required></div>
                <div class="input-group"><label for="systolic_bp" data-translate="sbpLabel">Systolic BP</label><input type="number" id="systolic_bp" required></div>
                <div class="input-group"><label for="diastolic_bp" data-translate="dbpLabel">Diastolic BP</label><input type="number" id="diastolic_bp" required></div>
                
                <div class="input-group">
                    <label for="fast_ed_score" data-translate="fastEdLabel">FAST-ED Score</label>
                    <div class="input-with-button">
                        <input type="number" id="fast_ed_score" min="0" max="9" required>
                        <button type="button" class="secondary" id="open-fast-ed-modal-btn" data-translate="calculateBtn">Calc</button>
                    </div>
                </div>
                
                <div class="checkbox-group"><label><input type="checkbox" id="headache"><span data-translate="headacheLabel">Headache</span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="eye_deviation"><span data-translate="eyeDeviationLabel">Eye Deviation</span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="armparese"><span data-translate="armpareseLabel">Arm Paresis</span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="beinparese"><span data-translate="beinpareseLabel">Leg Paresis</span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="atrial_fibrillation"><span data-translate="afibLabel">Atrial Fibrillation</span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="antiplatelets"><span data-translate="antiplateletsLabel">On Antiplatelets</span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="vigilanzminderung"><span data-translate="vigilanceLabel">Vigilance Reduction</span></label></div>
                <div class="checkbox-group"><label><input type="checkbox" id="antcoagulated_noak"><span data-translate="noakLabel">On NOAK</span></label></div>
            </div>
            <button type="submit" id="calculate-btn" class="primary" data-translate="calculateButton">Analyze Stroke Probability</button>
        </form>
        
        <p id="error-message" class="error-message"></p>

        <div id="results-area">
            <div id="triage-recommendation"></div>
            <div style="text-align: center;">
                <button id="analysis-toggle" data-translate="analysisToggle">View Detailed Analysis</button>
            </div>
            <div id="analysis-details">
                <div class="probabilities">
                    <div class="prob-panel" id="ich-prob-panel"></div>
                    <div class="prob-panel" id="lvo-prob-panel"></div>
                </div>
                <h3 class="drivers-title" data-translate="driversTitle">Prediction Drivers</h3>
                <div class="drivers-container">
                    <div class="drivers-panel" id="ich-drivers-panel"></div>
                    <div class="drivers-panel" id="lvo-drivers-panel"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- FAST-ED Calculator Modal -->
    <div class="modal-overlay" id="fast-ed-modal-overlay">
        <div class="modal" id="fast-ed-modal">
            <div class="modal-header">
                <h3 data-translate="fastEdModalTitle">FAST-ED Calculator</h3>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="fast-ed-face" data-translate="fastEdFace">Facial Palsy</label>
                    <select id="fast-ed-face">
                        <option value="0" data-translate="fastEdFace0">Normal symmetry</option>
                        <option value="1" data-translate="fastEdFace1">Minor paralysis</option>
                        <option value="2" data-translate="fastEdFace2">Complete paralysis</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="fast-ed-arm" data-translate="fastEdArm">Arm Weakness</label>
                    <select id="fast-ed-arm">
                        <option value="0" data-translate="fastEdArm0">No drift</option>
                        <option value="1" data-translate="fastEdArm1">Drifts down</option>
                        <option value="2" data-translate="fastEdArm2">Falls rapidly</option>
                    </select>
                </div>
                 <div class="input-group">
                    <label for="fast-ed-speech" data-translate="fastEdSpeech">Speech Changes</label>
                    <select id="fast-ed-speech">
                        <option value="0" data-translate="fastEdSpeech0">Normal</option>
                        <option value="1" data-translate="fastEdSpeech1">Mild-moderate dysarthria/aphasia</option>
                        <option value="2" data-translate="fastEdSpeech2">Severe aphasia / mute</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="fast-ed-eyes" data-translate="fastEdEyes">Eye Deviation</label>
                     <select id="fast-ed-eyes">
                        <option value="0" data-translate="fastEdEyes0">Absent</option>
                        <option value="1" data-translate="fastEdEyes1">Present</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="fast-ed-denial" data-translate="fastEdDenial">Denial / Neglect (Anosognosia)</label>
                    <select id="fast-ed-denial">
                        <option value="0" data-translate="fastEdDenial0">Absent</option>
                        <option value="1" data-translate="fastEdDenial1">Present</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="primary" id="apply-fast-ed-score-btn" data-translate="applyScore">Apply Score</button>
            </div>
        </div>
    </div>


    <script>
        // --- CONFIG & MODEL PARAMS ---
        const CONFIG = {
            api: {
                lvoPrediction: 'https://lvo-ppv-service-564499947017.europe-west3.run.app/predict',
                lvoExplanation: 'https://lvo-ppv-service-564499947017.europe-west3.run.app/explain'
            },
            ichModel: {
                INTERCEPT: -0.72549447,
                COEFFICIENTS: {'gfap_value': 0.98845868, 'age_years': -0.20927375, 'systolic_bp': 0.36337294, 'headache': 0.43796113, 'eye_deviation': -0.26763354, 'armparese': 0.11730522, 'beinparese': 0.42467409, 'atrial_fibrillation': -0.24686695, 'antiplatelets': -0.52928134 },
                SCALER_PARAMS: {'gfap_value': { center: 3.78418963, scale: 0.98704051 }, 'age_years': { center: 78.0, scale: 18.0 }, 'systolic_bp': { center: 160.0, scale: 41.5 } },
                CALIBRATION: { A: 1.15, B: -0.20 }
            },
            dom: {
                form: document.getElementById('triage-form'),
                calculateBtn: document.getElementById('calculate-btn'),
                errorMsg: document.getElementById('error-message'),
                resultsArea: document.getElementById('results-area'),
                triageCardContainer: document.getElementById('triage-recommendation'),
                analysisToggleBtn: document.getElementById('analysis-toggle'),
                analysisDetails: document.getElementById('analysis-details'),
                fastEdModalOverlay: document.getElementById('fast-ed-modal-overlay'),
                openFastEdBtn: document.getElementById('open-fast-ed-modal-btn'),
                applyFastEdBtn: document.getElementById('apply-fast-ed-score-btn'),
            }
        };

        const translations = {
            en: {
                appTitle: "Stroke Triage Assistant", formTitle: "Patient Data Entry",
                gfapLabel: "GFAP Value (pg/mL)", ageLabel: "Age (years)", sbpLabel: "Systolic BP", dbpLabel: "Diastolic BP", fastEdLabel: "FAST-ED Score",
                headacheLabel: "Headache", eyeDeviationLabel: "Eye Deviation", armpareseLabel: "Arm Paresis", beinpareseLabel: "Leg Paresis",
                afibLabel: "Atrial Fibrillation", antiplateletsLabel: "On Antiplatelets", vigilanceLabel: "Vigilance Reduction", noakLabel: "On NOAK",
                calculateButton: "Analyze Stroke Probability", analysisToggle: "View Detailed Analysis", analysisToggleHide: "Hide Detailed Analysis",
                driversTitle: "Prediction Drivers", increasingRisk: "Increasing Risk", decreasingRisk: "Decreasing Risk",
                ichTitle: "ICH Details", lvoTitle: "LVO Details", calculateBtn: "Calc", applyScore: "Apply Score",
                triage: {
                    lvo_title: "LVO LIKELY", lvo_rec: "Proceed directly to the nearest LVO-capable Comprehensive Stroke Center.",
                    ich_title: "STRONG SUSPICION OF ICH", ich_rec: "Proceed to the nearest center with neurosurgical capabilities. Thrombectomy not indicated.",
                    unclear_title: "UNCLEAR STROKE TYPE", unclear_rec: "LVO cannot be ruled out. Default to LVO protocol: proceed to LVO-capable center if feasible.",
                    mimic_title: "ICH & LVO UNLIKELY", mimic_rec: "Re-evaluate for Stroke Mimics (e.g., seizure, migraine, hypoglycemia). Proceed to nearest appropriate facility.",
                    error_title: "LVO DATA UNAVAILABLE", error_rec: "Could not retrieve LVO data. ICH analysis is shown below. Proceed based on clinical judgment.",
                },
                featureNames: { 'age_years': 'Age', 'eye_deviation': 'Eye Deviation', 'armparese': 'Arm Paresis', 'beinparese': 'Leg Paresis', 'atrial_fibrillation': 'AFib History', 'systolic_bp': 'Systolic BP', 'diastolic_bp': 'Diastolic BP', 'antiplatelets': 'On Antiplatelets', 'gfap_value': 'GFAP', 'headache': 'Headache', 'fast_ed_score': 'FAST-ED', 'vigilanzminderung': 'Vigilance', 'antcoagulated_noak': 'NOAK' },
                invalidInput: "Please fill all fields with valid numbers.",
                fastEdModalTitle: "FAST-ED Calculator", fastEdFace: "Facial Palsy", fastEdFace0: "Normal", fastEdFace1: "Minor", fastEdFace2: "Major",
                fastEdArm: "Arm Weakness", fastEdArm0: "No drift", fastEdArm1: "Drifts", fastEdArm2: "Falls rapidly",
                fastEdSpeech: "Speech Changes", fastEdSpeech0: "Normal", fastEdSpeech1: "Mild-moderate", fastEdSpeech2: "Severe / Mute",
                fastEdEyes: "Eye Deviation", fastEdEyes0: "Absent", fastEdEyes1: "Present",
                fastEdDenial: "Denial / Neglect", fastEdDenial0: "Absent", fastEdDenial1: "Present",
            },
            de: {
                appTitle: "Schlaganfall-Triage-Assistent", formTitle: "Patientendateneingabe",
                gfapLabel: "GFAP-Wert (pg/mL)", ageLabel: "Alter (Jahre)", sbpLabel: "Systolischer RR", dbpLabel: "Diastolischer RR", fastEdLabel: "FAST-ED Score",
                headacheLabel: "Kopfschmerzen", eyeDeviationLabel: "Blickdeviation", armpareseLabel: "Armparese", beinpareseLabel: "Beinparese",
                afibLabel: "Vorhofflimmern", antiplateletsLabel: "Plättchenhemmer", vigilanceLabel: "Vigilanzminderung", noakLabel: "Unter NOAK",
                calculateButton: "Wahrscheinlichkeit analysieren", analysisToggle: "Detaillierte Analyse anzeigen", analysisToggleHide: "Detaillierte Analyse ausblenden",
                driversTitle: "Treiber der Vorhersage", increasingRisk: "Risikoerhöhend", decreasingRisk: "Risikomindernd",
                ichTitle: "ICB-Details", lvoTitle: "LVO-Details", calculateBtn: "Ber.", applyScore: "Anwenden",
                triage: {
                    lvo_title: "LVO Wahrscheinlich", lvo_rec: "Fahren Sie direkt zum nächsten Thrombektomie-fähigen Zentrum.",
                    ich_title: "Starker Verdacht auf ICB", ich_rec: "Fahren Sie zum nächstgelegenen Zentrum mit neurochirurgischer Abteilung. Thrombektomie nicht indiziert.",
                    unclear_title: "UNKLARER SCHLAGANFALLTYP", unclear_rec: "LVO kann nicht ausgeschlossen werden. Standardmäßig LVO-Protokoll: Fahren Sie, wenn möglich, zu einem Thrombektomie-fähigen Zentrum.",
                    mimic_title: "ICB & LVO UNWAHRSCHEINLICH", mimic_rec: "Erwägen Sie Schlaganfall-Mimics (z.B. Anfall, Migräne, Hypoglykämie). Fahren Sie zur nächstgelegenen geeigneten Einrichtung.",
                    error_title: "LVO-DATEN NICHT VERFÜGBAR", error_rec: "LVO-Daten konnten nicht abgerufen werden. ICB-Analyse unten angezeigt. Handeln Sie nach klinischem Ermessen.",
                },
                featureNames: { 'age_years': 'Alter', 'eye_deviation': 'Blickdeviation', 'armparese': 'Armparese', 'beinparese': 'Beinparese', 'atrial_fibrillation': 'Vorhofflimmern', 'systolic_bp': 'Systol. RR', 'diastolic_bp': 'Diastol. RR', 'antiplatelets': 'Plättchenhemmer', 'gfap_value': 'GFAP', 'headache': 'Kopfschmerzen', 'fast_ed_score': 'FAST-ED', 'vigilanzminderung': 'Vigilanz', 'antcoagulated_noak': 'NOAK' },
                invalidInput: "Bitte füllen Sie alle Felder mit gültigen Zahlen aus.",
                fastEdModalTitle: "FAST-ED Rechner", fastEdFace: "Fazialisparese", fastEdFace0: "Normal", fastEdFace1: "Leicht", fastEdFace2: "Schwer",
                fastEdArm: "Armschwäche", fastEdArm0: "Kein Absinken", fastEdArm1: "Sinkt ab", fastEdArm2: "Fällt schnell",
                fastEdSpeech: "Sprachstörung", fastEdSpeech0: "Normal", fastEdSpeech1: "Leicht-moderat", fastEdSpeech2: "Schwer / Mutistisch",
                fastEdEyes: "Blickdeviation", fastEdEyes0: "Fehlend", fastEdEyes1: "Vorhanden",
                fastEdDenial: "Neglect / Anosognosie", fastEdDenial0: "Fehlend", fastEdDenial1: "Vorhanden",
            }
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial language based on browser setting, then local storage
            const savedLang = localStorage.getItem('language');
            const browserLang = navigator.language.startsWith('de') ? 'de' : 'en';
            switchLanguage(savedLang || browserLang);

            // Set initial theme based on system preference, then local storage
            const savedTheme = localStorage.getItem('darkMode');
            if (savedTheme === 'enabled' || (savedTheme === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').textContent = '☀️';
            }

            // Main form listeners
            CONFIG.dom.form.addEventListener('submit', handleAnalyze);
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            CONFIG.dom.analysisToggleBtn.addEventListener('click', toggleAnalysisDetails);
            
            // Modal listeners
            CONFIG.dom.openFastEdBtn.addEventListener('click', openFastEdModal);
            CONFIG.dom.fastEdModalOverlay.addEventListener('click', (e) => { if(e.target === CONFIG.dom.fastEdModalOverlay) closeFastEdModal(); });
            document.querySelector('#fast-ed-modal .modal-close-btn').addEventListener('click', closeFastEdModal);
            CONFIG.dom.applyFastEdBtn.addEventListener('click', applyFastEdScore);
        });

        // --- CORE LOGIC ---
        async function handleAnalyze(event) {
            event.preventDefault();
            setLoading(true);
            CONFIG.dom.errorMsg.style.display = 'none';
            CONFIG.dom.resultsArea.style.display = 'none';

            const inputs = collectInputs();
            if (!inputs) {
                setLoading(false);
                return;
            }

            const [ichResult, lvoResult] = await Promise.allSettled([
                calculateIch(inputs),
                fetchLvo(inputs)
            ]);

            const ichData = ichResult.status === 'fulfilled' ? ichResult.value : null;
            const lvoData = lvoResult.status === 'fulfilled' ? lvoResult.value : null;
            
            const triageOutcome = determineTriageRecommendation(ichData, lvoData);
            
            renderTriageCard(triageOutcome);
            renderAnalysisDetails(ichData, lvoData);

            // Reset details view to collapsed
            CONFIG.dom.analysisDetails.classList.remove('expanded');
            CONFIG.dom.analysisToggleBtn.textContent = translations[window.currentLang].analysisToggle;

            CONFIG.dom.resultsArea.style.display = 'block';
            CONFIG.dom.resultsArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
            setLoading(false);
        }

        function determineTriageRecommendation(ich, lvo) {
            if (!lvo) {
                return { type: 'error', ich: ich, lvo: null };
            }
            const ichProb = ich.probability;
            const lvoProb = lvo.probability;

            if (lvoProb > 0.6 && lvoProb > ichProb * 2) return { type: 'lvo', ich, lvo };
            if (ichProb > 0.5 && ichProb > lvoProb * 2) return { type: 'ich', ich, lvo };
            if (ichProb < 0.2 && lvoProb < 0.2) return { type: 'mimic', ich, lvo };
            
            return { type: 'unclear', ich, lvo };
        }

        function calculateIch(inputs) {
            return new Promise(resolve => {
                const model = CONFIG.ichModel;
                const ichInputs = { ...inputs, gfap_value: Math.log1p(inputs.gfap_value) };
                let logOdds = model.INTERCEPT;
                const impacts = {};
                for (const [feature, coef] of Object.entries(model.COEFFICIENTS)) {
                    let value = ichInputs[feature];
                    if (model.SCALER_PARAMS[feature]) {
                        const s = model.SCALER_PARAMS[feature];
                        value = (value - s.center) / s.scale;
                    }
                    const impact = value * coef;
                    impacts[feature] = impact;
                    logOdds += impact;
                }
                const calibratedLogOdds = model.CALIBRATION.A * logOdds + model.CALIBRATION.B;
                const probability = 1 / (1 + Math.exp(-calibratedLogOdds));
                resolve({ probability, impacts });
            });
        }

        async function fetchLvo(inputs) {
            const fetchOptions = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(inputs)
            };
            const [predResponse, explResponse] = await Promise.all([
                fetch(CONFIG.api.lvoPrediction, fetchOptions),
                fetch(CONFIG.api.lvoExplanation, fetchOptions)
            ]);
            if (!predResponse.ok || !explResponse.ok) {
                throw new Error(`API Error: Prediction ${predResponse.status}, Explanation ${explResponse.status}`);
            }
            const predJson = await predResponse.json();
            const explJson = await explResponse.json();
            return {
                probability: predJson.lvo_probability,
                impacts: explJson.feature_impacts
            };
        }

        // --- UI RENDERING ---
        function renderTriageCard(outcome) {
            const t = translations[window.currentLang].triage;
            const icons = { lvo: '🧠<span style="color:var(--lvo-border)">⚡️</span>', ich: '🧠<span style="color:var(--ich-border)">🩸</span>', unclear: '🧠❓', mimic: '👩‍⚕️🩺', error: '📡⚠️' };
            const titleKey = `${outcome.type}_title`;
            const recKey = `${outcome.type}_rec`;
            CONFIG.dom.triageCardContainer.innerHTML = `<div class="triage-card ${outcome.type}"><div class="icon">${icons[outcome.type]}</div><h3>${t[titleKey]}</h3><p>${t[recKey]}</p></div>`;
        }

        function renderAnalysisDetails(ichData, lvoData) {
             // Clean up any existing animations before rendering new ones
             cleanupAnimations();
             
             document.getElementById('ich-prob-panel').innerHTML = renderProbPanel('ich', ichData);
             document.getElementById('lvo-prob-panel').innerHTML = renderProbPanel('lvo', lvoData);
             document.getElementById('ich-drivers-panel').innerHTML = renderDriversPanel('ich', ichData);
             document.getElementById('lvo-drivers-panel').innerHTML = renderDriversPanel('lvo', lvoData);
        }

        function cleanupAnimations() {
            // Clear any existing probability meter animations to prevent memory leaks
            const existingMarkers = document.querySelectorAll('.probability-meter-marker');
            existingMarkers.forEach(marker => {
                marker.style.transition = 'none';
                // Force reflow to ensure transition is removed
                marker.offsetHeight;
            });
        }

        function renderProbPanel(type, data) {
            const t = translations[window.currentLang];
            if (!data) return `<h4>${type === 'ich' ? t.ichTitle : t.lvoTitle}</h4><p>Data unavailable.</p>`;
            const prob = data.probability;
            // Ensure probability is within valid range [0, 1]
            const clampedProb = Math.min(Math.max(prob, 0), 1);
            const markerPos = clampedProb * 100;
            
            // Add data attributes for proper cleanup and animation handling
            return `<h4 data-translate="${type}Title">${type === 'ich' ? t.ichTitle : t.lvoTitle}</h4><div class="probability-meter-container"><div class="probability-meter-marker" data-type="${type}" style="left: calc(${markerPos}% - 3px); transition: left 0.5s ease-out;"></div><span class="probability-meter-label" style="left: ${markerPos}%;">${(clampedProb * 100).toFixed(0)}%</span></div>`;
        }
        
        function renderDriversPanel(type, data) {
            const t = translations[window.currentLang];
            if (!data || !data.impacts) return `<h4>${type === 'ich' ? t.ichTitle : t.lvoTitle} Drivers</h4><p>Data unavailable.</p>`;
            const sortedDrivers = Object.entries(data.impacts).filter(([, val]) => Math.abs(val) > 0.01).sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));
            const maxAbsImpact = sortedDrivers.length > 0 ? Math.abs(sortedDrivers[0][1]) : 0;
            let posHTML = '', negHTML = '';
            sortedDrivers.forEach(([key, value]) => {
                const barWidth = (maxAbsImpact > 0) ? (Math.abs(value) / maxAbsImpact) * 100 : 0;
                const label = t.featureNames[key] || key;
                const itemHTML = `<div class="driver-item"><span class="driver-label">${label}</span><div class="driver-bar-container"><div class="driver-bar ${value >= 0 ? 'positive' : 'negative'}" style="width: ${barWidth}%;"></div></div></div>`;
                if (value >= 0) posHTML += itemHTML;
                else negHTML += itemHTML;
            });
            return `<h4>${type === 'ich' ? t.ichTitle : t.lvoTitle}</h4><div class="drivers-columns"><div class="driver-column"><h5 data-translate="increasingRisk">${t.increasingRisk}</h5><div>${posHTML || '<p style="text-align:center;font-size:0.9em;opacity:0.7;">None</p>'}</div></div><div class="driver-column"><h5 data-translate="decreasingRisk">${t.decreasingRisk}</h5><div>${negHTML || '<p style="text-align:center;font-size:0.9em;opacity:0.7;">None</p>'}</div></div></div>`;
        }
        
        // --- MODAL LOGIC ---
        function openFastEdModal() { CONFIG.dom.fastEdModalOverlay.classList.add('visible'); }
        function closeFastEdModal() { CONFIG.dom.fastEdModalOverlay.classList.remove('visible'); }
        function applyFastEdScore() {
            const face = parseInt(document.getElementById('fast-ed-face').value);
            const arm = parseInt(document.getElementById('fast-ed-arm').value);
            const speech = parseInt(document.getElementById('fast-ed-speech').value);
            const eyes = parseInt(document.getElementById('fast-ed-eyes').value);
            const denial = parseInt(document.getElementById('fast-ed-denial').value);
            const totalScore = face + arm + speech + eyes + denial;
            
            // Apply total score to the main form
            document.getElementById('fast_ed_score').value = totalScore;

            // Sync main form checkboxes based on modal inputs
            document.getElementById('armparese').checked = (arm > 0);
            document.getElementById('eye_deviation').checked = (eyes > 0);

            closeFastEdModal();
        }

        // --- HELPERS & UTILS ---
        function collectInputs() {
            const data = {};
            const allIds = Object.keys(translations.en.featureNames);
            
            // Define reasonable medical value ranges
            const validationRules = {
                'gfap_value': { min: 0, max: 10000, name: 'GFAP Value' },
                'age_years': { min: 0, max: 120, name: 'Age' },
                'systolic_bp': { min: 50, max: 300, name: 'Systolic BP' },
                'diastolic_bp': { min: 30, max: 200, name: 'Diastolic BP' },
                'fast_ed_score': { min: 0, max: 9, name: 'FAST-ED Score' }
            };
            
            for (const id of allIds) {
                const el = document.getElementById(id);
                if (!el) continue;
                if (el.type === 'checkbox') {
                    data[id] = el.checked ? 1 : 0;
                } else {
                    const val = parseFloat(el.value);
                    if (isNaN(val)) {
                        CONFIG.dom.errorMsg.textContent = translations[window.currentLang].invalidInput;
                        CONFIG.dom.errorMsg.style.display = 'block';
                        return null;
                    }
                    
                    // Validate ranges for medical values
                    const rule = validationRules[id];
                    if (rule && (val < rule.min || val > rule.max)) {
                        CONFIG.dom.errorMsg.textContent = `${rule.name} must be between ${rule.min} and ${rule.max}`;
                        CONFIG.dom.errorMsg.style.display = 'block';
                        return null;
                    }
                    
                    data[id] = val;
                }
            }
            return data;
        }

        function toggleAnalysisDetails() {
            const details = CONFIG.dom.analysisDetails;
            const btn = CONFIG.dom.analysisToggleBtn;
            const t = translations[window.currentLang];
            details.classList.toggle('expanded');
            btn.textContent = details.classList.contains('expanded') ? t.analysisToggleHide : t.analysisToggle;
        }
        
        function setLoading(isLoading) {
            CONFIG.dom.calculateBtn.disabled = isLoading;
            const btnText = translations[window.currentLang].calculateButton;
            CONFIG.dom.calculateBtn.textContent = isLoading ? `${btnText}...` : btnText;
        }
        
        function switchLanguage(lang) {
            window.currentLang = lang;
            localStorage.setItem('language', lang);
            const t = translations[lang];
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                if(t[key]) el.textContent = t[key];
            });
        }
        window.switchLanguage = switchLanguage;

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            document.getElementById('darkModeToggle').textContent = isDarkMode ? '☀️' : '🌙';
        }

    </script>
</body>
</html>

